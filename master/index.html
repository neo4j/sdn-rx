<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Gerrit Meier, Michael Simons">
<title>Spring Data Neo4j⚡️RX</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Data Neo4j⚡️RX</h1>
<div class="details">
<span id="author" class="author">Gerrit Meier</span><br>
<span id="email" class="email"><a href="mailto:gerrit.meier@neo4j.com">gerrit.meier@neo4j.com</a></span><br>
<span id="author2" class="author">Michael Simons</span><br>
<span id="email2" class="email"><a href="mailto:michael.simons@neo4j.com">michael.simons@neo4j.com</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#yourwaythroughthisdocument">1.1. Your way through this document</a></li>
</ul>
</li>
<li><a href="#preface">2. Preface</a>
<ul class="sectlevel2">
<li><a href="#preface.nosql">2.1. NoSQL and Graph databases</a></li>
<li><a href="#preface.spring-data">2.2. Spring and Spring Data</a></li>
<li><a href="#what-is-sdn-rx">2.3. What is Spring Data Neo4j⚡️RX</a></li>
</ul>
</li>
<li><a href="#building-blocks">3. Building blocks</a></li>
<li><a href="#getting-started">4. Getting started</a>
<ul class="sectlevel2">
<li><a href="#preparethedatabase">4.1. Prepare the database</a></li>
<li><a href="#createanewspringbootproject">4.2. Create a new Spring Boot project</a></li>
<li><a href="#configuretheproject">4.3. Configure the project</a></li>
<li><a href="#createyourdomain">4.4. Create your domain</a></li>
</ul>
</li>
<li><a href="#mapping">5. Object Mapping</a>
<ul class="sectlevel2">
<li><a href="#mapping.annotations">5.1. Metadata-based Mapping</a></li>
<li><a href="#mapping.id-handling">5.2. Handling and provisioning of unique IDs</a></li>
<li><a href="#mapping.fundamentals">5.3. Spring Data Object Mapping Fundamentals</a></li>
</ul>
</li>
<li><a href="#repositories">6. Working with Spring Data Repositories</a>
<ul class="sectlevel2">
<li><a href="#repositories.core-concepts">6.1. Core concepts</a></li>
<li><a href="#repositories.query-methods">6.2. Query methods</a></li>
<li><a href="#repositories.definition">6.3. Defining Repository Interfaces</a></li>
<li><a href="#repositories.query-methods.details">6.4. Defining Query Methods</a></li>
<li><a href="#repositories.create-instances">6.5. Creating Repository Instances</a></li>
<li><a href="#repositories.custom-implementations">6.6. Custom Implementations for Spring Data Repositories</a></li>
<li><a href="#core.domain-events">6.7. Publishing Events from Aggregate Roots</a></li>
<li><a href="#core.extensions">6.8. Spring Data Extensions</a></li>
</ul>
</li>
<li><a href="#testing">7. Testing</a>
<ul class="sectlevel2">
<li><a href="#dataneo4jtest">7.1. <code>@DataNeo4jTest</code></a></li>
<li><a href="#reactivedataneo4jtest">7.2. <code>@ReactiveDataNeo4jTest</code></a></li>
</ul>
</li>
<li><a href="#auditing">8. Auditing</a>
<ul class="sectlevel2">
<li><a href="#auditing.basics">8.1. Basics</a></li>
</ul>
</li>
<li><a href="#faq">9. Frequently Asked Questions</a>
<ul class="sectlevel2">
<li><a href="#neo4j4.0supportsmultipledatabases-howcaniusethem">9.1. Neo4j 4.0 supports multiple databases - How can I use them?</a></li>
<li><a href="#doineedspecificconfigurationsothattransactionsworkseamlesswithaneo4jcausalcluster">9.2. Do I need specific configuration so that transactions work seamless with a Neo4j Causal Cluster?</a></li>
<li><a href="#doineedtouseneo4jspecificannotations">9.3. Do I need to use Neo4j specific annotations?</a></li>
<li><a href="#howdoiuseassignedids">9.4. How do I use assigned ids?</a></li>
<li><a href="#howdoiuseexternallygeneratedids">9.5. How do I use externally generated ids?</a></li>
<li><a href="#template-support">9.6. Do I have to create repositories for each domain class?</a></li>
<li><a href="#howdoispecifyparametersincustomqueries">9.7. How do I specify parameters in custom queries?</a></li>
<li><a href="#howdoiusespringexpressionlanguageincustomqueries">9.8. How do I use Spring Expression Language in custom queries?</a></li>
<li><a href="#howdoiauditentities">9.9. How do I audit entities?</a></li>
<li><a href="#howdoiusefindbyexample">9.10. How do I use "Find by example"?</a></li>
</ul>
</li>
<li><a href="#appendix">10. Appendix</a>
<ul class="sectlevel2">
<li><a href="#conversions">Conversions</a></li>
<li><a href="#repository-query-keywords">Repository query keywords</a></li>
<li><a href="#repository-query-return-types">Repository query return types</a></li>
<li><a href="#neo4j-client">Neo4jClient</a></li>
<li><a href="#cypher-dsl">The Cypher-DSL</a></li>
<li><a href="#query-creation">Query creation</a></li>
<li><a href="#Migrating">Migrating from SDN+OGM to SDN/RX</a></li>
<li><a href="#building-sdn-rx">Building SDN/RX</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2020 Neo4j, Inc.,</p>
</div>
<div class="paragraph">
<p>License: <a href="license.html">Creative Commons 4.0</a></p>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>This is the SDN/RX manual version 1.0.0.</p>
</div>
<div class="paragraph">
<p>It contains excerpts of the shared <a href="https://docs.spring.io/spring-data/commons/docs/current/reference/html">Spring Data Commons documentation</a>,
adapted to contain only supported features and annotation.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><em>Who should read this?</em></p>
</div>
<div class="paragraph">
<p>This manual is written for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the enterprise architect investigating Spring integration for Neo4j.</p>
</li>
<li>
<p>the engineer developing Spring Data based applications with Neo4j.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="yourwaythroughthisdocument"><a class="anchor" href="#yourwaythroughthisdocument"></a>1.1. Your way through this document</h3>
<div class="paragraph">
<p>If you already familiar with the core concepts of Spring Data, head straight to <a href="#getting-started">Chapter 4</a>.
This chapter will walk you through different options of configuring an application to connect to a Neo4j instance and how to model your domain.</p>
</div>
<div class="paragraph">
<p>In most cases, you will need a domain.
Go to <a href="#mapping">Chapter 5</a> to learn about how to map nodes and relationships to your domain model.</p>
</div>
<div class="paragraph">
<p>After that, you will need some means to query the domain.
Choices are  <a href="#neo4j-repositories">Neo4j repositories</a>, <a href="#neo4j-template">the Neo4j Template</a> or on a lower level, <a href="#neo4j-client">the Neo4j Client</a>.
All of them are available in a <a href="#reactive-programming">reactive fashion</a> as well.
Apart from the paging mechanism, all the features of standard repositories are available in the reactive variant.</p>
</div>
<div class="paragraph">
<p>You will find the building blocks in the next <a href="#building-blocks">chapter</a>.</p>
</div>
<div class="paragraph">
<p>To learn more about the general concepts of repositories, head over to <a href="#repositories">Chapter 6</a>.</p>
</div>
<div class="paragraph">
<p>You can of course read on, continuing with the preface and a gentle getting started guide.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preface"><a class="anchor" href="#preface"></a>2. Preface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="preface.nosql"><a class="anchor" href="#preface.nosql"></a>2.1. NoSQL and Graph databases</h3>
<div class="paragraph">
<p>A graph database is a storage engine that is specialized in storing and retrieving vast networks of information.
It efficiently stores data as nodes with relationships to other or even the same nodes,
thus allowing high-performance retrieval and querying of those structures.
Properties can be added to both nodes and relationships.
Nodes can be labelled by zero or more labels, relationships are always directed and named.</p>
</div>
<div class="paragraph">
<p>Graph databases are well suited for storing most kinds of domain models.
In almost all domains, there are certain things connected to other things.
In most other modeling approaches, the relationships between things are reduced to a single link without identity and attributes.
Graph databases allow to keep the rich relationships that originate from the domain equally well-represented in the database without resorting to also modeling the relationships as "things".
There is very little "impedance mismatch" when putting real-life domains into a graph database.</p>
</div>
<div class="sect3">
<h4 id="preface.nosql.neo4j"><a class="anchor" href="#preface.nosql.neo4j"></a>2.1.1. Introducing Neo4j</h4>
<div class="paragraph">
<p><a href="https://neo4j.com/">Neo4j</a> is an open source NoSQL graph database.
It is a fully transactional database (ACID) that stores data structured as graphs consisting of nodes, connected by relationships.
Inspired by the structure of the real world, it allows for high query performance on complex data, while remaining intuitive and simple for the developer.</p>
</div>
<div class="paragraph">
<p>The starting point for learning about Neo4j is <a href="https://neo4j.com/">neo4j.com</a>.
Here is a list of useful resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://neo4j.com/docs/">Neo4j documentation</a> introduces Neo4j and contains links to getting started guides, reference documentation and tutorials.</p>
</li>
<li>
<p>The <a href="https://neo4j.com/sandbox/">online sandbox</a> provides a convenient way to interact with a Neo4j instance in combination with the online <a href="https://neo4j.com/developer/get-started/">tutorial</a>.</p>
</li>
<li>
<p>Neo4j <a href="https://neo4j.com/developer/java/">Java Bolt Driver</a></p>
</li>
<li>
<p><a href="https://neo4j.com/docs/ogm-manual/current/">Neo4j Object Graph Mapper (OGM) Library</a></p>
</li>
<li>
<p>Several <a href="https://neo4j.com/books/">books</a> available for purchase and <a href="https://www.youtube.com/neo4j">videos</a> to watch.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preface.spring-data"><a class="anchor" href="#preface.spring-data"></a>2.2. Spring and Spring Data</h3>
<div class="paragraph">
<p>Spring Data uses Spring Framework&#8217;s <a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/core.html">core</a> functionality,
such as the <a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/core.html#beans">IoC</a> container,
<a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/core.html#core-convert">type conversion system</a>,
<a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/core.html#expressions">expression language</a>,
<a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/integration.html#jmx">JMX integration</a>,
and portable <a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/data-access.html#dao-exceptions">DAO exception hierarchy</a>.
While it is not necessary to know all the Spring APIs, understanding the concepts behind them is.
At a minimum, the idea behind IoC should be familiar.</p>
</div>
<div class="paragraph">
<p>The Spring Data Neo4j project applies Spring Data concepts to the development of solutions using the Neo4j graph data store.
We provide <em>repositories</em> as a high-level abstraction for storing and querying documents as well as templates and clients for generic domain access or generic query execution.
All of them are integrated with Spring&#8217;s application transactions.</p>
</div>
<div class="paragraph">
<p>The core functionality of the Neo4j support can be used directly, through either the <code>Neo4jClient</code> or the <code>Neo4jTemplate</code> or the reactive variants thereof.
All of them provide integration with Spring&#8217;s application level transactions.
On a lower level, you can grab the Bolt driver instance, but than you have to manage your own transactions.</p>
</div>
<div class="paragraph">
<p>To learn more about Spring, you can refer to the comprehensive documentation that explains in detail the Spring Framework.
There are a lot of articles, blog entries and books on the matter - take a look at the Spring Framework <a href="https://spring.io/docs">home page </a> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="what-is-sdn-rx"><a class="anchor" href="#what-is-sdn-rx"></a>2.3. What is Spring Data Neo4j⚡️RX</h3>
<div class="paragraph">
<p>Spring Data Neo4j⚡RX is the successor to Spring Data Neo4j + Neo4j-OGM.
The separate layer of Neo4j-OGM (Neo4j Object Graph Mapper) has been replaced by Spring infrastructure, but the basic concepts of an Object Graph Mapper (OGM) still apply:</p>
</div>
<div class="paragraph">
<p>An OGM maps nodes and relationships in the graph to objects and references in a domain model.
Object instances are mapped to nodes while object references are mapped using relationships, or serialized to properties (e.g. references to a Date).
JVM primitives are mapped to node or relationship properties.
An OGM abstracts the database and provides a convenient way to persist your domain model in the graph and query it without having to use low level drivers directly.
It also provides the flexibility to the developer to supply custom queries where the queries generated by SDN/RX are insufficient.</p>
</div>
<div class="sect3">
<h4 id="whatsinthebox"><a class="anchor" href="#whatsinthebox"></a>2.3.1. What&#8217;s in the box?</h4>
<div class="paragraph">
<p>Spring Data Neo4j⚡RX or in short SDN/RX is a next-generation <a href="https://spring.io/projects/spring-data">Spring Data</a> module,
created and maintained by <a href="https://neo4j.com">Neo4j, Inc.</a> in close collaboration with <a href="https://pivotal.io">Pivotal&#8217;s</a> Spring Data Team.</p>
</div>
<div class="paragraph">
<p>SDN/RX relies completely on the <a href="https://github.com/neo4j/neo4j-java-driver">Neo4j Java Driver</a>,
without introducing another "driver" or "transport" layer between the mapping framework and the driver.
The Neo4j Java Driver - sometimes dubbed Bolt or the Bolt driver - is used as a protocol much like JDBC is with relational databases.</p>
</div>
<div class="paragraph">
<p>Noteworthy features that differentiate SDN/RX from Spring Data Neo4j + OGM are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Full support for immutable entities and thus full support for Kotlin&#8217;s data classes</p>
</li>
<li>
<p>Full support for the reactive programming model in the Spring Framework itself and Spring Data</p>
</li>
<li>
<p>Brand new Neo4j client and reactive client feature, resurrecting the idea of a template over the plain driver, easing database access</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>SDN/RX is currently developed with <a href="https://github.com/spring-projects/spring-data-neo4j">Spring Data Neo4j</a> in parallel and will replace it eventually when they are on feature parity in regards of repository support and mapping.</p>
</div>
</div>
<div class="sect3">
<h4 id="whyshouldiusesdnrxinfavorofsdnogm"><a class="anchor" href="#whyshouldiusesdnrxinfavorofsdnogm"></a>2.3.2. Why should I use SDN/RX in favor of SDN+OGM</h4>
<div class="paragraph">
<p>SDN/RX has several features not present in SDN+OGM, notably</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Full support for Springs reactive story, including reactive transaction</p>
</li>
<li>
<p>Full support for <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#query-by-example">Query By Example</a></p>
</li>
<li>
<p>Full support for fully immutable entities</p>
</li>
<li>
<p>Support for all modifiers and variations of derived finder methods, including spatial queries</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="doineedbothsdnrxandspringdataneo4j"><a class="anchor" href="#doineedbothsdnrxandspringdataneo4j"></a>2.3.3. Do I need both SDN/RX and Spring Data Neo4j?</h4>
<div class="paragraph">
<p>No.</p>
</div>
<div class="paragraph">
<p>They are mutually exclusive and you cannot mix them in one project.</p>
</div>
</div>
<div class="sect3">
<h4 id="howdoessdnrxrelatetoneo4j-ogm"><a class="anchor" href="#howdoessdnrxrelatetoneo4j-ogm"></a>2.3.4. How does SDN/RX relate to Neo4j-OGM?</h4>
<div class="paragraph">
<p><a href="https://neo4j.com/docs/ogm-manual/current/">Neo4j-OGM</a> is an Object Graph Mapping library, which is mainly used by Spring Data Neo4j as its backend for the heavy lifting of mapping nodes and relationships into domain object.
SDN/RX <strong>does not need</strong> and <strong>does not support</strong> Neo4j-OGM.
SDN/RX uses Spring Data&#8217;s mapping context exclusively for scanning classes and building the meta model.</p>
</div>
<div class="paragraph">
<p>While this pins SDN/RX to the Spring eco systems, it has several advantages, among them the smaller footprint in regards of CPU and memory usage and especially, all the features of Springs mapping context.</p>
</div>
</div>
<div class="sect3">
<h4 id="doessdnrxsupportconnectionsoverhttptoneo4j"><a class="anchor" href="#doessdnrxsupportconnectionsoverhttptoneo4j"></a>2.3.5. Does SDN/RX support connections over HTTP to Neo4j?</h4>
<div class="paragraph">
<p>No.</p>
</div>
</div>
<div class="sect3">
<h4 id="doessdnrxsupportembeddedneo4j"><a class="anchor" href="#doessdnrxsupportembeddedneo4j"></a>2.3.6. Does SDN/RX support embedded Neo4j?</h4>
<div class="paragraph">
<p>Embedded Neo4j has multiple facets to it:</p>
</div>
<div class="sect4">
<h5 id="doessdnrxprovideanembeddedinstanceforyourapplication"><a class="anchor" href="#doessdnrxprovideanembeddedinstanceforyourapplication"></a>Does SDN/RX provide an embedded instance for your application?</h5>
<div class="paragraph">
<p>No.</p>
</div>
</div>
<div class="sect4">
<h5 id="doessdnrxinteractdirectlywithanembeddedinstance"><a class="anchor" href="#doessdnrxinteractdirectlywithanembeddedinstance"></a>Does SDN/RX interact directly with an embedded instance?</h5>
<div class="paragraph">
<p>No.
An embedded database is usually represented by an instance of <code>org.neo4j.graphdb.GraphDatabaseService</code> and has no Bolt connector out of the box.</p>
</div>
<div class="paragraph">
<p>SDN/RX can however work very much with Neo4j&#8217;s test harness, the test harness is specially meant to be a drop-in replacement for the real database.
Support for both Neo4j 3.5 and 4.0 test harness is implemented via <a href="https://github.com/neo4j/neo4j-java-driver-spring-boot-starter">the Spring Boot starter for the driver</a>.
Have a look at the corresponding module <code>org.neo4j.driver:neo4j-java-driver-test-harness-spring-boot-autoconfigure</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="caniusesdnrxwithoutspringboot"><a class="anchor" href="#caniusesdnrxwithoutspringboot"></a>Can I use SDN/RX without Spring Boot?</h5>
<div class="paragraph">
<p>Yes, see our <code>README</code>.
We provide <code>org.neo4j.springframework.data.config.AbstractNeo4jConfig</code> and <code>org.neo4j.springframework.data.config.AbstractReactiveNeo4jConfig</code> for that purpose.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-blocks"><a class="anchor" href="#building-blocks"></a>3. Building blocks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SDN/RX consists of compossible building blocks.
It builds on top of the <a href="https://github.com/neo4j/neo4j-java-driver">Neo4j Java Driver</a>.
The instance of the Java driver is provided by our <a href="https://github.com/neo4j/neo4j-java-driver-spring-boot-starter">starter</a>.
All configuration options of the driver can be configured through the starter in the namespace <code>org.neo4j.driver</code>.
The driver bean provides imperative, asynchronous and reactive methods to interact with Neo4j.</p>
</div>
<div class="paragraph">
<p>You can use all transaction methods the driver provides on that bean
such as <a href="https://neo4j.com/docs/driver-manual/4.0/terminology/#term-auto-commit">auto-commit transactions</a>,
<a href="https://neo4j.com/docs/driver-manual/4.0/terminology/#term-auto-commit">transaction functions</a> and unmanaged transactions.
Be aware that those transactions are not tight to an ongoing Spring transaction.</p>
</div>
<div class="paragraph">
<p>Integration with Spring Data and Spring&#8217;s platform or reactive transaction manager starts at the <a href="#neo4j-client">Neo4j Client</a>.
The client is part of SDN/RX and SDN/RX is configured through a separate starter, <code>spring-data-neo4j-rx-spring-boot-starter</code>.
The configuration namespace of that starter is <code>org.neo4j.data</code>.</p>
</div>
<div class="paragraph">
<p>The client is mapping agnostic.
It doesn&#8217;t know about your domain classes and you are responsible for mapping a result to an object suiting your needs.</p>
</div>
<div class="paragraph">
<p>The next higher level of abstraction is the Neo4j Template.
It is aware of your domain and you can use it to query arbitrary domain objects.
The template comes in handy in scenarios with a large number of domain classes or custom queries for which you don&#8217;t want
to create an additional repository abstraction each.</p>
</div>
<div class="paragraph">
<p>The highest level of abstraction is a Spring Data repository.</p>
</div>
<div class="paragraph">
<p>All abstractions of SDN/RX come in both imperative and reactive fashions.
It is not recommend to mix both programming styles in the same application.
The reactive infrastructure requires a Neo4j 4.0+ database.</p>
</div>
<div id="sdn-rx-building-blocks" class="imageblock">
<div class="content">
<img src="img/sdn-rx-buildingblocks.png" alt="sdn rx buildingblocks" width="1240" height="518">
</div>
<div class="title">Figure 1. SDN/RX building blocks</div>
</div>
<div class="paragraph">
<p>The template mechanism is similar to the templates of others stores.
Find some more information about it in <a href="#template-support">our FAQ</a>.
The Neo4j Client as such is unique to SDN/RX.
You will find it&#8217;s documentation in the <a href="#neo4j-client">appendix</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>4. Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We provide a Spring Boot starter for SDN/RX.
Please include the starter module via your dependency management and configure the bolt URL to use, for example <code>org.neo4j.driver.uri=bolt://localhost:7687</code>.
The starter assumes that the server has disabled authentication.
As the SDN/RX starter depends on the starter for the Java Driver, all things regarding configuration said there, apply here as well.
For a reference of the available properties, use your IDEs autocompletion in the <code>org.neo4j.driver</code> namespace
or look at the <a href="https://github.com/neo4j/neo4j-java-driver-spring-boot-starter/blob/master/docs/manual.adoc">dedicated manual</a>.</p>
</div>
<div class="paragraph">
<p>SDN/RX supports</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The well known and understood imperative programming model (much like Spring Data JDBC or JPA)</p>
</li>
<li>
<p>Reactive programming based on <a href="http://www.reactive-streams.org">Reactive Streams</a>, including full support for <a href="https://spring.io/blog/2019/05/16/reactive-transactions-with-spring">reactive transactions</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those are all included in the same binary.
The reactive programming model requires a 4.0 Neo4j server on the database side and reactive Spring on the other hand.
Have a look at the <a href="https://github.com/neo4j/sdn-rx/tree/master/examples">examples directory</a> for all examples.</p>
</div>
<div class="sect2">
<h3 id="preparethedatabase"><a class="anchor" href="#preparethedatabase"></a>4.1. Prepare the database</h3>
<div class="paragraph">
<p>For this example, we stay within the <a href="https://neo4j.com/developer/movie-database/">movie graph</a>,
as it comes for free with every Neo4j instance.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t have a running database but Docker installed, please run:</p>
</div>
<div id="start-docker-neo4j" class="listingblock">
<div class="title">Listing 1. Start a local Neo4j instance inside Docker.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">docker run --publish=7474:7474 --publish=7687:7687 -e 'NEO4J_AUTH=neo4j/secret' neo4j:4.0.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>You know can access <a href="http://localhost:7474/browser/?cmd=play&amp;arg=movies">http://localhost:7474</a>.
The above command sets the password of the server to <code>secret</code>.
Note the command ready to run in the prompt (<code>:play movies</code>).
Execute it to fill your database with some test data.</p>
</div>
</div>
<div class="sect2">
<h3 id="createanewspringbootproject"><a class="anchor" href="#createanewspringbootproject"></a>4.2. Create a new Spring Boot project</h3>
<div class="paragraph">
<p>The easiest way to setup a Spring Boot project is <a href="https://start.spring.io">start.spring.io</a>
 (which is integrated in the major IDEs as well, in case you don&#8217;t want to use the website).</p>
</div>
<div class="paragraph">
<p>Select the "Spring Web Starter" to get all the dependencies needed for creating a Spring based web application.
The Spring Initializr will take care of creating a valid project structure for you,
with all the files and settings in place for the selected build tool.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Don&#8217;t choose Spring Data Neo4j here, as it will get you the previous generation of Spring Data Neo4j including OGM and additional abstraction over the driver.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You might want to follow <a href="https://start.spring.io/#!type=maven-project&amp;language=java&amp;platformVersion=2.2.4.RELEASE&amp;packaging=jar&amp;jvmVersion=1.8&amp;groupId=com.example&amp;artifactId=demo&amp;name=Neo4j%20Spring%20Boot%20Example&amp;description=Demo%20project%20for%20Spring%20Boot&amp;packageName=com.example.demo&amp;dependencies=webflux,actuator">this link for a preconfigured setup</a>.</p>
</div>
<div class="sect3">
<h4 id="usingmaven"><a class="anchor" href="#usingmaven"></a>4.2.1. Using Maven</h4>
<div class="paragraph">
<p>You can issue a <em>curl</em> request against the Spring Initializer to create a basic Maven project:</p>
</div>
<div id="generate-maven-project" class="listingblock">
<div class="title">Listing 2. Create a basic Maven project with the Spring Initializr</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl https://start.spring.io/starter.tgz \
  -d dependencies=webflux,actuator \
  -d bootVersion=2.2.6.RELEASE \
  -d baseDir=Neo4jSpringBootExample \
  -d name=Neo4j%20SpringBoot%20Example | tar -xzvf -</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a new folder <code>Neo4jSpringBootExample</code>.
As this starter is not yet on the initializer, you will have to add the following dependency manually to your <code>pom.xml</code>:</p>
</div>
<div id="dependencies-maven" class="listingblock">
<div class="title">Listing 3. Inclusion of the spring-data-neo4j-rx-spring-boot-starter in a Maven project</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.neo4j.springframework.data<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-data-neo4j-rx-spring-boot-starter<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>1.0.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You would also add the dependency manually in case of an existing project.</p>
</div>
</div>
<div class="sect3">
<h4 id="usinggradle"><a class="anchor" href="#usinggradle"></a>4.2.2. Using Gradle</h4>
<div class="paragraph">
<p>The idea is the same, just generate a Gradle project:</p>
</div>
<div id="generate-gradle-project" class="listingblock">
<div class="title">Listing 4. Create a basic Gradle project with the Spring Initializr</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl https://start.spring.io/starter.tgz \
  -d dependencies=webflux,actuator \
  -d type=gradle-project \
  -d bootVersion=2.2.6.RELEASE \
  -d baseDir=Neo4jSpringBootExampleGradle \
  -d name=Neo4j%20SpringBoot%20Example | tar -xzvf -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dependency for Gradle looks like this and must be added to <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="title">Listing 5. Inclusion of the spring-data-neo4j-rx-spring-boot-starter in a Gradle project</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation <span class="string"><span class="delimiter">'</span><span class="content">org.neo4j.springframework.data:spring-data-neo4j-rx-spring-boot-starter:1.0.0</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You would also add the dependency manually in case of an existing project.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuretheproject"><a class="anchor" href="#configuretheproject"></a>4.3. Configure the project</h3>
<div class="paragraph">
<p>Now open any of those projects in your favorite IDE.
Find <code>application.properties</code> and configure your Neo4j credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">org.neo4j.driver.uri=bolt://localhost:7687
org.neo4j.driver.authentication.username=neo4j
org.neo4j.driver.authentication.password=secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the bare minimum of what you need to connect to a Neo4j instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is not necessary to add any programmatically configuration of the driver when you use this starter.
      SDN/RX repositories will be automatically enabled by this starter.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="createyourdomain"><a class="anchor" href="#createyourdomain"></a>4.4. Create your domain</h3>
<div class="paragraph">
<p>Our domain layer should accomplish two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Map your graph to objects</p>
</li>
<li>
<p>Provide access to those</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="examplenode-entity"><a class="anchor" href="#examplenode-entity"></a>4.4.1. Example Node-Entity</h4>
<div class="paragraph">
<p>SDN/RX fully supports unmodifiable entities, for both Java and <code>data</code> classes in Kotlin.
Therefor we will focus on immutable entities here, <a href="#movie-entity">Listing 6</a> shows a such an entity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
SDN/RX supports all data types the Neo4j Java Driver supports,
      see <a href="https://neo4j.com/docs/driver-manual/current/cypher-values/#driver-neo4j-type-system">Map Neo4j types to native language types</a> inside the chapter "The Cypher type system".
      Future versions will support additional converters.
</td>
</tr>
</table>
</div>
<div id="movie-entity" class="listingblock">
<div class="title">Listing 6. MovieEntity.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">static</span> <span class="include">org.neo4j.springframework.data.core.schema.Relationship.Direction</span>.*;

<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.HashMap</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Id</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Node</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Property</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Relationship</span>;

<span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> title;

        <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">tagline</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> description;

        <span class="annotation">@Relationship</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>, direction = INCOMING) <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;PersonEntity, Roles&gt; actorsAndRoles = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

        <span class="annotation">@Relationship</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">DIRECTED</span><span class="delimiter">&quot;</span></span>, direction = INCOMING)
        <span class="directive">private</span> <span class="predefined-type">List</span>&lt;PersonEntity&gt; directors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="directive">public</span> MovieEntity(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> description) { <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="local-variable">this</span>.title = title;
                <span class="local-variable">this</span>.description = description;
        }

        <span class="comment">// Getters omitted for brevity</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Node</code> is used to mark this class as a managed entity.
It also is used to configure the Neo4j label.
The label defaults to the name of the class, if you&#8217;re just using plain <code>@Node</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each entity has to have an id.
The movie class shown here uses the attribute <code>title</code> as a unique business key.
If you don&#8217;t have such a unique key, you can use the combination of <code>@Id</code> and <code>@GeneratedValue</code>
to configure SDN/RX to use Neo4j&#8217;s internal id.
We also provide generators for UUIDs.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This shows <code>@Property</code> as a way to use a different name for the field than for the graph property.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This defines a relationship to a class of type <code>PersonEntity</code> and the relationship type <code>ACTED_IN</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is the constructor to be used by your application code.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As a general remark: Immutable entities using internally generated ids are a bit contradictory,
as SDN/RX needs a way to set the field with the value generated by the database.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t find a good business key or don&#8217;t want to use a generator for IDs, here&#8217;s the same entity using
the internally generated id together with a businesses constructor and a so called <em>wither</em>-Method, that is used by SDN/RX:</p>
</div>
<div id="movie-entity-with-wither" class="listingblock">
<div class="title">Listing 7. MovieEntity.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.GeneratedValue</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Id</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Node</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Property</span>;

<span class="keyword">import</span> <span class="include">org.springframework.data.annotation.PersistenceConstructor</span>;

<span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span>
        <span class="directive">private</span> <span class="predefined-type">Long</span> id;

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> title;

        <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">tagline</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> description;

        <span class="directive">public</span> MovieEntity(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> description) { <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="local-variable">this</span>.id = <span class="predefined-constant">null</span>;
                <span class="local-variable">this</span>.title = title;
                <span class="local-variable">this</span>.description = description;
        }

        <span class="directive">public</span> MovieEntity withId(<span class="predefined-type">Long</span> id) { <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="keyword">if</span> (<span class="local-variable">this</span>.id.equals(id)) {
                        <span class="keyword">return</span> <span class="local-variable">this</span>;
                } <span class="keyword">else</span> {
                        MovieEntity newObject = <span class="keyword">new</span> MovieEntity(<span class="local-variable">this</span>.title, <span class="local-variable">this</span>.description);
                        newObject.id = id;
                        <span class="keyword">return</span> newObject;
                }
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the constructor to be used by your application code.
It sets the id to null, as the field containing the internal id should never be manipulated.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is a so-called <em>wither</em> for the <code>id</code>-attribute.
It creates a new entity and sets the field accordingly,
without modifying the original entity, thus making it immutable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can of course use SDN/RX with <a href="https://kotlinlang.org/">Kotlin</a> and model your domain with Kotlin&#8217;s data classes.
<a href="https://projectlombok.org/">Project Lombok</a> is an alternative if you want or need to stay purely within Java.</p>
</div>
</div>
<div class="sect3">
<h4 id="declaringspringdatarepositories"><a class="anchor" href="#declaringspringdatarepositories"></a>4.4.2. Declaring Spring Data repositories</h4>
<div class="paragraph">
<p>You basically have two options here:
You can work store agnostic with SDN/RX and make your domain specific extends one of</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.data.repository.Repository</code></p>
</li>
<li>
<p><code>org.springframework.data.repository.CrudRepository</code></p>
</li>
<li>
<p><code>org.springframework.data.repository.reactive.ReactiveCrudRepository</code></p>
</li>
<li>
<p><code>org.springframework.data.repository.reactive.ReactiveSortingRepository</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Choose imperative and reactive accordingly.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
While technically not prohibited, it is not recommended to mix imperative and reactive database access
         in the same application.
         We won&#8217;t support you with scenarios like this.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other option is to settle on a store specific implementation and gain all the methods we support out of the box.
The advantage of this approach is also it&#8217;s biggest disadvantage: Once out, all those methods will be part of your API.
Most of the time it&#8217;s harder to take something away, than to add stuff afterwards.
Furthermore, using store specifics leaks your store into your domain.
From a performance point of view, there is no penalty.</p>
</div>
<div class="paragraph">
<p>A repository fitting to any of the movie entities above looks like this:</p>
</div>
<div id="movie-repository" class="listingblock">
<div class="title">Listing 8. MovieRepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.repository.ReactiveNeo4jRepository</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">MovieRepository</span> <span class="directive">extends</span> ReactiveNeo4jRepository&lt;MovieEntity, <span class="predefined-type">String</span>&gt; {

        Mono&lt;MovieEntity&gt; findOneByTitle(<span class="predefined-type">String</span> title);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This repository can be used in any Spring component like this:</p>
</div>
<div id="movie-controller" class="listingblock">
<div class="title">Listing 9. MovieController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">reactor.core.publisher.Flux</span>;
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.MovieEntity</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.MovieRepository</span>;
<span class="keyword">import</span> <span class="include">org.springframework.http.MediaType</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.DeleteMapping</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.GetMapping</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.PathVariable</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.PutMapping</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RequestBody</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RequestMapping</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RequestParam</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RestController</span>;

<span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/movies</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieController</span> {

        <span class="directive">private</span> <span class="directive">final</span> MovieRepository movieRepository;

        <span class="directive">public</span> MovieController(MovieRepository movieRepository) {
                <span class="local-variable">this</span>.movieRepository = movieRepository;
        }

        <span class="annotation">@PutMapping</span>
        Mono&lt;MovieEntity&gt; createOrUpdateMovie(<span class="annotation">@RequestBody</span> MovieEntity newMovie) {
                <span class="keyword">return</span> movieRepository.save(newMovie);
        }

        <span class="annotation">@GetMapping</span>(value = { <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> }, produces = MediaType.TEXT_EVENT_STREAM_VALUE)
        Flux&lt;MovieEntity&gt; getMovies() {
                <span class="keyword">return</span> movieRepository
                        .findAll();
        }

        <span class="annotation">@GetMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/by-title</span><span class="delimiter">&quot;</span></span>)
        Mono&lt;MovieEntity&gt; byTitle(<span class="annotation">@RequestParam</span> <span class="predefined-type">String</span> title) {
                <span class="keyword">return</span> movieRepository.findOneByTitle(title);
        }

        <span class="annotation">@DeleteMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
        Mono&lt;<span class="predefined-type">Void</span>&gt; delete(<span class="annotation">@PathVariable</span> <span class="predefined-type">String</span> id) {
                <span class="keyword">return</span> movieRepository.deleteById(id);
        }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Testing reactive code is done with a <code>reactor.test.StepVerifier</code>.
     Have a look at the corresponding <a href="https://projectreactor.io/docs/core/release/reference/#testing">documentation of Project Reactor</a> or see our example code.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping"><a class="anchor" href="#mapping"></a>5. Object Mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections will explain the process of mapping between your graph and your domain.
It is split into two parts.
The first part explains the actual mapping and the available tools for you to describe how to map nodes, relationships and properties to objects.
The second part will have a look at Spring Data&#8217;s object mapping fundamentals.
It gives valuable tips on general mapping, why you should prefer immutable domain objects and how you can model them with Java or Kotlin.</p>
</div>
<div class="sect2">
<h3 id="mapping.annotations"><a class="anchor" href="#mapping.annotations"></a>5.1. Metadata-based Mapping</h3>
<div class="paragraph">
<p>To take full advantage of the object mapping functionality inside SDN/RX, you should annotate your mapped objects with the <code>@Node</code> annotation.
Although it is not necessary for the mapping framework to have this annotation (your POJOs are mapped correctly, even without any annotations),
it lets the classpath scanner find and pre-process your domain objects to extract the necessary metadata.
If you do not use this annotation, your application takes a slight performance hit the first time you store a domain object,
because the mapping framework needs to build up its internal metadata model so that it knows about the properties of your domain object and how to persist them.</p>
</div>
<div class="sect3">
<h4 id="mappingannotationoverview"><a class="anchor" href="#mappingannotationoverview"></a>5.1.1. Mapping Annotation Overview</h4>
<div class="sect4">
<h5 id="fromsdnrx"><a class="anchor" href="#fromsdnrx"></a>From SDN/RX:</h5>
<div class="ulist">
<ul>
<li>
<p><code>@Node</code>: Applied at the class level to indicate this class is a candidate for mapping to the database.</p>
</li>
<li>
<p><code>@Id</code>: Applied at the field level to mark the field used for identity purpose.</p>
</li>
<li>
<p><code>@GeneratedValue</code>: Applied at the field level together with <code>@Id</code> to specify how unique identifiers should be generated.</p>
</li>
<li>
<p><code>@Property</code>: Applied at the field level to modify the mapping from attributes to properties.</p>
</li>
<li>
<p><code>@Relationship</code>: Applied at the field level to specify the details of a relationship.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="fromspringdatacommons"><a class="anchor" href="#fromspringdatacommons"></a>From Spring Data commons</h5>
<div class="ulist">
<ul>
<li>
<p><code>@org.springframework.data.annotation.Id</code> same as <code>@Id</code> from SDN/RX, in fact, <code>@Id</code> is annotated with Spring Data Common&#8217;s Id-annotation.</p>
</li>
<li>
<p><code>@CreatedBy</code>: Applied at the field level to indicate the creator of a node.</p>
</li>
<li>
<p><code>@CreatedDate</code>: Applied at the field level to indicate the creation date of a node.</p>
</li>
<li>
<p><code>@LastModifiedBy</code>:  Applied at the field level to indicate the author of the last change to a node.</p>
</li>
<li>
<p><code>@LastModifiedDate</code>:  Applied at the field level to indicate the last modification date of a node.</p>
</li>
<li>
<p><code>@PersistenceConstructor</code>: Applied at one constructor to mark it as a the preferred constructor when reading entities.</p>
</li>
<li>
<p><code>@Persistent</code>: Applied at the class level to indicate this class is a candidate for mapping to the database.</p>
</li>
<li>
<p><code>@Version</code>: Applied at field level is used for optimistic locking and checked for modification on save operations.
The initial value is zero which is bumped automatically on every update.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Have a look at <a href="#auditing">Chapter 8</a> for all annotations regarding auditing support.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="thebasicbuildingblocknode"><a class="anchor" href="#thebasicbuildingblocknode"></a>5.1.2. The basic building block: <code>@Node</code></h4>
<div class="paragraph">
<p>The <code>@Node</code> annotation is used to mark a class as a managed domain class, subject to the classpath scanning by the mapping context.</p>
</div>
<div class="paragraph">
<p>To map an Object to nodes in the graph and vice versa, we need a label to identify the class to map to and from.</p>
</div>
<div class="paragraph">
<p><code>@Node</code> has an attribute <code>labels</code> that allows you to configure one or more labels to be used when reading and writing instances of the annotated class.
The <code>value</code> attribute is an alias for <code>labels</code>.
If you don&#8217;t specify a label, than the simple class name will be used as the primary label.
In case you want to provide multiple labels, you could either:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Supply an array to the <code>labels</code> property.
The first element in the array will considered as the primary label.</p>
</li>
<li>
<p>Supply a value for <code>primaryLabel</code> and put the additional labels in <code>labels</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The primary label should always be the most concrete label that reflects your domain class.</p>
</div>
<div class="paragraph">
<p>For each instance of an annotated class that is written through a repository or through the Neo4j template,
one node in the graph with at least the primary label will be written.
Vice versa, all nodes with the primary label will be mapped to the instances of the annotated class.</p>
</div>
<div class="paragraph">
<p>The <code>@Node</code> annotation is not inherited from super-types and interfaces.
You can however annotate your domain classes individually at every inheritance level.
This allows polymorphic queries: You can pass in base or intermediate classes and retrieve the correct, concrete instance for your nodes.
This is only supported for abstract bases annotated with <code>@Node</code>.
The labels defined on such a class will be used as additional labels together with the labels of the concrete implementations.</p>
</div>
</div>
<div class="sect3">
<h4 id="identifyinginstancesid"><a class="anchor" href="#identifyinginstancesid"></a>5.1.3. Identifying instances: <code>@Id</code></h4>
<div class="paragraph">
<p>While <code>@Node</code> creates a mapping between a class and nodes having a specific label,
we also need to make the connection between individual instances of that class (objects) and instances of the node.</p>
</div>
<div class="paragraph">
<p>This is where <code>@Id</code> comes into play.
<code>@Id</code> marks an attribute of the class to be the unique identifier of the object.
That unique identifier is in an optimal world a unique business key or in other words, a natural key.
<code>@Id</code> can be used on all attributes with a supported simple type.</p>
</div>
<div class="paragraph">
<p>Natural keys are however pretty hard to find.
Peoples names for example are seldom unique, change over time or worse, not everyone has a first and last name.</p>
</div>
<div class="paragraph">
<p>We therefore support two different kind of <em>surrogate keys</em>.</p>
</div>
<div class="paragraph">
<p>On an attribute of type <code>long</code> or <code>Long</code>, <code>@Id</code> can be used with <code>@GeneratedValue</code>.
This maps the Neo4j internal id, which is <strong>not</strong> a property on a node or relationship and usually not visible,
to the attribute and allows SDN/RX to retrieve individual instances of the class.</p>
</div>
<div class="paragraph">
<p><code>@GeneratedValue</code> provides the attribute <code>generatorClass</code>.
<code>generatorClass</code> can be used to specify a class implementing <code>IdGenerator</code>.
An <code>IdGenerator</code> is a functional interface and its <code>generateId</code> takes the primary label and the instance to generate an Id for.
We support <code>UUIDStringGenerator</code> as one implementation out of the box.</p>
</div>
<div class="paragraph">
<p>You can also specify a Spring Bean from the application context on <code>@GeneratedValue</code> via <code>generatorRef</code>.
That bean also needs to implement <code>IdGenerator</code>, but can make use of everything in the context, including the Neo4j client or template to interact with the database.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t skip the important notes about ID handling in <a href="#mapping.id-handling">Section 5.2</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mappingpropertiesproperty"><a class="anchor" href="#mappingpropertiesproperty"></a>5.1.4. Mapping properties: <code>@Property</code></h4>
<div class="paragraph">
<p>All attributes of a <code>@Node</code>-annotated class will be persisted as properties of Neo4j nodes and relationships.
Without further configuration, the name of the attribute in the Java or Kotlin class will be used as Neo4j property.</p>
</div>
<div class="paragraph">
<p>If you are working with an existing Neo4j schema or just like to adapt the mapping to your needs, you will need to use <code>@Property</code>.
The <code>name</code> is used to specify the name of the property inside the database.</p>
</div>
</div>
<div class="sect3">
<h4 id="connectingnodesrelationship"><a class="anchor" href="#connectingnodesrelationship"></a>5.1.5. Connecting nodes: <code>@Relationship</code></h4>
<div class="paragraph">
<p>The <code>@Relationship</code> annotation can be used on all attributes that are not a simple type.
It is applicable on attributes of other types annotated with <code>@Node</code> or collections and maps thereof.</p>
</div>
<div class="paragraph">
<p>The <code>type</code> or the <code>value</code> attribute allow configuration of the relationship&#8217;s type, <code>direction</code> allows specifying the direction.
The default direction in SDN/RX is <code>Relationship.Direction#OUTGOING</code>.</p>
</div>
<div class="paragraph">
<p>We support dynamic relationships.
Dynamic relationships are represented as a <code>Map&lt;String, AnnotatedDomainClass&gt;</code>.
In such a case, the type of the relationship to the other domain class is given by the maps key and must not be configured through the <code>@Relationship</code>.</p>
</div>
<div class="sect4">
<h5 id="maprelationshipproperties"><a class="anchor" href="#maprelationshipproperties"></a>Map relationship properties</h5>
<div class="paragraph">
<p>Neo4j supports defining properties not only on nodes but also on relationships.
To express those properties in the model SDN/RX provides <code>@RelationshipProperties</code> to be applied on a simple Java class.</p>
</div>
<div class="paragraph">
<p>In the entity class the relationship can be modelled as before but its type has to be a <code>Map</code> with the related node as the key and the relation property class as value.</p>
</div>
<div class="paragraph">
<p>A relationship property class and its usage may look like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 10. Relationship properties <code>Roles</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RelationshipProperties</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Roles</span> {

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; roles;

        <span class="directive">public</span> Roles(<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; roles) {
                <span class="local-variable">this</span>.roles = roles;
        }

        <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getRoles() {
                <span class="keyword">return</span> roles;
        }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 11. Defining relationship properties for an entity</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="predefined-type">Map</span>&lt;PersonEntity, Roles&gt; actorsAndRoles = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="relationshipquerylimit"><a class="anchor" href="#relationshipquerylimit"></a>Relationship query limit</h5>
<div class="paragraph">
<p>In general there is no limitation of relationships / hops for creating the queries.
SDN/RX parses the whole reachable graph from your modelled nodes.
It is possible to have self-referencing entities and self-referencing concrete instances.</p>
</div>
<div class="paragraph">
<p>If these entities or instances for a cycle we have a strict limit of <strong>2</strong> repetitions of walking the same path through the graph.
E.g. You model a social network of <code>(:Person)-[:HAS_FRIEND]&#8594;(:Person)-[:HAS_FRIEND]&#8230;&#8203;</code> you will only get the friends of the second degree.
If you need a more specific mapping for your domain we advise you to use custom queries.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="acompleteexample"><a class="anchor" href="#acompleteexample"></a>5.1.6. A complete example</h4>
<div class="paragraph">
<p>Putting all those together, we can create a simple domain.
We use movies and people with different roles:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. The <code>MovieEntity</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">static</span> <span class="include">org.neo4j.springframework.data.core.schema.Relationship.Direction</span>.*;

<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.HashMap</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Id</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Node</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Property</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Relationship</span>;

<span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> title;

        <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">tagline</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> description;

        <span class="annotation">@Relationship</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>, direction = INCOMING) <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;PersonEntity, Roles&gt; actorsAndRoles = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

        <span class="annotation">@Relationship</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">DIRECTED</span><span class="delimiter">&quot;</span></span>, direction = INCOMING)
        <span class="directive">private</span> <span class="predefined-type">List</span>&lt;PersonEntity&gt; directors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="directive">public</span> MovieEntity(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> description) { <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="local-variable">this</span>.title = title;
                <span class="local-variable">this</span>.description = description;
        }

        <span class="comment">// Getters omitted for brevity</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Node</code> is used to mark this class as a managed entity.
It also is used to configure the Neo4j label.
The label defaults to the name of the class, if you&#8217;re just using plain <code>@Node</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each entity has to have an id.
We use the movie&#8217;s name as unique identifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This shows <code>@Property</code> as a way to use a different name for the field than for the graph property.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This configures an incoming relationship to a person.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is the constructor to be used by your application code as well as by SDN/RX.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>People are mapped in two roles here, <code>actors</code> and <code>directors</code>.
The domain class is the same:</p>
</div>
<div id="mapping.complete-example.person" class="exampleblock">
<div class="title">Example 2. The <code>PersonEntity</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Id</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Node</span>;

<span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PersonEntity</span> {

        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> name;

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Integer</span> born;

        <span class="directive">public</span> PersonEntity(<span class="predefined-type">Integer</span> born, <span class="predefined-type">String</span> name) {
                <span class="local-variable">this</span>.born = born;
                <span class="local-variable">this</span>.name = name;
        }

        <span class="directive">public</span> <span class="predefined-type">Integer</span> getBorn() {
                <span class="keyword">return</span> born;
        }

        <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
                <span class="keyword">return</span> name;
        }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We haven&#8217;t modelled the relationship between movies and people in both direction.
      Why is that?
      We see the <code>MovieEntity</code> as the aggregate root, owning the relationships.
      On the other hand, we want to be able to pull all people from the database without selecting all the movies associated with them.
      Please consider your applications use case before you try to map every relationship in your database in every direction.
      While you can do this, you may end up rebuilding a graph database inside your object graph and this is not the intention of a mapping framework.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping.id-handling"><a class="anchor" href="#mapping.id-handling"></a>5.2. Handling and provisioning of unique IDs</h3>
<div class="sect3">
<h4 id="usingtheinternalneo4jid"><a class="anchor" href="#usingtheinternalneo4jid"></a>5.2.1. Using the internal Neo4j id</h4>
<div class="paragraph">
<p>The easiest way to give your domain classes an unique identifier is the combination of <code>@Id</code> and <code>@GeneratedValue</code>
on a field of type <code>Long</code> (preferable the object, not the scalar <code>long</code>, as literal <code>null</code> is the better indicator whether an instance is new or not):</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Mutable MovieEntity with internal Neo4j id</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span>
        <span class="directive">private</span> <span class="predefined-type">Long</span> id;

        <span class="directive">private</span> <span class="predefined-type">String</span> name;

        <span class="directive">public</span> MovieEntity(<span class="predefined-type">String</span> name) {
                <span class="local-variable">this</span>.name = name;
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You don&#8217;t need to provide a setter for the field, SDN/RX will use reflection to assign the field, but use a setter if there is one.
If you want to create an immutable entity with an internally generated id, you have to provide a <em>wither</em>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Immutable MovieEntity with internal Neo4j id</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Long</span> id; <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="directive">private</span> <span class="predefined-type">String</span> name;

        <span class="directive">public</span> MovieEntity(<span class="predefined-type">String</span> name) { <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="local-variable">this</span>(<span class="predefined-constant">null</span>, name);
        }

        <span class="directive">private</span> MovieEntity(<span class="predefined-type">Long</span> id, <span class="predefined-type">String</span> name) { <i class="conum" data-value="3"></i><b>(3)</b>
                <span class="local-variable">this</span>.id = id;
                <span class="local-variable">this</span>.name = name;
        }

        <span class="directive">public</span> MovieEntity withId(<span class="predefined-type">Long</span> id) { <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="keyword">if</span> (<span class="local-variable">this</span>.id.equals(id)) {
                        <span class="keyword">return</span> <span class="local-variable">this</span>;
                } <span class="keyword">else</span> {
                        <span class="keyword">return</span> <span class="keyword">new</span> MovieEntity(id, <span class="local-variable">this</span>.title);
                }
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Immutable final id field indicating a generated value</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Public constructor, used by the application and Spring Data</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Internally used constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is a so-called <em>wither</em> for the <code>id</code>-attribute.
It creates a new entity and set&#8217;s the field accordingly, without modifying the original entity, thus making it immutable.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You either have to provide a setter for the id attribute or something like a <em>wither</em>, if you want to have</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages: It is pretty clear that the id attribute is the surrogate business key, it takes no further effort or configuration to use it.</p>
</li>
<li>
<p>Disadvantage: It is tied to Neo4js internal database id, which is not unique to our application entity only over a database lifetime.</p>
</li>
<li>
<p>Disadvantage: It takes more effort to create an immutable entity</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="useexternallyprovidedsurrogatekeys"><a class="anchor" href="#useexternallyprovidedsurrogatekeys"></a>5.2.2. Use externally provided surrogate keys</h4>
<div class="paragraph">
<p>The <code>@GeneratedValue</code> annotation can take a class implementing <code>org.neo4j.springframework.data.core.schema.IdGenerator</code> as parameter.
SDN/RX provides <code>InternalIdGenerator</code> (the default) and <code>UUIDStringGenerator</code> out of the box.
The later generates new UUIDs for each entity and returns them as <code>java.lang.String</code>.
An application entity using that would look like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Mutable MovieEntity with externally generated surrogate key</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span>(UUIDStringGenerator.class)
        <span class="directive">private</span> <span class="predefined-type">String</span> id;

        <span class="directive">private</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We have to discuss two separate things regarding advantages and disadvantages.
The assignment itself and the UUID-Strategy.
A <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">universally unique identifier</a> is meant to be unique for practical purposes.
To quote Wikipedia:
“Thus, anyone can create a UUID and use it to identify something with near certainty that the identifier does not duplicate one that has already been,
or will be, created to identify something else.”
Our strategy uses Java internal UUID mechanism, employing a cryptographically strong pseudo random number generator.
In most cases that should work fine, but your mileage might vary.</p>
</div>
<div class="paragraph">
<p>That leaves the assignment itself:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantage: The application is in full control and can generate a unique key that is just unique enough for the purpose of the application.
The generated value will be stable and there won’t be a need to change it later on.</p>
</li>
<li>
<p>Disadvantage: The generated strategy is applied on the application side of things.
In those days most applications will be deployed in more than one instance to scale nicely.
If your strategy is prone to generate duplicates than inserts will fail as uniques of the primary key will be violated.
So while you don’t have to think about a unique business key in this scenario, you have to think more what to generate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You have several options to role your own ID generator.
One is a POJO implementing a generator:</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Naive sequence generator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.concurrent.atomic.AtomicInteger</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.IdGenerator</span>;
<span class="keyword">import</span> <span class="include">org.springframework.util.StringUtils</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestSequenceGenerator</span> <span class="directive">implements</span> IdGenerator&lt;<span class="predefined-type">String</span>&gt; {

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">AtomicInteger</span> sequence = <span class="keyword">new</span> <span class="predefined-type">AtomicInteger</span>(<span class="integer">0</span>);

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> generateId(<span class="predefined-type">String</span> primaryLabel, <span class="predefined-type">Object</span> entity) {
                <span class="keyword">return</span> StringUtils.uncapitalize(primaryLabel) +
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> + sequence.incrementAndGet();
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Another option is to provide an additional Spring Bean like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Neo4jClient based ID generator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="type">class</span> <span class="class">MyIdGenerator</span> <span class="directive">implements</span> IdGenerator&lt;<span class="predefined-type">String</span>&gt; {

        <span class="directive">private</span> <span class="directive">final</span> Neo4jClient neo4jClient;

        <span class="directive">public</span> MyIdGenerator(Neo4jClient neo4jClient) {
                <span class="local-variable">this</span>.neo4jClient = neo4jClient;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> generateId(<span class="predefined-type">String</span> primaryLabel, <span class="predefined-type">Object</span> entity) {
                <span class="keyword">return</span> neo4jClient.query(<span class="string"><span class="delimiter">&quot;</span><span class="content">YOUR CYPHER QUERY FOR THE NEXT ID</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
                        .fetchAs(<span class="predefined-type">String</span>.class).one().get();
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use exactly the query or logic your need.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The generator above would be configured as a bean reference like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Mutable MovieEntity using a Spring Bean as Id generator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span>(generatorRef = <span class="string"><span class="delimiter">&quot;</span><span class="content">myIdGenerator</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">private</span> <span class="predefined-type">String</span> id;

        <span class="directive">private</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="usingabusinesskey"><a class="anchor" href="#usingabusinesskey"></a>5.2.3. Using a business key</h4>
<div class="paragraph">
<p>We have been using a business key in the complete example&#8217;s <code>MovieEntity</code> and <a href="#mapping.complete-example.person"><code>PersonEntity</code></a>.
The name of the person is assigned at construction time, both by your application and while being loaded through Spring Data.</p>
</div>
<div class="paragraph">
<p>This is only possible, if you find a stable, unique business key, but makes great immutable domain objects.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages: Using a business or natural key as primary key is natural.
The entity in question is clearly identified and it feels most of the time just right in the further modelling of your domain.</p>
</li>
<li>
<p>Disadvantages: Business keys as primary keys will be hard to update once you realise that the key you found is not as stable as you thought.
Often it turns out that it can change, even when promised otherwise.
Apart from that, finding identifier that are truly unique for a thing is hard.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping.fundamentals"><a class="anchor" href="#mapping.fundamentals"></a>5.3. Spring Data Object Mapping Fundamentals</h3>
<div class="paragraph">
<p>This section covers the fundamentals of Spring Data object mapping, object creation, field and property access, mutability and immutability.</p>
</div>
<div class="paragraph">
<p>Core responsibility of the Spring Data object mapping is to create instances of domain objects and map the store-native data structures onto those.
This means we need two fundamental steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instance creation by using one of the constructors exposed.</p>
</li>
<li>
<p>Instance population to materialize all exposed properties.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="mapping.fundamentals.object-creation"><a class="anchor" href="#mapping.fundamentals.object-creation"></a>5.3.1. Object creation</h4>
<div class="paragraph">
<p>Spring Data automatically tries to detect a persistent entity&#8217;s constructor to be used to materialize objects of that type.
The resolution algorithm works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If there is a no-argument constructor, it will be used.
Other constructors will be ignored.</p>
</li>
<li>
<p>If there is a single constructor taking arguments, it will be used.</p>
</li>
<li>
<p>If there are multiple constructors taking arguments, the one to be used by Spring Data will have to be annotated with <code>@PersistenceConstructor</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The value resolution assumes constructor argument names to match the property names of the entity,
i.e. the resolution will be performed as if the property was to be populated, including all customizations in mapping (different datastore column or field name etc.).
This also requires either parameter names information available in the class file or an <code>@ConstructorProperties</code> annotation being present on the constructor.</p>
</div>
<div id="mapping.fundamentals.object-creation.details" class="sidebarblock">
<div class="content">
<div class="title">Object creation internals</div>
<div class="paragraph">
<p>To avoid the overhead of reflection, Spring Data object creation uses a factory class generated at runtime by default,
which will call the domain classes constructor directly.
I.e. for this example type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
  Person(<span class="predefined-type">String</span> firstname, <span class="predefined-type">String</span> lastname) { <span class="error">…</span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>we will create a factory class semantically equivalent to this one at runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">PersonObjectInstantiator</span> <span class="directive">implements</span> ObjectInstantiator {

  <span class="predefined-type">Object</span> newInstance(<span class="predefined-type">Object</span>... args) {
    <span class="keyword">return</span> <span class="keyword">new</span> Person((<span class="predefined-type">String</span>) args[<span class="integer">0</span>], (<span class="predefined-type">String</span>) args[<span class="integer">1</span>]);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us a roundabout 10% performance boost over reflection.
For the domain class to be eligible for such optimization, it needs to adhere to a set of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it must not be a private class</p>
</li>
<li>
<p>it must not be a non-static inner class</p>
</li>
<li>
<p>it must not be a CGLib proxy class</p>
</li>
<li>
<p>the constructor to be used by Spring Data must not be private</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of these criteria match, Spring Data will fall back to entity instantiation via reflection.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping.fundamentals.property-population"><a class="anchor" href="#mapping.fundamentals.property-population"></a>5.3.2. Property population</h4>
<div class="paragraph">
<p>Once an instance of the entity has been created, Spring Data populates all remaining persistent properties of that class.
Unless already populated by the entity&#8217;s constructor (i.e. consumed through its constructor argument list),
the identifier property will be populated first to allow the resolution of cyclic object references.
After that, all non-transient properties that have not already been populated by the constructor are set on the entity instance.
For that we use the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the property is immutable but exposes a <em>wither</em> method (see below), we use the <em>wither</em> to create a new entity instance with the new property value.</p>
</li>
<li>
<p>If property access (i.e. access through getters and setters) is defined, we are invoking the setter method.</p>
</li>
<li>
<p>By default, we set the field value directly.</p>
</li>
</ol>
</div>
<div id="mapping.fundamentals.property-population.details" class="sidebarblock">
<div class="content">
<div class="title">Property population internals</div>
<div class="paragraph">
<p>Similarly to our <a href="#mapping.object-creation.details">optimizations in object construction</a> we also use
Spring Data runtime generated accessor classes to interact with the entity instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

  <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Long</span> id;
  <span class="directive">private</span> <span class="predefined-type">String</span> firstname;
  <span class="directive">private</span> <span class="annotation">@AccessType</span>(<span class="predefined-type">Type</span>.PROPERTY) <span class="predefined-type">String</span> lastname;

  Person() {
    <span class="local-variable">this</span>.id = <span class="predefined-constant">null</span>;
  }

  Person(<span class="predefined-type">Long</span> id, <span class="predefined-type">String</span> firstname, <span class="predefined-type">String</span> lastname) {
    <span class="comment">// Field assignments</span>
  }

  Person withId(<span class="predefined-type">Long</span> id) {
    <span class="keyword">return</span> <span class="keyword">new</span> Person(id, <span class="local-variable">this</span>.firstname, <span class="local-variable">this</span>.lastame);
  }

  <span class="type">void</span> setLastname(<span class="predefined-type">String</span> lastname) {
    <span class="local-variable">this</span>.lastname = lastname;
  }
}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 9. A generated Property Accessor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">PersonPropertyAccessor</span> <span class="directive">implements</span> PersistentPropertyAccessor {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> MethodHandle firstname;              <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="directive">private</span> Person person;                                    <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="directive">public</span> <span class="type">void</span> setProperty(PersistentProperty property, <span class="predefined-type">Object</span> value) {

    <span class="predefined-type">String</span> name = property.getName();

    <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">firstname</span><span class="delimiter">&quot;</span></span>.equals(name)) {
      firstname.invoke(person, (<span class="predefined-type">String</span>) value);             <i class="conum" data-value="2"></i><b>(2)</b>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>.equals(name)) {
      <span class="local-variable">this</span>.person = person.withId((<span class="predefined-type">Long</span>) value);            <i class="conum" data-value="3"></i><b>(3)</b>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">lastname</span><span class="delimiter">&quot;</span></span>.equals(name)) {
      <span class="local-variable">this</span>.person.setLastname((<span class="predefined-type">String</span>) value);              <i class="conum" data-value="4"></i><b>(4)</b>
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>PropertyAccessor&#8217;s hold a mutable instance of the underlying object.
This is, to enable mutations of otherwise immutable properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default, Spring Data uses field-access to read and write property values.
As per visibility rules of <code>private</code> fields, <code>MethodHandles</code> are used to interact with fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The class exposes a <code>withId(…)</code> method that&#8217;s used to set the identifier,
e.g. when an instance is inserted into the datastore and an identifier has been generated. Calling <code>withId(…)</code> creates a new <code>Person</code> object. All subsequent mutations will take place in the new instance leaving the previous untouched.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Using property-access allows direct method invocations without using <code>MethodHandles</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>This gives us a roundabout 25% performance boost over reflection.
For the domain class to be eligible for such optimization, it needs to adhere to a set of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Types must not reside in the default or under the <code>java</code> package.</p>
</li>
<li>
<p>Types and their constructors must be <code>public</code></p>
</li>
<li>
<p>Types that are inner classes must be <code>static</code>.</p>
</li>
<li>
<p>The used Java Runtime must allow for declaring classes in the originating <code>ClassLoader</code>.
Java 9 and newer impose certain limitations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Spring Data attempts to use generated property accessors and falls back to reflection-based ones if a limitation is detected.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the following entity:</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. A sample entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

  <span class="directive">private</span> <span class="directive">final</span> <span class="annotation">@Id</span> <span class="predefined-type">Long</span> id;                                                <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> firstname, lastname;                                 <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="directive">private</span> <span class="directive">final</span> LocalDate birthday;
  <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> age; <i class="conum" data-value="3"></i><b>(3)</b>

  <span class="directive">private</span> <span class="predefined-type">String</span> comment;                                                   <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="directive">private</span> <span class="annotation">@AccessType</span>(<span class="predefined-type">Type</span>.PROPERTY) <span class="predefined-type">String</span> remarks;                        <i class="conum" data-value="5"></i><b>(5)</b>

  <span class="directive">static</span> Person of(<span class="predefined-type">String</span> firstname, <span class="predefined-type">String</span> lastname, LocalDate birthday) { <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="keyword">return</span> <span class="keyword">new</span> Person(<span class="predefined-constant">null</span>, firstname, lastname, birthday,
      Period.between(birthday, LocalDate.now()).getYears());
  }

  Person(<span class="predefined-type">Long</span> id, <span class="predefined-type">String</span> firstname, <span class="predefined-type">String</span> lastname, LocalDate birthday, <span class="type">int</span> age) { <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="local-variable">this</span>.id = id;
    <span class="local-variable">this</span>.firstname = firstname;
    <span class="local-variable">this</span>.lastname = lastname;
    <span class="local-variable">this</span>.birthday = birthday;
    <span class="local-variable">this</span>.age = age;
  }

  Person withId(<span class="predefined-type">Long</span> id) {                                                  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">return</span> <span class="keyword">new</span> Person(id, <span class="local-variable">this</span>.firstname, <span class="local-variable">this</span>.lastname, <span class="local-variable">this</span>.birthday);
  }

  <span class="type">void</span> setRemarks(<span class="predefined-type">String</span> remarks) {                                         <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="local-variable">this</span>.remarks = remarks;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The identifier property is final but set to <code>null</code> in the constructor.
The class exposes a <code>withId(…)</code> method that&#8217;s used to set the identifier, e.g. when an instance is inserted into the datastore and an identifier has been generated.
The original <code>Person</code> instance stays unchanged as a new one is created.
The same pattern is usually applied for other properties that are store managed but might have to be changed for persistence operations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>firstname</code> and <code>lastname</code> properties are ordinary immutable properties potentially exposed through getters.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>age</code> property is an immutable but derived one from the <code>birthday</code> property.
With the design shown, the database value will trump the defaulting as Spring Data uses the only declared constructor.
Even if the intent is that the calculation should be preferred, it&#8217;s important that this constructor also takes <code>age</code> as parameter (to potentially ignore it)
as otherwise the property population step will attempt to set the age field and fail due to it being immutable and no wither being present.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>comment</code> property is mutable is populated by setting its field directly.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>remarks</code> properties are mutable and populated by setting the <code>comment</code> field directly or by invoking the setter method for</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The class exposes a factory method and a constructor for object creation.
The core idea here is to use factory methods instead of additional constructors to avoid the need for constructor disambiguation through <code>@PersistenceConstructor</code>.
Instead, defaulting of properties is handled within the factory method.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="generalrecommendations"><a class="anchor" href="#generalrecommendations"></a>5.3.3. General recommendations</h4>
<div class="ulist">
<ul>
<li>
<p><em>Try to stick to immutable objects</em>&#8201;&#8212;&#8201;Immutable objects are straightforward to create as materializing an object is then a matter of calling its constructor only.
Also, this avoids your domain objects to be littered with setter methods that allow client code to manipulate the objects state.
If you need those, prefer to make them package protected so that they can only be invoked by a limited amount of co-located types.
Constructor-only materialization is up to 30% faster than properties population.</p>
</li>
<li>
<p><em>Provide an all-args constructor</em>&#8201;&#8212;&#8201;Even if you cannot or don&#8217;t want to model your entities as immutable values,
there&#8217;s still value in providing a constructor that takes all properties of the entity as arguments, including the mutable ones,
as this allows the object mapping to skip the property population for optimal performance.</p>
</li>
<li>
<p><em>Use factory methods instead of overloaded constructors to avoid <code>@PersistenceConstructor</code></em>&#8201;&#8212;&#8201;With an all-argument constructor needed for optimal performance, we usually want to expose more application use case specific constructors
that omit things like auto-generated identifiers etc.
It&#8217;s an established pattern to rather use static factory methods to expose these variants of the all-args constructor.</p>
</li>
<li>
<p><em>Make sure you adhere to the constraints that allow the generated instantiator and property accessor classes to be used</em></p>
</li>
<li>
<p><em>For identifiers to be generated, still use a final field in combination with a wither method</em></p>
</li>
<li>
<p><em>Use Lombok to avoid boilerplate code</em>&#8201;&#8212;&#8201;As persistence operations usually require a constructor taking all arguments, their declaration becomes a tedious repetition of boilerplate parameter to field assignments that can best be avoided by using Lombok&#8217;s <code>@AllArgsConstructor</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mapping.fundamentals.kotlin"><a class="anchor" href="#mapping.fundamentals.kotlin"></a>5.3.4. Kotlin support</h4>
<div class="paragraph">
<p>Spring Data adapts specifics of Kotlin to allow object creation and mutation.</p>
</div>
<div class="sect4">
<h5 id="kotlinobjectcreation"><a class="anchor" href="#kotlinobjectcreation"></a>Kotlin object creation</h5>
<div class="paragraph">
<p>Kotlin classes are supported to be instantiated , all classes are immutable by default and require explicit property declarations to define mutable properties.
Consider the following <code>data</code> class <code>Person</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">data <span class="type">class</span> <span class="class">Person</span>(val id: <span class="predefined-type">String</span>, val name: <span class="predefined-type">String</span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The class above compiles to a typical class with an explicit constructor.
We can customize this class by adding another constructor and annotate it with <code>@PersistenceConstructor</code> to indicate a constructor preference:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">data <span class="type">class</span> <span class="class">Person</span>(var id: <span class="predefined-type">String</span>, val name: <span class="predefined-type">String</span>) {

    <span class="annotation">@PersistenceConstructor</span>
    constructor(id: <span class="predefined-type">String</span>) : <span class="local-variable">this</span>(id, <span class="string"><span class="delimiter">&quot;</span><span class="content">unknown</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Kotlin supports parameter optionality by allowing default values to be used if a parameter is not provided.
When Spring Data detects a constructor with parameter defaulting, then it leaves these parameters absent
if the data store does not provide a value (or simply returns <code>null</code>) so Kotlin can apply parameter defaulting.
Consider the following class that applies parameter defaulting for <code>name</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">data <span class="type">class</span> <span class="class">Person</span>(var id: <span class="predefined-type">String</span>, val name: <span class="predefined-type">String</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">unknown</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Every time the <code>name</code> parameter is either not part of the result or its value is <code>null</code>, then the <code>name</code> defaults to <code>unknown</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="propertypopulationofkotlindataclasses"><a class="anchor" href="#propertypopulationofkotlindataclasses"></a>Property population of Kotlin data classes</h5>
<div class="paragraph">
<p>In Kotlin, all classes are immutable by default and require explicit property declarations to define mutable properties.
Consider the following <code>data</code> class <code>Person</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">data <span class="type">class</span> <span class="class">Person</span>(val id: <span class="predefined-type">String</span>, val name: <span class="predefined-type">String</span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This class is effectively immutable.
It allows to create new instances as Kotlin generates a <code>copy(…)</code> method that creates new object instances
copying all property values from the existing object and applying property values provided as arguments to the method.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repositories"><a class="anchor" href="#repositories"></a>6. Working with Spring Data Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of the Spring Data repository abstraction is to significantly reduce the amount of boilerplate code required
to implement data access layers for various persistence stores.</p>
</div>
<div class="sect2">
<h3 id="repositories.core-concepts"><a class="anchor" href="#repositories.core-concepts"></a>6.1. Core concepts</h3>
<div class="paragraph">
<p>The central interface in the Spring Data repository abstraction is <code>Repository</code>.
It takes the domain class to manage as well as the ID type of the domain class as type arguments.
This interface acts primarily as a marker interface to capture the types to work with and to help you to discover interfaces that extend this one.
The <code>CrudRepository</code> provides sophisticated CRUD functionality for the entity class that is being managed.</p>
</div>
<div id="repositories.repository" class="exampleblock">
<div class="title">Example 11. <code>CrudRepository</code> interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CrudRepository</span>&lt;T, ID&gt; <span class="directive">extends</span> Repository&lt;T, ID&gt; {

  &lt;S <span class="directive">extends</span> T&gt; S save(S entity);      <i class="conum" data-value="1"></i><b>(1)</b>

  Optional&lt;T&gt; findById(ID primaryKey); <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="predefined-type">Iterable</span>&lt;T&gt; findAll();               <i class="conum" data-value="3"></i><b>(3)</b>

  <span class="type">long</span> count();                        <i class="conum" data-value="4"></i><b>(4)</b>

  <span class="type">void</span> delete(T entity);               <i class="conum" data-value="5"></i><b>(5)</b>

  <span class="type">boolean</span> existsById(ID primaryKey);   <i class="conum" data-value="6"></i><b>(6)</b>

  <span class="comment">// … more functionality omitted.</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Saves the given entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returns the entity identified by the given ID.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns all entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns the number of entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Deletes the given entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Indicates whether an entity with the given ID exists.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We also provide a technology-specific abstraction:
      such as <code>Neo4jRepository</code> and the reactive variant, <code>ReactiveNeo4jRepository</code>.
      Those interfaces extend <code>CrudRepository</code> and expose the capabilities of the underlying persistence technology
      in addition to the rather generic persistence technology-agnostic interfaces such as <code>CrudRepository</code>.
      Also, methods returning an <code>Iterable</code> are narrowed down to return a <code>java.util.List</code> instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On top of the <code>CrudRepository</code>, there is a <code>PagingAndSortingRepository</code> abstraction that adds additional methods to ease paginated access to entities:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. <code>PagingAndSortingRepository</code> interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">PagingAndSortingRepository</span>&lt;T, ID&gt; <span class="directive">extends</span> CrudRepository&lt;T, ID&gt; {

  <span class="predefined-type">Iterable</span>&lt;T&gt; findAll(Sort sort);

  Page&lt;T&gt; findAll(<span class="predefined-type">Pageable</span> pageable);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the second page of <code>User</code> by a page size of 20, you could do something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">PagingAndSortingRepository&lt;User, <span class="predefined-type">Long</span>&gt; repository = <span class="comment">// … get access to a bean</span>
Page&lt;User&gt; users = repository.findAll(PageRequest.of(<span class="integer">1</span>, <span class="integer">20</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to query methods, query derivation for both count and delete queries is available.
The following list shows the interface definition for a derived count query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Derived Count Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> CrudRepository&lt;User, <span class="predefined-type">Long</span>&gt; {

  <span class="type">long</span> countByLastname(<span class="predefined-type">String</span> lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following list shows the interface definition for a derived delete query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Derived Delete Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> CrudRepository&lt;User, <span class="predefined-type">Long</span>&gt; {

  <span class="type">long</span> deleteByLastname(<span class="predefined-type">String</span> lastname);

  <span class="predefined-type">List</span>&lt;User&gt; removeByLastname(<span class="predefined-type">String</span> lastname);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.query-methods"><a class="anchor" href="#repositories.query-methods"></a>6.2. Query methods</h3>
<div class="paragraph">
<p>Standard CRUD functionality repositories usually have queries on the underlying datastore.
With Spring Data, declaring those queries becomes a four-step process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Declare an interface extending Repository or one of its subinterfaces and type it to the domain class and ID type that it should handle, as shown in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">PersonRepository</span> <span class="directive">extends</span> Repository&lt;Person, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }</code></pre>
</div>
</div>
</li>
<li>
<p>Declare query methods on the interface.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">PersonRepository</span> <span class="directive">extends</span> Repository&lt;Person, <span class="predefined-type">Long</span>&gt; {
  <span class="predefined-type">List</span>&lt;Person&gt; findByLastname(<span class="predefined-type">String</span> lastname);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Provide some <a href="#repositories.create-instances.java-config">JavaConfig</a> to set up Spring to create proxy instances for those interfaces.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.config.AbstractNeo4jConfig</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.repository.config.EnableNeo4jRepositories</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Bean</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.transaction.annotation.EnableTransactionManagement</span>;

<span class="annotation">@Configuration</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@EnableNeo4jRepositories</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@EnableTransactionManagement</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> <span class="directive">extends</span> AbstractNeo4jConfig { <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> <span class="predefined-type">Driver</span> driver() { <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="keyword">return</span> GraphDatabase.driver(<span class="string"><span class="delimiter">&quot;</span><span class="content">bolt://localhost:7687</span><span class="delimiter">&quot;</span></span>, AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>));
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Driver</code> bean is required to provide the actual connection to the database.</p>
</div>
<div class="paragraph">
<p>Note that the configuration does not configure a package explicitly, because the package of the annotated class is used by default.
To customize the package to scan, use one of the <code>basePackage…</code> attributes of the <code>@EnableNeo4jRepositories</code>-annotation.</p>
</div>
</li>
<li>
<p>Inject the repository instance and use it, as shown in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SomeClient</span> {

  <span class="directive">private</span> <span class="directive">final</span> PersonRepository repository;

  SomeClient(PersonRepository repository) {
    <span class="local-variable">this</span>.repository = repository;
  }

  <span class="type">void</span> doSomething() {
    <span class="predefined-type">List</span>&lt;Person&gt; persons = repository.findByLastname(<span class="string"><span class="delimiter">&quot;</span><span class="content">Matthews</span><span class="delimiter">&quot;</span></span>);
  }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following sections explain each step in detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="repositories.definition"><a class="anchor" href="#repositories.definition"></a>6.3. Defining Repository Interfaces</h3>
<div class="paragraph">
<p>First, define a domain class-specific repository interface.
The interface must extend <code>Repository</code> and be typed to the domain class and an ID type.
If you want to expose CRUD methods for that domain type, extend <code>CrudRepository</code> instead of <code>Repository</code>.</p>
</div>
<div class="sect3">
<h4 id="repositories.definition-tuning"><a class="anchor" href="#repositories.definition-tuning"></a>6.3.1. Fine-tuning Repository Definition</h4>
<div class="paragraph">
<p>Typically, your repository interface extends <code>Repository</code>, <code>CrudRepository</code>, or <code>PagingAndSortingRepository</code>.
Alternatively, if you do not want to extend Spring Data interfaces, you can also annotate your repository interface with <code>@RepositoryDefinition</code>.
Extending <code>CrudRepository</code> exposes a complete set of methods to manipulate your entities.
If you prefer to be selective about the methods being exposed, copy the methods you want to expose from <code>CrudRepository</code> into your domain repository.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Doing so lets you define your own abstractions on top of the provided Spring Data Repositories functionality.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows how to selectively expose CRUD methods (<code>findById</code> and <code>save</code>, in this case):</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Selectively exposing CRUD methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NoRepositoryBean</span>
<span class="type">interface</span> <span class="class">MyBaseRepository</span>&lt;T, ID&gt; <span class="directive">extends</span> Repository&lt;T, ID&gt; {

  Optional&lt;T&gt; findById(ID id);

  &lt;S <span class="directive">extends</span> T&gt; S save(S entity);
}

<span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> MyBaseRepository&lt;User, <span class="predefined-type">Long</span>&gt; {
  User findByEmailAddress(EmailAddress emailAddress);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the prior example, you defined a common base interface for all your domain repositories and exposed <code>findById(…)</code> as well as <code>save(…)</code>.
These methods are routed into the base repository implementation (for the imperative version, the implementation is <code>SimpleNeo4jRepository</code>),
because they match the method signatures in <code>CrudRepository</code>.
So the <code>UserRepository</code> can now save users, find individual users by ID, and trigger a query to find <code>Users</code> by email address.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The intermediate repository interface is annotated with <code>@NoRepositoryBean</code>.
      Make sure you add that annotation to all repository interfaces for which Spring Data should not create instances at runtime.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.multiple-modules"><a class="anchor" href="#repositories.multiple-modules"></a>6.3.2. Using Repositories with Multiple Spring Data Modules</h4>
<div class="paragraph">
<p>Using a unique Spring Data module in your application makes things simple, because all repository interfaces in the defined scope are bound to one Spring Data module.
Sometimes, applications require using more than one Spring Data module.
In such cases, a repository definition must distinguish between persistence technologies.
When it detects multiple repository factories on the class path, Spring Data enters strict repository configuration mode.
Strict configuration uses details on the repository or the domain class to decide about Spring Data module binding for a repository definition:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the repository definition <a href="#repositories.multiple-modules.types">extends the module-specific repository</a>, then it is a valid candidate for the particular Spring Data module.</p>
</li>
<li>
<p>If the domain class is <a href="#repositories.multiple-modules.annotations">annotated with the module-specific type annotation</a>, then it is a valid candidate for the particular Spring Data module.
Spring Data modules accept either third-party annotations (such as JPA&#8217;s <code>@Entity</code>) or provide their own annotations (such as <code>@Node</code> for Spring Data Neo4j⚡RX).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses module-specific interfaces (JPA in this case):</p>
</div>
<div id="repositories.multiple-modules.types" class="exampleblock">
<div class="title">Example 16. Repository definitions using module-specific interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">MyRepository</span> <span class="directive">extends</span> JpaRepository&lt;User, <span class="predefined-type">Long</span>&gt; { }

<span class="annotation">@NoRepositoryBean</span>
<span class="type">interface</span> <span class="class">MyBaseRepository</span>&lt;T, ID&gt; <span class="directive">extends</span> JpaRepository&lt;T, ID&gt; { <span class="error">…</span> }

<span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> MyBaseRepository&lt;User, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MyRepository</code> and <code>UserRepository</code> extend <code>JpaRepository</code> in their type hierarchy.
They are valid candidates for the Spring Data JPA module.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses generic interfaces:</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. Repository definitions using generic interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">AmbiguousRepository</span> <span class="directive">extends</span> Repository&lt;User, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }

<span class="annotation">@NoRepositoryBean</span>
<span class="type">interface</span> <span class="class">MyBaseRepository</span>&lt;T, ID&gt; <span class="directive">extends</span> CrudRepository&lt;T, ID&gt; { <span class="error">…</span> }

<span class="type">interface</span> <span class="class">AmbiguousUserRepository</span> <span class="directive">extends</span> MyBaseRepository&lt;User, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AmbiguousRepository</code> and <code>AmbiguousUserRepository</code> extend only <code>Repository</code> and <code>CrudRepository</code> in their type hierarchy.
While this is perfectly fine when using a unique Spring Data module, multiple modules cannot distinguish to which particular Spring Data these repositories should be bound.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses domain classes with annotations:</p>
</div>
<div id="repositories.multiple-modules.annotations" class="exampleblock">
<div class="title">Example 18. Repository definitions using domain classes with annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">PersonRepository</span> <span class="directive">extends</span> Repository&lt;Person, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }

<span class="annotation">@Entity</span>
<span class="type">class</span> <span class="class">Person</span> { <span class="error">…</span> }

<span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> Repository&lt;User, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }

<span class="annotation">@Node</span>
<span class="type">class</span> <span class="class">User</span> { <span class="error">…</span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PersonRepository</code> references <code>Person</code>, which is annotated with the JPA <code>@Entity</code> annotation, so this repository clearly belongs to Spring Data JPA.
<code>UserRepository</code> references <code>User</code>, which is annotated with SDN/RX&#8217;s <code>@Node</code> annotation.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following bad example shows a repository that uses domain classes with mixed annotations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Repository definitions using domain classes with mixed annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">JpaPersonRepository</span> <span class="directive">extends</span> Repository&lt;Person, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }

<span class="type">interface</span> <span class="class">Neo4jPersonRepository</span> <span class="directive">extends</span> Repository&lt;Person, <span class="predefined-type">Long</span>&gt; { <span class="error">…</span> }

<span class="annotation">@Entity</span>
<span class="annotation">@Node</span>
<span class="type">class</span> <span class="class">Person</span> { <span class="error">…</span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows a domain class using both JPA and Spring Data Neo4j⚡RX annotations.
It defines two repositories, <code>JpaPersonRepository</code> and <code>Neo4jPersonRepository</code>.
One is intended for JPA and the other for Neo4j usage.
Spring Data is no longer able to tell the repositories apart, which leads to undefined behavior.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="#repositories.multiple-modules.types">Repository type details</a> and <a href="#repositories.multiple-modules.annotations">distinguishing domain class annotations</a> are used for strict repository configuration
to identify repository candidates for a particular Spring Data module.
Using multiple persistence technology-specific annotations on the same domain type is possible and enables reuse of domain types across multiple persistence technologies.
However, Spring Data can then no longer determine a unique module with which to bind the repository.</p>
</div>
<div class="paragraph">
<p>The last way to distinguish repositories is by scoping repository base packages.
Base packages define the starting points for scanning for repository interface definitions, which implies having repository definitions located in the appropriate packages.</p>
</div>
<div class="paragraph">
<p>The following example shows annotation-driven configuration of base packages:</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Annotation-driven configuration of base packages</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableJpaRepositories</span>(basePackages = <span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.repositories.jpa</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@EnableNeo4jRepositories</span>(basePackages = <span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.repositories.neo4j</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">Config</span> {
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.query-methods.details"><a class="anchor" href="#repositories.query-methods.details"></a>6.4. Defining Query Methods</h3>
<div class="paragraph">
<p>The repository proxy has two ways to derive a store-specific query from the method name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By deriving the query from the method name directly.</p>
</li>
<li>
<p>By using a manually defined query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next section describes the available options.</p>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-lookup-strategies"><a class="anchor" href="#repositories.query-methods.query-lookup-strategies"></a>6.4.1. Query Lookup Strategies</h4>
<div class="paragraph">
<p>The following strategies are available for the repository infrastructure to resolve the query.
In your Java configuration, you can use the <code>queryLookupStrategy</code> attribute of the <code>EnableNeo4jRepositories</code> annotation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CREATE</code> attempts to construct a store-specific query from the query method name.
The general approach is to remove a given set of well known prefixes from the method name and parse the rest of the method.
You can read more about query construction in &#8220;<a href="#repositories.query-methods.query-creation">Section 6.4.2</a>&#8221;.</p>
</li>
<li>
<p><code>USE_DECLARED_QUERY</code> tries to find a declared query and throws an exception if cannot find one.
The query can be defined by an annotation somewhere or declared by other means.
Consult the documentation of the specific store to find available options for that store.
If the repository infrastructure does not find a declared query for the method at bootstrap time, it fails.</p>
</li>
<li>
<p><code>CREATE_IF_NOT_FOUND</code> (default) combines <code>CREATE</code> and <code>USE_DECLARED_QUERY</code>.
It looks up a declared query first, and, if no declared query is found, it creates a custom method name-based query.
This is the default lookup strategy and, thus, is used if you do not configure anything explicitly.
It allows quick query definition by method names but also custom-tuning of these queries by introducing declared queries as needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-creation"><a class="anchor" href="#repositories.query-methods.query-creation"></a>6.4.2. Query Creation</h4>
<div class="paragraph">
<p>The query builder mechanism built into Spring Data repository infrastructure is useful for building constraining queries over entities of the repository.
The mechanism strips the prefixes <code>find…By</code>, <code>read…By</code>, <code>query…By</code>, <code>count…By</code>, and <code>get…By</code> from the method and starts parsing the rest of it.
The introducing clause can contain further expressions, such as a <code>Distinct</code> to set a distinct flag on the query to be created.
However, the first <code>By</code> acts as delimiter to indicate the start of the actual criteria.
At a very basic level, you can define conditions on entity properties and concatenate them with <code>And</code> and <code>Or</code>.
The following example shows how to create a number of queries:</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Query creation from method names</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">PersonRepository</span> <span class="directive">extends</span> Repository&lt;Person, <span class="predefined-type">Long</span>&gt; {

  <span class="predefined-type">List</span>&lt;Person&gt; findByEmailAddressAndLastname(EmailAddress emailAddress, <span class="predefined-type">String</span> lastname);

  <span class="comment">// Enables the distinct flag for the query</span>
  <span class="predefined-type">List</span>&lt;Person&gt; findDistinctPeopleByLastnameOrFirstname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">String</span> firstname);
  <span class="predefined-type">List</span>&lt;Person&gt; findPeopleDistinctByLastnameOrFirstname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">String</span> firstname);

  <span class="comment">// Enabling ignoring case for an individual property</span>
  <span class="predefined-type">List</span>&lt;Person&gt; findByLastnameIgnoreCase(<span class="predefined-type">String</span> lastname);
  <span class="comment">// Enabling ignoring case for all suitable properties</span>
  <span class="predefined-type">List</span>&lt;Person&gt; findByLastnameAndFirstnameAllIgnoreCase(<span class="predefined-type">String</span> lastname, <span class="predefined-type">String</span> firstname);

  <span class="comment">// Enabling static ORDER BY for a query</span>
  <span class="predefined-type">List</span>&lt;Person&gt; findByLastnameOrderByFirstnameAsc(<span class="predefined-type">String</span> lastname);
  <span class="predefined-type">List</span>&lt;Person&gt; findByLastnameOrderByFirstnameDesc(<span class="predefined-type">String</span> lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are some general things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The expressions are usually property traversals combined with operators that can be concatenated.
You can combine property expressions with <code>AND</code> and <code>OR</code>.
You also get support for operators such as <code>Between</code>, <code>LessThan</code>, <code>GreaterThan</code>, and <code>Like</code> for the property expressions.</p>
</li>
<li>
<p>The method parser supports setting an <code>IgnoreCase</code> flag for individual properties (for example, <code>findByLastnameIgnoreCase(…)</code>)
or for all properties of a type that supports ignoring case (usually <code>String</code> instances&#8201;&#8212;&#8201;for example, <code>findByLastnameAndFirstnameAllIgnoreCase(…)</code>).</p>
</li>
<li>
<p>You can apply static ordering by appending an <code>OrderBy</code> clause to the query method that references a property and by providing a sorting direction (<code>Asc</code> or <code>Desc</code>).
To create a query method that supports dynamic sorting, see &#8220;<a href="#repositories.special-parameters">Section 6.4.4</a>&#8221;.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-property-expressions"><a class="anchor" href="#repositories.query-methods.query-property-expressions"></a>6.4.3. Property Expressions</h4>
<div class="paragraph">
<p>Property expressions can refer only to a direct property of the managed entity, as shown in the preceding example.
At query creation time, you already make sure that the parsed property is a property of the managed domain class.
However, you can also define constraints by traversing nested properties. Consider the following method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Person&gt; findByAddressZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assume a <code>Person</code> has an <code>Address</code> with a <code>ZipCode</code>.
In that case, the method creates the property traversal <code>x.address.zipCode</code>.
The resolution algorithm starts by interpreting the entire part (<code>AddressZipCode</code>) as the property and checks the domain class for a property with that name (uncapitalized).
If the algorithm succeeds, it uses that property.
If not, the algorithm splits up the source at the camel case parts from the right side into a head and a tail and tries to find the corresponding property&#8201;&#8212;&#8201;in our example, <code>AddressZip</code> and <code>Code</code>.
If the algorithm finds a property with that head, it takes the tail and continues building the tree down from there, splitting the tail up in the way just described.
If the first split does not match, the algorithm moves the split point to the left (<code>Address</code>, <code>ZipCode</code>) and continues.</p>
</div>
<div class="paragraph">
<p>Although this should work for most cases, it is possible for the algorithm to select the wrong property.
Suppose the <code>Person</code> class has an <code>addressZip</code> property as well.
The algorithm would match in the first split round already, choose the wrong property, and fail (as the type of <code>addressZip</code> probably has no <code>code</code> property).</p>
</div>
<div class="paragraph">
<p>To resolve this ambiguity you can use <code>_</code> inside your method name to manually define traversal points.
So our method name would be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Person&gt; findByAddress_ZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because we treat the underscore character as a reserved character, we strongly advise following standard Java naming conventions
(that is, not using underscores in property names but using camel case instead).</p>
</div>
</div>
<div class="sect3">
<h4 id="repositories.special-parameters"><a class="anchor" href="#repositories.special-parameters"></a>6.4.4. Special parameter handling</h4>
<div class="paragraph">
<p>To handle parameters in your query, define method parameters as already seen in the preceding examples.
Besides that, the infrastructure recognizes certain specific types like <code>Pageable</code> and <code>Sort</code>, to apply pagination and sorting to your queries dynamically.
The following example demonstrates these features:</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Using <code>Pageable</code>, <code>Slice</code>, and <code>Sort</code> in query methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Page&lt;User&gt; findByLastname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">Pageable</span> pageable);

Slice&lt;User&gt; findByLastname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">Pageable</span> pageable);

<span class="predefined-type">List</span>&lt;User&gt; findByLastname(<span class="predefined-type">String</span> lastname, Sort sort);

<span class="predefined-type">List</span>&lt;User&gt; findByLastname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">Pageable</span> pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
APIs taking <code>Sort</code> and <code>Pageable</code> expect non-<code>null</code> values to be handed into methods.
If you don&#8217;t want to apply any sorting or pagination use <code>Sort.unsorted()</code> and <code>Pageable.unpaged()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first method lets you pass an <code>org.springframework.data.domain.Pageable</code> instance to the query method to dynamically add paging to your statically defined query.
A <code>Page</code> knows about the total number of elements and pages available.
It does so by the infrastructure triggering a count query to calculate the overall number.
As this might be expensive (depending on the store used), you can instead return a <code>Slice</code>.
A <code>Slice</code> only knows about whether a next <code>Slice</code> is available, which might be sufficient when walking through a larger result set.</p>
</div>
<div class="paragraph">
<p>Sorting options are handled through the <code>Pageable</code> instance, too.
If you only need sorting, add an <code>org.springframework.data.domain.Sort</code> parameter to your method.
As you can see, returning a <code>List</code> is also possible.
In this case, the additional metadata required to build the actual <code>Page</code> instance is not created
(which, in turn, means that the additional count query that would have been necessary is not issued).
Rather, it restricts the query to look up only the given range of entities.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To find out how many pages you get for an entire query, you have to trigger an additional count query.
      By default, this query is derived from the query you actually trigger.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="repositories.paging-and-sorting"><a class="anchor" href="#repositories.paging-and-sorting"></a>Paging and Sorting</h5>
<div class="paragraph">
<p>Simple sorting expressions can be defined by using property names.
Expressions can be concatenated to collect multiple criterias into one expression.</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Defining sort expressions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sort sort = Sort.by(<span class="string"><span class="delimiter">&quot;</span><span class="content">firstname</span><span class="delimiter">&quot;</span></span>).ascending()
  .and(Sort.by(<span class="string"><span class="delimiter">&quot;</span><span class="content">lastname</span><span class="delimiter">&quot;</span></span>).descending());</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For a more type-safe way of defining sort expressions, start with the type to define the sort expression for and use method references to define the properties to sort on.</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Defining sort expressions using the type-safe API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedSort&lt;Person&gt; person = Sort.sort(Person.class);

TypedSort&lt;Person&gt; sort = person.by(Person::getFirstname).ascending()
  .and(person.by(Person::getLastname).descending());</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.limit-query-result"><a class="anchor" href="#repositories.limit-query-result"></a>6.4.5. Limiting Query Results</h4>
<div class="paragraph">
<p>The results of query methods can be limited by using the <code>first</code> or <code>top</code> keywords, which can be used interchangeably.
An optional numeric value can be appended to <code>top</code> or <code>first</code> to specify the maximum result size to be returned.
If the number is left out, a result size of 1 is assumed.
The following example shows how to limit the query size:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Limiting the result size of a query with <code>Top</code> and <code>First</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">User findFirstByOrderByLastnameAsc();

User findTopByOrderByAgeDesc();

Page&lt;User&gt; queryFirst10ByLastname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">Pageable</span> pageable);

Slice&lt;User&gt; findTop3ByLastname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">Pageable</span> pageable);

<span class="predefined-type">List</span>&lt;User&gt; findFirst10ByLastname(<span class="predefined-type">String</span> lastname, Sort sort);

<span class="predefined-type">List</span>&lt;User&gt; findTop10ByLastname(<span class="predefined-type">String</span> lastname, <span class="predefined-type">Pageable</span> pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The limiting expressions also support the <code>Distinct</code> keyword.
Also, for the queries limiting the result set to one instance, wrapping the result into with the <code>Optional</code> keyword is supported.</p>
</div>
<div class="paragraph">
<p>If pagination or slicing is applied to a limiting query pagination (and the calculation of the number of pages available), it is applied within the limited result.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Limiting the results in combination with dynamic sorting by using a <code>Sort</code> parameter lets you express query methods for the 'K' smallest as well as for the 'K' biggest elements.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.collections-and-iterables"><a class="anchor" href="#repositories.collections-and-iterables"></a>6.4.6. Repository Methods Returning Collections or Iterables</h4>
<div class="paragraph">
<p>Query methods that return multiple results can use standard Java <code>Iterable</code>, <code>List</code>, <code>Set</code>.
Beyond that we support returning Spring Data&#8217;s <code>Streamable</code>, a custom extension of <code>Iterable</code>, as well as collection types provided by <a href="https://www.vavr.io/">Vavr</a>.</p>
</div>
<div class="sect4">
<h5 id="repositories.collections-and-iterables.streamable"><a class="anchor" href="#repositories.collections-and-iterables.streamable"></a>Using Streamable as Query Method Return Type</h5>
<div class="paragraph">
<p><code>Streamable</code> can be used as alternative to <code>Iterable</code> or any collection type.
It provides convenience methods to access a non-parallel <code>Stream</code> (missing from <code>Iterable</code>), the ability to directly <code>….filter(…)</code> and <code>….map(…)</code> over the elements and concatenate the <code>Streamable</code> to others:</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Using Streamable to combine query method results</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">PersonRepository</span> <span class="directive">extends</span> Repository&lt;Person, <span class="predefined-type">Long</span>&gt; {
  Streamable&lt;Person&gt; findByFirstnameContaining(<span class="predefined-type">String</span> firstname);
  Streamable&lt;Person&gt; findByLastnameContaining(<span class="predefined-type">String</span> lastname);
}

Streamable&lt;Person&gt; result = repository.findByFirstnameContaining(<span class="string"><span class="delimiter">&quot;</span><span class="content">av</span><span class="delimiter">&quot;</span></span>)
  .and(repository.findByLastnameContaining(<span class="string"><span class="delimiter">&quot;</span><span class="content">ea</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.collections-and-iterables.streamable-wrapper"><a class="anchor" href="#repositories.collections-and-iterables.streamable-wrapper"></a>Returning Custom Streamable Wrapper Types</h5>
<div class="paragraph">
<p>Providing dedicated wrapper types for collections is a commonly used pattern to provide API on a query execution result that returns multiple elements.
Usually these types are used by invoking a repository method returning a collection-like type and creating an instance of the wrapper type manually.
That additional step can be avoided as Spring Data allows to use these wrapper types as query method return types if they meet the following criterias:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The type implements <code>Streamable</code>.</p>
</li>
<li>
<p>The type exposes either a constructor or a static factory method named <code>of(…)</code> or <code>valueOf(…)</code> taking <code>Streamable</code> as argument.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A sample use case looks as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Product</span> { <i class="conum" data-value="1"></i><b>(1)</b>
  MonetaryAmount getPrice() { <span class="error">…</span> }
}

<span class="annotation">@RequiredArgConstructor</span>(staticName = <span class="string"><span class="delimiter">&quot;</span><span class="content">of</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">Products</span> <span class="directive">implements</span> Streamable&lt;Product&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="directive">private</span> Streamable&lt;Product&gt; streamable;

  <span class="directive">public</span> MonetaryAmount getTotal() { <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="keyword">return</span> streamable.stream() <span class="comment">//</span>
      .map(Priced::getPrice)
      .reduce(Money.of(<span class="integer">0</span>), MonetaryAmount::add);
  }
}

<span class="type">interface</span> <span class="class">ProductRepository</span> <span class="directive">implements</span> Repository&lt;Product, <span class="predefined-type">Long</span>&gt; {
  Products findAllByDescriptionContaining(<span class="predefined-type">String</span> text); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A <code>Product</code> entity that exposes API to access the product&#8217;s price.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A wrapper type for a <code>Streamable&lt;Product&gt;</code> that can be constructed via <code>Products.of(…)</code> (factory method created via the Lombok annotation).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The wrapper type exposes additional API calculating new values on the <code>Streamable&lt;Product&gt;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>That wrapper type can be used as query method return type directly. No need to return <code>Stremable&lt;Product&gt;</code> and manually wrap it in the repository client.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.collections-and-iterables.vavr"><a class="anchor" href="#repositories.collections-and-iterables.vavr"></a>Support for Vavr Collections</h5>
<div class="paragraph">
<p><a href="https://www.vavr.io/">Vavr</a> is a library to embrace functional programming concepts in Java.
It ships with a custom set of collection types that can be used as query method return types.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Vavr collection type</th>
<th class="tableblock halign-left valign-top">Used Vavr implementation type</th>
<th class="tableblock halign-left valign-top">Valid Java source types</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.Seq</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.List</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Iterable</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.Set</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.LinkedHashSet</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Iterable</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.Map</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.LinkedHashMap</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Map</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The types in the first column (or subtypes thereof) can be used as quer method return types and will get the types in the second column
used as implementation type depending on the Java type of the actual query result (third column).
Alternatively, <code>Traversable</code> (Vavr the <code>Iterable</code> equivalent) can be declared and we derive the implementation class
from the actual return value, i.e. a <code>java.util.List</code> will be turned into a Vavr <code>List</code>/<code>Seq</code>, a <code>java.util.Set</code> becomes a Vavr <code>LinkedHashSet</code>/<code>Set</code> etc.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.nullability"><a class="anchor" href="#repositories.nullability"></a>6.4.7. Null Handling of Repository Methods</h4>
<div class="paragraph">
<p>As of Spring Data 2.0, repository CRUD methods that return an individual aggregate instance use Java 8&#8217;s <code>Optional</code> to indicate the potential absence of a value.
Besides that, Spring Data supports returning the following wrapper types on query methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.google.common.base.Optional</code></p>
</li>
<li>
<p><code>scala.Option</code></p>
</li>
<li>
<p><code>io.vavr.control.Option</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alternatively, query methods can choose not to use a wrapper type at all.
The absence of a query result is then indicated by returning <code>null</code>.
Repository methods returning collections, collection alternatives, wrappers, and streams are guaranteed never to return <code>null</code> but rather the corresponding empty representation.
See &#8220;<a href="#repository-query-return-types">Repository query return types</a>&#8221; for details.</p>
</div>
<div class="sect4">
<h5 id="repositories.nullability.annotations"><a class="anchor" href="#repositories.nullability.annotations"></a>Nullability Annotations</h5>
<div class="paragraph">
<p>You can express nullability constraints for repository methods by using <a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/core.html#null-safety">Spring Framework&#8217;s nullability annotations</a>.
They provide a tooling-friendly approach and opt-in <code>null</code> checks during runtime, as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/javadoc-api/org/springframework/lang/NonNullApi.html"><code>@NonNullApi</code></a>:
Used on the package level to declare that the default behavior for parameters and return values is to not accept or produce <code>null</code> values.</p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/javadoc-api/org/springframework/lang/NonNull.html"><code>@NonNull</code></a>:
 Used on a parameter or return value that must not be <code>null</code>
(not needed on a parameter and return value where <code>@NonNullApi</code> applies).</p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/javadoc-api/org/springframework/lang/Nullable.html"><code>@Nullable</code></a>:
Used on a parameter or return value that can be <code>null</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring annotations are meta-annotated with <a href="https://jcp.org/en/jsr/detail?id=305">JSR 305</a> annotations (a dormant but widely spread JSR).
JSR 305 meta-annotations let tooling vendors such as <a href="https://www.jetbrains.com/help/idea/nullable-and-notnull-annotations.html">IDEA</a>, <a href="https://help.eclipse.org/oxygen/index.jsp?topic=/org.eclipse.jdt.doc.user/tasks/task-using_external_null_annotations.htm">Eclipse</a>, and <a href="https://kotlinlang.org/docs/reference/java-interop.html#null-safety-and-platform-types">Kotlin</a> provide null-safety support in a generic way, without having to hard-code support for Spring annotations.
To enable runtime checking of nullability constraints for query methods, you need to activate non-nullability on the package level by using Spring’s <code>@NonNullApi</code> in <code>package-info.java</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Declaring Non-nullability in <code>package-info.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@org</span>.springframework.lang.NonNullApi
<span class="keyword">package</span> <span class="namespace">com.acme</span>;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once non-null defaulting is in place, repository query method invocations get validated at runtime for nullability constraints.
If a query execution result violates the defined constraint, an exception is thrown.
This happens when the method would return <code>null</code> but is declared as non-nullable (the default with the annotation defined on the package the repository resides in).
If you want to opt-in to nullable results again, selectively use <code>@Nullable</code> on individual methods.
Using the result wrapper types mentioned at the start of this section continues to work as expected: An empty result is translated into the value that represents absence.</p>
</div>
<div class="paragraph">
<p>The following example shows a number of the techniques just described:</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. Using different nullability constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.acme</span>;                                                       <i class="conum" data-value="1"></i><b>(1)</b>

<span class="keyword">import</span> <span class="include">org.springframework.lang.Nullable</span>;

<span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> Repository&lt;User, <span class="predefined-type">Long</span>&gt; {

  User getByEmailAddress(EmailAddress emailAddress);                    <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="annotation">@Nullable</span>
  User findByEmailAddress(<span class="annotation">@Nullable</span> EmailAddress emailAdress);          <i class="conum" data-value="3"></i><b>(3)</b>

  Optional&lt;User&gt; findOptionalByEmailAddress(EmailAddress emailAddress); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The repository resides in a package (or sub-package) for which we have defined non-null behavior.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Throws an <code>EmptyResultDataAccessException</code> when the query executed does not produce a result.
Throws an <code>IllegalArgumentException</code> when the <code>emailAddress</code> handed to the method is <code>null</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns <code>null</code> when the query executed does not produce a result.
Also accepts <code>null</code> as the value for <code>emailAddress</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns <code>Optional.empty()</code> when the query executed does not produce a result.
Throws an <code>IllegalArgumentException</code> when the <code>emailAddress</code> handed to the method is <code>null</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.nullability.kotlin"><a class="anchor" href="#repositories.nullability.kotlin"></a>Nullability in Kotlin-based Repositories</h5>
<div class="paragraph">
<p>Kotlin has the definition of <a href="https://kotlinlang.org/docs/reference/null-safety.html">nullability constraints</a> baked into the language.
Kotlin code compiles to bytecode, which does not express nullability constraints through method signatures but rather through compiled-in metadata.
Make sure to include the <code>kotlin-reflect</code> JAR in your project to enable introspection of Kotlin&#8217;s nullability constraints.
Spring Data repositories use the language mechanism to define those constraints to apply the same runtime checks, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Using nullability constraints on Kotlin repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">interface UserRepository : Repository&lt;User, String&gt; {

  fun findByUsername(username: String): User     <i class="conum" data-value="1"></i><b>(1)</b>

  fun findByFirstname(firstname: String?): User? <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The method defines both the parameter and the result as non-nullable (the Kotlin default).
The Kotlin compiler rejects method invocations that pass <code>null</code> to the method.
If the query execution yields an empty result, an <code>EmptyResultDataAccessException</code> is thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This method accepts <code>null</code> for the <code>firstname</code> parameter and returns <code>null</code> if the query execution does not produce a result.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-streaming"><a class="anchor" href="#repositories.query-streaming"></a>6.4.8. Streaming query results</h4>
<div class="paragraph">
<p>The results of query methods can be processed incrementally by using a Java 8 <code>Stream&lt;T&gt;</code> as return type.
Instead of wrapping the query results in a <code>Stream</code> data store-specific methods are used to perform the streaming, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Stream the result of a query with Java 8 <code>Stream&lt;T&gt;</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (u:User) RETURN u</span><span class="delimiter">&quot;</span></span>)
Stream&lt;User&gt; findAllByCustomQueryAndStream();

Stream&lt;User&gt; readAllByFirstnameNotNull();

<span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (u:User) RETURN u)
Stream&lt;User&gt; streamAllPaged(Pageable pageable);</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A <code>Stream</code> potentially wraps underlying data store-specific resources and must, therefore, be closed after usage.
      You can either manually close the <code>Stream</code> by using the <code>close()</code> method or by using a Java 7 <code>try-with-resources</code> block, as shown in the following example:
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 31. Working with a <code>Stream&lt;T&gt;</code> result in a try-with-resources block</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Stream&lt;User&gt; stream = repository.findAllByCustomQueryAndStream()) {
  stream.forEach(<span class="error">…</span>);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not all Spring Data modules currently support <code>Stream&lt;T&gt;</code> as a return type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-async"><a class="anchor" href="#repositories.query-async"></a>6.4.9. Async query results</h4>
<div class="paragraph">
<p>Repository queries can be run asynchronously by using <a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/integration.html#scheduling">Spring&#8217;s asynchronous method execution capability</a>.
This means the method returns immediately upon invocation while the actual query execution occurs in a task that has been submitted to a Spring <code>TaskExecutor</code>.
Asynchronous query execution is different from reactive query execution and should not be mixed.
Refer to store-specific documentation for more details on reactive support.
The following example shows a number of asynchronous queries:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Async</span>
<span class="predefined-type">Future</span>&lt;User&gt; findByFirstname(<span class="predefined-type">String</span> firstname);               <i class="conum" data-value="1"></i><b>(1)</b>

<span class="annotation">@Async</span>
CompletableFuture&lt;User&gt; findOneByFirstname(<span class="predefined-type">String</span> firstname); <i class="conum" data-value="2"></i><b>(2)</b>

<span class="annotation">@Async</span>
ListenableFuture&lt;User&gt; findOneByLastname(<span class="predefined-type">String</span> lastname);    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>java.util.concurrent.Future</code> as the return type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a Java 8 <code>java.util.concurrent.CompletableFuture</code> as the return type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use a <code>org.springframework.util.concurrent.ListenableFuture</code> as the return type.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.create-instances"><a class="anchor" href="#repositories.create-instances"></a>6.5. Creating Repository Instances</h3>
<div class="paragraph">
<p>In this section, you create instances and bean definitions for the defined repository interfaces.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section is only relevant if you don&#8217;t work in a Spring Boot scenario.
      SDN/RX provides dedicated support for Spring Boot, including automatic configuration of
      the Neo4j driver, Repositories and entity scanning.
     <br>
      Please be aware that SDN/RX does not support XML based Spring configuration.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="repositories.create-instances.java-config"><a class="anchor" href="#repositories.create-instances.java-config"></a>6.5.1. JavaConfig</h4>
<div class="paragraph">
<p>The repository infrastructure is triggered by using either <code>@EnableNeo4jRepositories</code> or <code>EnableReactiveNeo4jRepositories</code> annotation on a JavaConfig class.
For an introduction into Java-based configuration of the Spring container, see <a href="https://docs.spring.io/spring/docs/5.2.0.RELEASE/spring-framework-reference/core.html#beans-java">JavaConfig in the Spring reference documentation</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
While the Neo4j driver contains support for blocking and reactive programming in one single jar,
         blocking and reactive programming style should not be mixed in one application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A sample configuration to enable Spring Data Neo4j repositories resembles the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. Sample annotation based repository configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.Collection</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.driver.AuthTokens</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Driver</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.GraphDatabase</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.config.AbstractNeo4jConfig</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.repository.config.EnableNeo4jRepositories</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Bean</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.transaction.annotation.EnableTransactionManagement</span>;

<span class="annotation">@Configuration</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@EnableNeo4jRepositories</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@EnableTransactionManagement</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> <span class="directive">extends</span> AbstractNeo4jConfig { <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> <span class="predefined-type">Driver</span> driver() { <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="keyword">return</span> GraphDatabase.driver(<span class="string"><span class="delimiter">&quot;</span><span class="content">bolt://localhost:7687</span><span class="delimiter">&quot;</span></span>, AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>));
        }

        <span class="annotation">@Override</span>
        <span class="directive">protected</span> <span class="predefined-type">Collection</span>&lt;<span class="predefined-type">String</span>&gt; getMappingBasePackages() { <i class="conum" data-value="6"></i><b>(6)</b>
                <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">your.domain.package</span><span class="delimiter">&quot;</span></span>);
        }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mark this as a Spring Configuration class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable imperative Neo4j repositories</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Enable transactions</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>AbstractNeo4jConfig</code> provides all the beans needed for SDN/RX to work</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Provide a connection to the database</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This is optional: Preconfigure the list of packages where SDN/RX should look for <code>@Node</code>-annotated classes</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration of reactive repositories looks very similar:</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. Sample annotation based reactive repository configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.driver.AuthTokens</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Driver</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.GraphDatabase</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.config.AbstractReactiveNeo4jConfig</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.repository.config.EnableReactiveNeo4jRepositories</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Bean</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.transaction.annotation.EnableTransactionManagement</span>;

<span class="annotation">@Configuration</span>
<span class="annotation">@EnableReactiveNeo4jRepositories</span>
<span class="annotation">@EnableTransactionManagement</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ReactiveConfig</span> <span class="directive">extends</span> AbstractReactiveNeo4jConfig {

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> <span class="predefined-type">Driver</span> driver() {
                <span class="keyword">return</span> GraphDatabase.driver(<span class="string"><span class="delimiter">&quot;</span><span class="content">bolt://localhost:7687</span><span class="delimiter">&quot;</span></span>, AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>));
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The driver has the same type.
Please note that you need at least Neo4j 4.0 to use the reactive sessions provided by the driver.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.custom-implementations"><a class="anchor" href="#repositories.custom-implementations"></a>6.6. Custom Implementations for Spring Data Repositories</h3>
<div class="paragraph">
<p>This section covers repository customization and how fragments form a composite repository.</p>
</div>
<div class="paragraph">
<p>When a query method requires a different behavior or cannot be implemented by query derivation, then it is necessary to provide a custom implementation.
Spring Data repositories let you provide custom repository code and integrate it with generic CRUD abstraction and query method functionality.</p>
</div>
<div class="sect3">
<h4 id="repositories.single-repository-behavior"><a class="anchor" href="#repositories.single-repository-behavior"></a>6.6.1. Customizing Individual Repositories</h4>
<div class="paragraph">
<p>To enrich a repository with custom functionality, you must first define a fragment interface and an implementation for the custom functionality, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Interface for custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">CustomizedUserRepository</span> {
  <span class="type">void</span> someCustomMethod(User user);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then you can let your repository interface additionally extend from the fragment interface, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Implementation of custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">CustomizedUserRepositoryImpl</span> <span class="directive">implements</span> CustomizedUserRepository {

  <span class="directive">public</span> <span class="type">void</span> someCustomMethod(User user) {
    <span class="comment">// Your custom implementation</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The most important part of the class name that corresponds to the fragment interface is the <code>Impl</code> postfix.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation itself does not depend on Spring Data and can be a regular Spring bean.
Consequently, you can use standard dependency injection behavior to inject references to other beans
(such as a <code>Neo4jClient</code> or the <code>Neo4jTemplate</code>), take part in aspects, and so on.</p>
</div>
<div class="paragraph">
<p>You can let your repository interface extend the fragment interface, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. Changes to your repository interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> CrudRepository&lt;User, <span class="predefined-type">Long</span>&gt;, CustomizedUserRepository {

  <span class="comment">// Declare query methods here</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Extending the fragment interface with your repository interface combines the CRUD and custom functionality and makes it available to clients.</p>
</div>
<div class="paragraph">
<p>Spring Data repositories are implemented by using fragments that form a repository composition.
Fragments are the base repository, functional aspects and custom interfaces along with their implementation.
Each time you add an interface to your repository interface, you enhance the composition by adding a fragment.
The base repository and repository aspect implementations are provided by each Spring Data module.</p>
</div>
<div class="paragraph">
<p>The following example shows custom interfaces and their implementations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 37. Fragments with their implementations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">HumanRepository</span> {
  <span class="type">void</span> someHumanMethod(User user);
}

<span class="type">class</span> <span class="class">HumanRepositoryImpl</span> <span class="directive">implements</span> HumanRepository {

  <span class="directive">public</span> <span class="type">void</span> someHumanMethod(User user) {
    <span class="comment">// Your custom implementation</span>
  }
}

<span class="type">interface</span> <span class="class">ContactRepository</span> {

  <span class="type">void</span> someContactMethod(User user);

  User anotherContactMethod(User user);
}

<span class="type">class</span> <span class="class">ContactRepositoryImpl</span> <span class="directive">implements</span> ContactRepository {

  <span class="directive">public</span> <span class="type">void</span> someContactMethod(User user) {
    <span class="comment">// Your custom implementation</span>
  }

  <span class="directive">public</span> User anotherContactMethod(User user) {
    <span class="comment">// Your custom implementation</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows the interface for a custom repository that extends <code>CrudRepository</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. Changes to your repository interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> CrudRepository&lt;User, <span class="predefined-type">Long</span>&gt;, HumanRepository, ContactRepository {

  <span class="comment">// Declare query methods here</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Repositories may be composed of multiple custom implementations that are imported in the order of their declaration.
Custom implementations have a higher priority than the base implementation and repository aspects.
This ordering lets you override base repository and aspect methods and resolves ambiguity if two fragments contribute the same method signature.
Repository fragments are not limited to use in a single repository interface.
Multiple repositories may use a fragment interface, letting you reuse customizations across different repositories.</p>
</div>
<div class="paragraph">
<p>The following example shows a repository fragment and its implementation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 39. Fragments overriding <code>save(…)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">CustomizedSave</span>&lt;T&gt; {
  &lt;S <span class="directive">extends</span> T&gt; S save(S entity);
}

<span class="type">class</span> <span class="class">CustomizedSaveImpl</span>&lt;T&gt; <span class="directive">implements</span> CustomizedSave&lt;T&gt; {

  <span class="directive">public</span> &lt;S <span class="directive">extends</span> T&gt; S save(S entity) {
    <span class="comment">// Your custom implementation</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses the preceding repository fragment:</p>
</div>
<div class="exampleblock">
<div class="title">Example 40. Customized repository interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> CrudRepository&lt;User, <span class="predefined-type">Long</span>&gt;, CustomizedSave&lt;User&gt; {
}

<span class="type">interface</span> <span class="class">PersonRepository</span> <span class="directive">extends</span> CrudRepository&lt;Person, <span class="predefined-type">Long</span>&gt;, CustomizedSave&lt;Person&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h5>
<div class="paragraph">
<p>The repository infrastructure tries to autodetect custom implementation fragments by scanning for classes below the package in which it found a repository.
These classes need to follow the naming convention of appending the store&#8217;s <code>repositoryImplementationPostfix</code> attribute to the fragment interface name.
This postfix defaults to <code>Impl</code>.
The following example shows a configuration changing the default postfix to <code>MyPostfix</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 41. Configuration example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.repository.config.EnableNeo4jRepositories</span>;

<span class="annotation">@EnableNeo4jRepositories</span>(repositoryImplementationPostfix = <span class="string"><span class="delimiter">&quot;</span><span class="content">MyPostfix</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomFragmentPostfix</span> {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>With this configuration, SDN/RX tries to look up a class called <code>com.acme.repository.CustomizedUserRepositoryMyPostfix</code> to act as a custom repository implementation.</p>
</div>
<div class="sect5">
<h6 id="repositories.single-repository-behaviour.ambiguity"><a class="anchor" href="#repositories.single-repository-behaviour.ambiguity"></a>Resolution of Ambiguity</h6>
<div class="paragraph">
<p>If multiple implementations with matching class names are found in different packages, Spring Data uses the bean names to identify which one to use.</p>
</div>
<div class="paragraph">
<p>Given the following two custom implementations for the <code>CustomizedUserRepository</code> shown earlier, the first implementation is used.
Its bean name is <code>customizedUserRepositoryImpl</code>, which matches that of the fragment interface (<code>CustomizedUserRepository</code>) plus the postfix <code>Impl</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 42. Resolution of ambiguous implementations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.acme.impl.one</span>;

<span class="type">class</span> <span class="class">CustomizedUserRepositoryImpl</span> <span class="directive">implements</span> CustomizedUserRepository {

  <span class="comment">// Your custom implementation</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.acme.impl.two</span>;

<span class="annotation">@Component</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">specialCustomImpl</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">CustomizedUserRepositoryImpl</span> <span class="directive">implements</span> CustomizedUserRepository {

  <span class="comment">// Your custom implementation</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you annotate the <code>UserRepository</code> interface with <code>@Component("specialCustom")</code>, the bean name plus <code>Impl</code> then matches the one
defined for the repository implementation in <code>com.acme.impl.two</code>, and it is used instead of the first one.</p>
</div>
</div>
<div class="sect5">
<h6 id="repositories.manual-wiring"><a class="anchor" href="#repositories.manual-wiring"></a>Manual Wiring</h6>
<div class="paragraph">
<p>If your custom implementation uses annotation-based configuration and autowiring only, the preceding approach shown works well,
because it is treated as any other Spring bean.
If your implementation fragment bean needs special wiring, you can declare the bean and name it according to the conventions
described in the <a href="#repositories.single-repository-behaviour.ambiguity">preceding section</a>.
The infrastructure then refers to the manually defined bean definition by name instead of creating one itself.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.customize-base-repository"><a class="anchor" href="#repositories.customize-base-repository"></a>6.6.2. Customize the Base Repository</h4>
<div class="paragraph">
<p>The approach described in the <a href="#repositories.manual-wiring">preceding section</a> requires customization of each repository interfaces
when you want to customize the base repository behavior so that all repositories are affected.
To change behavior for all repositories instead, you can create an implementation that extends the repository base class.
This class then acts as a custom base class for the repository proxies, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 43. Custom repository base class</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyRepositoryImpl</span>&lt;T, ID&gt; <span class="directive">extends</span> SimpleNeo4jRepository&lt;T, ID&gt; {

        MyRepositoryImpl(
                Neo4jOperations neo4jOperations,
                Neo4jEntityInformation&lt;T, ID&gt; entityInformation
        ) {
                <span class="local-variable">super</span>(neo4jOperations, entityInformation);
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">List</span>&lt;T&gt; findAll() {
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">This implementation does not support `findAll`.</span><span class="delimiter">&quot;</span></span>);
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The class needs to have a constructor matching <code>SimpleNeo4jRepository</code> or <code>SimpleReactiveNeo4jRepository</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The final step is to make the Spring Data infrastructure aware of the customized repository base class.
In Java configuration, you can do so by using the <code>repositoryBaseClass</code> attribute of the <code>@Enable$Neo4jRepositories</code> annotation, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 44. Configuring a custom repository base class using JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableNeo4jRepositories</span>(repositoryBaseClass = MyRepositoryImpl.class)
<span class="annotation">@EnableTransactionManagement</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> <span class="directive">extends</span> AbstractNeo4jConfig {

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> <span class="predefined-type">Driver</span> driver() {
                <span class="keyword">return</span> GraphDatabase
                        .driver(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j://localhost:7687</span><span class="delimiter">&quot;</span></span>, AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>));
        }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core.domain-events"><a class="anchor" href="#core.domain-events"></a>6.7. Publishing Events from Aggregate Roots</h3>
<div class="paragraph">
<p>Entities managed by repositories are aggregate roots.
In a Domain-Driven Design application, these aggregate roots usually publish domain events.
Spring Data provides an annotation called <code>@DomainEvents</code> that you can use on a method of your aggregate root to make that publication as easy as possible, as shown in the following example.</p>
</div>
<div class="paragraph">
<p>First, define a custom event:</p>
</div>
<div class="exampleblock">
<div class="title">Example 45. Defining a custom domain event:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.time.LocalDateTime</span>;

<span class="keyword">import</span> <span class="include">org.springframework.context.ApplicationEvent</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SomeEvent</span> <span class="directive">extends</span> ApplicationEvent { <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="directive">private</span> <span class="directive">final</span> LocalDateTime changeHappenedAt = LocalDateTime.now();

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> oldValue;

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> newValue;

        <span class="directive">public</span> SomeEvent(AnAggregateRoot source, <span class="predefined-type">String</span> oldValue, <span class="predefined-type">String</span> newValue) {
                <span class="local-variable">super</span>(source);
                <span class="local-variable">this</span>.oldValue = oldValue;
                <span class="local-variable">this</span>.newValue = newValue;
        }

        <span class="comment">// Getters omitted...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You have to inherit from Spring&#8217;s <code>ApplicationEvent</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The next step is to expose these events from a <code>@Node</code> entity:</p>
</div>
<div class="exampleblock">
<div class="title">Example 46. Exposing domain events from an aggregate root</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.Collection</span>;
<span class="keyword">import</span> <span class="include">java.util.Collections</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Id</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.schema.Node</span>;
<span class="keyword">import</span> <span class="include">org.springframework.data.annotation.Transient</span>;
<span class="keyword">import</span> <span class="include">org.springframework.data.domain.AfterDomainEventPublication</span>;
<span class="keyword">import</span> <span class="include">org.springframework.data.domain.DomainEvents</span>;

<span class="annotation">@Node</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AnAggregateRoot</span> {

        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> name;

        <span class="directive">private</span> <span class="predefined-type">String</span> someOtherValue;

        <span class="annotation">@Transient</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Collection</span>&lt;SomeEvent&gt; events = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="directive">public</span> AnAggregateRoot(<span class="predefined-type">String</span> name) {
                <span class="local-variable">this</span>.name = name;
        }

        <span class="directive">public</span> <span class="type">void</span> setSomeOtherValue(<span class="predefined-type">String</span> someOtherValue) {
                <span class="local-variable">this</span>.events.add(<span class="keyword">new</span> SomeEvent(<span class="local-variable">this</span>, <span class="local-variable">this</span>.someOtherValue, someOtherValue)); <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="local-variable">this</span>.someOtherValue = someOtherValue;
        }

        <span class="annotation">@DomainEvents</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">Collection</span>&lt;SomeEvent&gt; domainEvents() {
                <span class="keyword">return</span> <span class="predefined-type">Collections</span>.unmodifiableCollection(events);
        }

        <span class="annotation">@AfterDomainEventPublication</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="type">void</span> callbackMethod() {
                <span class="local-variable">this</span>.events.clear();
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Store your events in a collection and mark that collection as <code>@Transient</code> so that those events are not treated as a relationship to be stored</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Whenever you need to log an event, add it to the events collection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Mark one method with <code>@DomainEvents</code>. The method must not take any arguments and can return either a single event instance or a collection of events.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After all events have been published, we have a method annotated with <code>@AfterDomainEventPublication</code>. It can be used to potentially clean the list of events to be published (among other uses).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The methods are called every time one of a Spring Data repository&#8217;s <code>save(…)</code> methods is called as shown in the following snippets:</p>
</div>
<div class="exampleblock">
<div class="title">Example 47. Store the aggregate root via standard repository calls</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.boot.test.autoconfigure.data.DataNeo4jTest</span>;
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;

<span class="annotation">@DataNeo4jTest</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">DomainEventsTest</span> {

        <span class="directive">private</span> <span class="directive">final</span> ARepository aRepository;

        <span class="annotation">@Autowired</span>
        <span class="directive">public</span> DomainEventsTest(ARepository aRepository) {
                <span class="local-variable">this</span>.aRepository = aRepository;
                <span class="local-variable">this</span>.aRepository.save(<span class="keyword">new</span> AnAggregateRoot(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Root</span><span class="delimiter">&quot;</span></span>));
        }

        <span class="annotation">@Test</span>
        <span class="type">void</span> domainEventsShouldWork() {

                <span class="local-variable">this</span>.aRepository.findByName(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Root</span><span class="delimiter">&quot;</span></span>).ifPresent(anAggregateRoot -&gt; {
                        anAggregateRoot.setSomeOtherValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">A new value</span><span class="delimiter">&quot;</span></span>);
                        anAggregateRoot.setSomeOtherValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">Even newer value</span><span class="delimiter">&quot;</span></span>);
                        <span class="local-variable">this</span>.aRepository.save(anAggregateRoot);
                });
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To react on this events, register a standard Spring <code>ApplicationListener</code>, typed to your event:</p>
</div>
<div class="exampleblock">
<div class="title">Example 48. Create a custom event listener</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
ApplicationListener&lt;SomeEvent&gt; someEventListener() {
        <span class="keyword">return</span> event -&gt; <span class="predefined-type">System</span>.out.println(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">someOtherValue changed from '</span><span class="delimiter">&quot;</span></span> + event.getOldValue() + <span class="string"><span class="delimiter">&quot;</span><span class="content">' to '</span><span class="delimiter">&quot;</span></span> + event.getNewValue() + <span class="string"><span class="delimiter">&quot;</span><span class="content">' at </span><span class="delimiter">&quot;</span></span> + event
                        .getChangeHappenedAt());
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core.extensions"><a class="anchor" href="#core.extensions"></a>6.8. Spring Data Extensions</h3>
<div class="paragraph">
<p>This section documents a set of Spring Data extensions that enable Spring Data usage in a variety of contexts.
Currently, most of the integration is targeted towards Spring MVC.</p>
</div>
<div class="sect3">
<h4 id="core.web"><a class="anchor" href="#core.web"></a>6.8.1. Web support</h4>
<div class="paragraph">
<p>Spring Data modules that support the repository programming model ship with a variety of web support.
The web related components require Spring MVC JARs to be on the classpath.
Some of them even provide integration with <a href="https://github.com/SpringSource/spring-hateoas">Spring HATEOAS</a>.
In general, the integration support is enabled by using the <code>@EnableSpringDataWebSupport</code> annotation in your JavaConfig configuration class, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 49. Enabling Spring Data web support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="annotation">@EnableWebMvc</span>
<span class="annotation">@EnableSpringDataWebSupport</span>
<span class="type">class</span> <span class="class">WebConfiguration</span> {}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@EnableSpringDataWebSupport</code> annotation registers a few components we will discuss in a bit.
It will also detect Spring HATEOAS on the classpath and register integration components for it as well if present.</p>
</div>
<div class="sect4">
<h5 id="core.web.basic"><a class="anchor" href="#core.web.basic"></a>Basic Web Support</h5>
<div class="paragraph">
<p>The configuration shown in the <a href="#core.web">previous section</a> registers a few basic components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <a href="#core.web.basic.domain-class-converter">Section 6.8.1.1.1</a> to let Spring MVC resolve instances of repository-managed domain classes from request parameters or path variables.</p>
</li>
<li>
<p><a href="#core.web.basic.paging-and-sorting"><code>HandlerMethodArgumentResolver</code></a> implementations to let Spring MVC resolve <code>Pageable</code> and <code>Sort</code> instances from request parameters.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="core.web.basic.domain-class-converter"><a class="anchor" href="#core.web.basic.domain-class-converter"></a><code>DomainClassConverter</code></h6>
<div class="paragraph">
<p>The <code>DomainClassConverter</code> lets you use domain types in your Spring MVC controller method signatures directly,
so that you need not manually lookup the instances through the repository, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 50. A Spring MVC controller using domain types in method signatures</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">UserController</span> {

  <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
  <span class="predefined-type">String</span> showUserForm(<span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) User user, Model model) {

    model.addAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, user);
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">userForm</span><span class="delimiter">&quot;</span></span>;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, the method receives a <code>User</code> instance directly, and no further lookup is necessary.
The instance can be resolved by letting Spring MVC convert the path variable into the <code>id</code> type of the domain class first
and eventually access the instance through calling <code>findById(…)</code> on the repository instance registered for the domain type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, the repository has to implement <code>CrudRepository</code> to be eligible to be discovered for conversion.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="core.web.basic.paging-and-sorting"><a class="anchor" href="#core.web.basic.paging-and-sorting"></a>HandlerMethodArgumentResolvers for Pageable and Sort</h6>
<div class="paragraph">
<p>The configuration snippet shown in the <a href="#core.web.basic.domain-class-converter">previous section</a> also registers a <code>PageableHandlerMethodArgumentResolver</code>
as well as an instance of <code>SortHandlerMethodArgumentResolver</code>.
The registration enables <code>Pageable</code> and <code>Sort</code> as valid controller method arguments, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 51. Using Pageable as controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">UserController</span> {

  <span class="directive">private</span> <span class="directive">final</span> UserRepository repository;

  UserController(UserRepository repository) {
    <span class="local-variable">this</span>.repository = repository;
  }

  <span class="annotation">@RequestMapping</span>
  <span class="predefined-type">String</span> showUsers(Model model, <span class="predefined-type">Pageable</span> pageable) {

    model.addAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>, repository.findAll(pageable));
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding method signature causes Spring MVC try to derive a <code>Pageable</code> instance from the request parameters by using the following default configuration:</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 1. Request parameters evaluated for <code>Pageable</code> instances</caption>
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page you want to retrieve. 0-indexed and defaults to 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the page you want to retrieve. Defaults to 20.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Properties that should be sorted by in the format <code>property,property(,ASC|DESC)</code>.
        Default sort direction is ascending. Use multiple <code>sort</code> parameters if you want to switch directions&#8201;&#8212;&#8201;for example, <code>?sort=firstname&amp;sort=lastname,asc</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To customize this behavior, register a bean implementing the <code>PageableHandlerMethodArgumentResolverCustomizer</code> interface or the <code>SortHandlerMethodArgumentResolverCustomizer</code> interface,
respectively. Its <code>customize()</code> method gets called, letting you change settings, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span> SortHandlerMethodArgumentResolverCustomizer sortCustomizer() {
    <span class="keyword">return</span> s -&gt; s.setPropertyDelimiter(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;--&gt;</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If setting the properties of an existing <code>MethodArgumentResolver</code> is not sufficient for your purpose, extend either <code>SpringDataWebConfiguration</code> or
the HATEOAS-enabled equivalent, override the <code>pageableResolver()</code> or <code>sortResolver()</code> methods, and import your customized configuration file instead of using the <code>@Enable</code> annotation.</p>
</div>
<div class="paragraph">
<p>If you need multiple <code>Pageable</code> or <code>Sort</code> instances to be resolved from the request (for multiple tables, for example),
you can use Spring&#8217;s <code>@Qualifier</code> annotation to distinguish one from another.
The request parameters then have to be prefixed with <code>${qualifier}_</code>.
The following example shows the resulting method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> showUsers(Model model,
      <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">thing1</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Pageable</span> first,
      <span class="annotation">@Qualifier</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">thing2</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Pageable</span> second) { <span class="error">…</span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p>you have to populate <code>thing1_page</code> and <code>thing2_page</code> and so on.</p>
</div>
<div class="paragraph">
<p>The default <code>Pageable</code> passed into the method is equivalent to a <code>PageRequest.of(0, 20)</code> but can be customized by using the <code>@PageableDefault</code> annotation on the <code>Pageable</code> parameter.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="core.web.pageables"><a class="anchor" href="#core.web.pageables"></a>Hypermedia Support for Pageables</h5>
<div class="paragraph">
<p>Spring HATEOAS ships with a representation model class (<code>PagedResources</code>) that allows enriching the content of a <code>Page</code> instance
with the necessary <code>Page</code> metadata as well as links to let the clients easily navigate the pages.
The conversion of a Page to a <code>PagedResources</code> is done by an implementation of the Spring HATEOAS <code>ResourceAssembler</code> interface, called the <code>PagedResourcesAssembler</code>.
The following example shows how to use a <code>PagedResourcesAssembler</code> as a controller method argument:</p>
</div>
<div class="exampleblock">
<div class="title">Example 52. Using a PagedResourcesAssembler as controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Controller</span>
<span class="type">class</span> <span class="class">PersonController</span> {

  <span class="annotation">@Autowired</span> PersonRepository repository;

  <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">/persons</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.GET)
  HttpEntity&lt;PagedResources&lt;Person&gt;&gt; persons(<span class="predefined-type">Pageable</span> pageable,
    PagedResourcesAssembler assembler) {

    Page&lt;Person&gt; persons = repository.findAll(pageable);
    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(assembler.toResources(persons), HttpStatus.OK);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Enabling the configuration as shown in the preceding example lets the <code>PagedResourcesAssembler</code> be used as a controller method argument.
Calling <code>toResources(…)</code> on it has the following effects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The content of the <code>Page</code> becomes the content of the <code>PagedResources</code> instance.</p>
</li>
<li>
<p>The <code>PagedResources</code> object gets a <code>PageMetadata</code> instance attached, and it is populated with information from the <code>Page</code> and the underlying <code>PageRequest</code>.</p>
</li>
<li>
<p>The <code>PagedResources</code> may get <code>prev</code> and <code>next</code> links attached, depending on the page&#8217;s state.
The links point to the URI to which the method maps.
The pagination parameters added to the method match the setup of the <code>PageableHandlerMethodArgumentResolver</code> to make sure the links can be resolved later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assume we have 30 Person instances in the database. You can now trigger a request (<code>GET <a href="http://localhost:8080/persons" class="bare">http://localhost:8080/persons</a></code>) and see output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{ <span class="key"><span class="delimiter">&quot;</span><span class="content">links</span><span class="delimiter">&quot;</span></span> : [ { <span class="key"><span class="delimiter">&quot;</span><span class="content">rel</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">next</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">href</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/persons?page=1&amp;size=20 }
  ],
  </span><span class="delimiter">&quot;</span></span>content<span class="string"><span class="delimiter">&quot;</span><span class="content"> : [
     … // 20 Person instances rendered here
  ],
  </span><span class="delimiter">&quot;</span></span>pageMetadata<span class="string"><span class="delimiter">&quot;</span><span class="content"> : {
    </span><span class="delimiter">&quot;</span></span>size<span class="string"><span class="delimiter">&quot;</span><span class="content"> : 20,
    </span><span class="delimiter">&quot;</span></span>totalElements<span class="string"><span class="delimiter">&quot;</span><span class="content"> : 30,
    </span><span class="delimiter">&quot;</span></span>totalPages<span class="string"><span class="delimiter">&quot;</span><span class="content"> : 2,
    </span><span class="delimiter">&quot;</span></span>number<span class="string"><span class="delimiter">&quot;</span><span class="content"> : 0
  }
}</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You see that the assembler produced the correct URI and also picked up the default configuration to resolve the parameters into a <code>Pageable</code> for an upcoming request.
This means that, if you change that configuration, the links automatically adhere to the change.
By default, the assembler points to the controller method it was invoked in, but that can be customized by handing in a custom <code>Link</code>
to be used as base to build the pagination links, which overloads the <code>PagedResourcesAssembler.toResource(…)</code> method.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="core.repository-populators"><a class="anchor" href="#core.repository-populators"></a>6.8.2. Repository Populators</h4>
<div class="paragraph">
<p>If you work with the Spring JDBC module, you are probably familiar with the support to populate a <code>DataSource</code> with SQL scripts.
A similar abstraction is available on the repositories level, although it does not use SQL as the data definition language because it must be store-independent.
Thus, the populators support XML (through Spring&#8217;s OXM abstraction) and JSON (through Jackson) to define data with which to populate the repositories.</p>
</div>
<div class="paragraph">
<p>Assume you have a file <code>data.json</code> with the following content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 53. Data defined as JSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[
        {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">_class</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.doc.springframework.data.docs.repositories.populators.MovieEntity</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">All The Way, Boys</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">A funny movie.</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">actors</span><span class="delimiter">&quot;</span></span>: [
                        {
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Terence Hill</span><span class="delimiter">&quot;</span></span>,
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">born</span><span class="delimiter">&quot;</span></span>: <span class="integer">1939</span>
                        },
                        {
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Bud Spencer</span><span class="delimiter">&quot;</span></span>,
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">born</span><span class="delimiter">&quot;</span></span>: <span class="integer">1929</span>
                        }
                ],
                <span class="key"><span class="delimiter">&quot;</span><span class="content">directors</span><span class="delimiter">&quot;</span></span>: [
                        {
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Giuseppe Colizzi</span><span class="delimiter">&quot;</span></span>,
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">born</span><span class="delimiter">&quot;</span></span>: <span class="integer">1925</span>
                        }
                ]
        },
        {
                <span class="key"><span class="delimiter">&quot;</span><span class="content">_class</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.doc.springframework.data.docs.repositories.populators.MovieEntity</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Double Trouble</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Another funny movie.</span><span class="delimiter">&quot;</span></span>,
                <span class="key"><span class="delimiter">&quot;</span><span class="content">actors</span><span class="delimiter">&quot;</span></span>: [
                        {
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Terence Hill</span><span class="delimiter">&quot;</span></span>,
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">born</span><span class="delimiter">&quot;</span></span>: <span class="integer">1939</span>
                        },
                        {
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Bud Spencer</span><span class="delimiter">&quot;</span></span>,
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">born</span><span class="delimiter">&quot;</span></span>: <span class="integer">1929</span>
                        }
                ],
                <span class="key"><span class="delimiter">&quot;</span><span class="content">directors</span><span class="delimiter">&quot;</span></span>: [
                        {
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Enzo Barboni</span><span class="delimiter">&quot;</span></span>,
                                <span class="key"><span class="delimiter">&quot;</span><span class="content">born</span><span class="delimiter">&quot;</span></span>: <span class="integer">1922</span>
                        }
                ]
        }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>_class</code> keys point to your domain class, in this case a <code>MovieEntity</code></p>
</div>
<div class="exampleblock">
<div class="title">Example 54. Corresponding entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Node</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieEntity</span> {

        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> title;

        <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">tagline</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> description;

        <span class="annotation">@Relationship</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>, direction = INCOMING)
        <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;PersonEntity&gt; actors;

        <span class="annotation">@Relationship</span>(type = <span class="string"><span class="delimiter">&quot;</span><span class="content">DIRECTED</span><span class="delimiter">&quot;</span></span>, direction = INCOMING)
        <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;PersonEntity&gt; directors;

        <span class="directive">public</span> MovieEntity(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> description) {
                <span class="local-variable">this</span>.title = title;
                <span class="local-variable">this</span>.description = description;
        }
        <span class="comment">// Getters and setters ommitted.</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t provide a custom constructor, you need to help the Jackson JSON library a bit by providing a so called mixin, teaching Jackson how to instantiate the object:</p>
</div>
<div class="exampleblock">
<div class="title">Example 55. Optional Jackson module helping Jackson with your domain</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonCreator</span>;
<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonProperty</span>;
<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.module.SimpleModule</span>;

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieModule</span> <span class="directive">extends</span> SimpleModule {

        <span class="directive">public</span> MovieModule() {
                setMixInAnnotation(MovieEntity.class, MovieEntityMixin.class);

        <span class="directive">abstract</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">MovieEntityMixin</span> {
                <span class="annotation">@JsonCreator</span> MovieEntityMixin(<span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>) <span class="directive">final</span> <span class="predefined-type">String</span> title,
                        <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>) <span class="directive">final</span> <span class="predefined-type">String</span> description) {
                }
        }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And finally, you declare a <code>FactoryBean&lt;ResourceReaderRepositoryPopulator</code> in your application&#8217;s configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 56. A JSON repository populator based on Jackson</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.springframework.beans.factory.FactoryBean</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Bean</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.core.io.Resource</span>;
<span class="keyword">import</span> <span class="include">org.springframework.core.io.ResourceLoader</span>;
<span class="keyword">import</span> <span class="include">org.springframework.data.repository.init.Jackson2RepositoryPopulatorFactoryBean</span>;
<span class="keyword">import</span> <span class="include">org.springframework.data.repository.init.ResourceReaderRepositoryPopulator</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.ObjectMapper</span>;

<span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PopulatorConfig</span> {

        <span class="annotation">@Bean</span>
        <span class="directive">public</span> FactoryBean&lt;ResourceReaderRepositoryPopulator&gt; respositoryPopulator(
                ObjectMapper objectMapper, <i class="conum" data-value="1"></i><b>(1)</b>
                ResourceLoader resourceLoader) {

                Jackson2RepositoryPopulatorFactoryBean factory = <span class="keyword">new</span> Jackson2RepositoryPopulatorFactoryBean();
                factory.setMapper(objectMapper);
                factory.setResources(<span class="keyword">new</span> Resource<span class="type">[]</span> { resourceLoader.getResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:data.json</span><span class="delimiter">&quot;</span></span>) }); <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="keyword">return</span> factory;
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It is important that you inject the <code>ObjectMapper</code> from the context as this takes care of all registered Jackson Modules</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here you point to <code>data.json</code> resource</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding declaration causes the <code>data.json</code> file to be read and deserialized by the Jackson <code>ObjectMapper</code>.</p>
</div>
<div class="paragraph">
<p>The type to which the JSON object is unmarshalled is determined by inspecting the <code>_class</code> attribute of the JSON document.
The infrastructure eventually selects the appropriate repository to handle the object that was deserialized.</p>
</div>
<div class="paragraph">
<p>To instead use XML to define the data the repositories should be populated with, you need to use a <code>UnmarshallerRepositoryPopulatorFactoryBean</code> and a JAXB2 marshaller.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing"><a class="anchor" href="#testing"></a>7. Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We offer <code>org.neo4j.springframework.boot.test.autoconfigure.data.DataNeo4jTest</code> and <code>org.neo4j.springframework.boot.test.autoconfigure.data.ReactiveDataNeo4jTest</code>
inside an additional module under the following coordinates:
<code>org.neo4j.springframework.data:spring-data-neo4j-rx-spring-boot-test-autoconfigure</code>.
Include the following dependency in your project setup</p>
</div>
<div class="listingblock">
<div class="title">Listing 12. spring-data-neo4j-rx-spring-boot-test-autoconfigure for Maven</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.neo4j.springframework.data<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-data-neo4j-rx-spring-boot-test-autoconfigure<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0.0<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or with Gradle</p>
</div>
<div class="listingblock">
<div class="title">Listing 13. spring-data-neo4j-rx-spring-boot-test-autoconfigure for Gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    testImplementation <span class="string"><span class="delimiter">'</span><span class="content">org.neo4j.springframework.data:spring-data-neo4j-rx-spring-boot-test-autoconfigure:1.0.0</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>@DataNeo4jTest</code> and <code>@ReactiveDataNeo4jTest</code> are Spring Boot <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-testing">test slices</a>.
By default, they provide the Neo4j test harness through the transitive dependency of <a href="https://github.com/neo4j/neo4j-java-driver-spring-boot-starter/tree/master/neo4j-java-driver-test-harness-spring-boot-autoconfigure">neo4j-java-driver-test-harness-spring-boot-autoconfigure</a>.
Both slices provide all the necessary infrastructure for tests using Neo4j: A driver bean, a transaction manager, a client, a template and declared repositories,
in their imperative or reactive variants.
<code>@DataNeo4jTest</code> provides both variants if reactive repositories are enabled while <code>@ReactiveDataNeo4jTest</code> provides only reactive infrastructure.</p>
</div>
<div class="paragraph">
<p>The dependencies include the Neo4j test harness in version 3.5.x by default. Thus, reactive database access and multiple databases cannot be tested out of the box.
The reason for doing this is simple: Spring Data&#8217;s JDK baseline is JDK 8. The Neo4j test harness in version 4 requires JDK 11+, so we cannot make it the default.</p>
</div>
<div class="paragraph">
<p>Here are the available options.
Both test slices include <code>@ExtendWith(SpringExtension.class)</code> so that they run automatically with JUnit 5 (JUnit Jupiter).</p>
</div>
<div class="sect2">
<h3 id="dataneo4jtest"><a class="anchor" href="#dataneo4jtest"></a>7.1. <code>@DataNeo4jTest</code></h3>
<div class="paragraph">
<p><code>@DataNeo4jTest</code> provides both imperative and reactive infrastructure by default.
If you annotate a test with it the test becomes <code>@Transactional</code>.</p>
</div>
<div class="paragraph">
<p><code>@Transactional</code> in Spring tests always means imperative transactional, as declarative transactions needs the return type of a method to decide whether the imperative <code>PlatformTransactionManager</code> or the reactive <code>ReactiveTransactionManager</code> kicks in.
This is the reason you cannot use <code>@DataNeo4jTest</code> with setting <code>spring.data.neo4j.repositories.type</code> to <code>reactive</code> as this disables imperative infrastructure.</p>
</div>
<div class="sect3">
<h4 id="withneo4jtestharness"><a class="anchor" href="#withneo4jtestharness"></a>7.1.1. With Neo4j test harness</h4>
<div class="paragraph">
<p>This is the default.
See the <a href="#imperative-template-example">imperative template example test</a>.
This class uses the included Neo4j test harness 3.5 by default.</p>
</div>
<div id="dataneo4jtest-template-example" class="listingblock">
<div class="title">Listing 14. TemplateExampleTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@DataNeo4jTest</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">TemplateExampleTest</span> {
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="withneo4j4.0testharness"><a class="anchor" href="#withneo4j4.0testharness"></a>7.1.2. With Neo4j 4.0 test harness</h4>
<div class="paragraph">
<p>Include the following dependency in your project setup</p>
</div>
<div class="listingblock">
<div class="title">Listing 15. Neo4j 4.0 test harness for Maven</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.neo4j.test<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-harness<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>4.0.3<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if you like Gradle better:</p>
</div>
<div class="listingblock">
<div class="title">Listing 16. Neo4j 4.0 test harness for Gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    testImplementation <span class="string"><span class="delimiter">'</span><span class="content">org.neo4j.test:neo4j-harness:4.0.3</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The test setup doesn&#8217;t change. <code>@DataNeo4jTest</code> is enough.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This setup works with both imperative and reactive infrastructure.</p>
</div>
</div>
<div class="sect3">
<h4 id="withtestcontainers"><a class="anchor" href="#withtestcontainers"></a>7.1.3. With Testcontainers</h4>
<div class="paragraph">
<p>Bring in the required dependencies:</p>
</div>
<div id="testcontainers-dependencies" class="listingblock">
<div class="title">Listing 17. Dependencies for Testcontainers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.neo4j.springframework.data<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-data-neo4j-rx-spring-boot-test-autoconfigure<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>{spring-data-neo4j-rx-version}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
        <span class="tag">&lt;exclusions&gt;</span>
                <span class="tag">&lt;exclusion&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
                        <span class="tag">&lt;groupId&gt;</span>org.neo4j.test<span class="tag">&lt;/groupId&gt;</span>
                        <span class="tag">&lt;artifactId&gt;</span>neo4j-harness<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;/exclusion&gt;</span>
        <span class="tag">&lt;/exclusions&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.testcontainers<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>junit-jupiter<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>1.13.0<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.testcontainers<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>neo4j<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>1.13.0<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Be aware of this exclusion. If you don&#8217;t exclude that dependency, it will have
precedence over any manual configuration of the Neo4j URL.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As of Spring Framework 5.2.5, the TestContext framework provides support for dynamic property sources via the <code>@DynamicPropertySource</code> annotation.
This annotation can be used in integration tests that need to add properties with dynamic values.
For more information, have a look at the <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/testing.html#testcontext-ctx-management-dynamic-property-sources">Spring Framework reference</a>.</p>
</div>
<div class="paragraph">
<p>A <code>@DataNeo4jTest</code> using <code>@DynamicPropertySource</code> together with Testcontainers looks like this:</p>
</div>
<div id="configure-your-container-source" class="listingblock">
<div class="title">Listing 18. Configure your Neo4j URLs dynamically in a Spring Boot Test</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.springframework.boot.test.autoconfigure.data.DataNeo4jTest</span>;

<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertyRegistry</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertySource</span>;

<span class="keyword">import</span> <span class="include">org.testcontainers.containers.Neo4jContainer</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Container</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Testcontainers</span>;

<span class="annotation">@Testcontainers</span>
<span class="annotation">@DataNeo4jTest</span>
<span class="type">class</span> <span class="class">ExampleTest</span> {

    <span class="annotation">@Container</span>
    <span class="directive">private</span> <span class="directive">static</span> Neo4jContainer&lt;?&gt; neo4jContainer = <span class="keyword">new</span> Neo4jContainer&lt;&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j:4.0</span><span class="delimiter">&quot;</span></span>);

    <span class="annotation">@DynamicPropertySource</span>
    <span class="directive">static</span> <span class="type">void</span> neo4jProperties(DynamicPropertyRegistry registry) {
        registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.uri</span><span class="delimiter">&quot;</span></span>, neo4jContainer::getBoltUrl);
        registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.username</span><span class="delimiter">&quot;</span></span>, () -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>);
        registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.password</span><span class="delimiter">&quot;</span></span>, neo4jContainer::getAdminPassword);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An alternative to this approach in older versions of Spring Boot and the Spring Framework is an initializer that looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 19. Alternative injection of dynamic properties prior to Spring Boot 2.2.6</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Testcontainers</span>
<span class="annotation">@ContextConfiguration</span>(initializers = PriorToBoot226Test.Initializer.class)
<span class="annotation">@DataNeo4jTest</span>
<span class="type">class</span> <span class="class">PriorToBoot226Test</span> {

    <span class="annotation">@Container</span>
    <span class="directive">private</span> <span class="directive">static</span> Neo4jContainer&lt;?&gt; neo4jContainer = <span class="keyword">new</span> Neo4jContainer&lt;&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j:4.0</span><span class="delimiter">&quot;</span></span>);

    <span class="directive">static</span> <span class="type">class</span> <span class="class">Initializer</span> <span class="directive">implements</span> ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {
        <span class="directive">public</span> <span class="type">void</span> initialize(ConfigurableApplicationContext configurableApplicationContext) {
            TestPropertyValues.of(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.uri=</span><span class="delimiter">&quot;</span></span> + neo4jContainer.getBoltUrl(),
                <span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.username=neo4j</span><span class="delimiter">&quot;</span></span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.password=</span><span class="delimiter">&quot;</span></span> + neo4jContainer.getAdminPassword()
            ).applyTo(configurableApplicationContext.getEnvironment());
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you dont want to exclude <code>org.neo4j.test:neo4j-harness</code> as advised in <a href="#testcontainers-dependencies">Listing 17</a>, you can manually exclude
the <code>Neo4jTestHarnessAutoConfiguration.class</code> from the test slice like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.driver.springframework.boot.test.autoconfigure.Neo4jTestHarnessAutoConfiguration</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.boot.test.autoconfigure.data.DataNeo4jTest</span>;

<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Testcontainers</span>;

<span class="annotation">@Testcontainers</span>
<span class="annotation">@DataNeo4jTest</span>(excludeAutoConfiguration = Neo4jTestHarnessAutoConfiguration.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">TemplateExampleTest</span> {
    <span class="comment">// Configuration of Neo4j connection as above.</span>
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reactivedataneo4jtest"><a class="anchor" href="#reactivedataneo4jtest"></a>7.2. <code>@ReactiveDataNeo4jTest</code></h3>
<div class="paragraph">
<p>Everything said about <code>@DataNeo4jTest</code> applies to <code>@ReactiveDataNeo4jTest</code> as well.
However, <code>@ReactiveDataNeo4jTest</code> enables reactive infrastructure only and is not meta-annotated with <code>@Transactional</code>,
thus it doesn&#8217;t depend on a <code>PlatformTransactionManager</code>.</p>
</div>
<div class="paragraph">
<p><code>@ReactiveDataNeo4jTest</code> also checks whether the Neo4j instance configured is capable of handling reactive connections.</p>
</div>
<div class="paragraph">
<p>Our recommendation is to use it together with Testcontainers and exclude the Neo4j test harness dependency.</p>
</div>
<div class="paragraph">
<p>A typical example would look like this:</p>
</div>
<div id="reactivedataneo4jtest-repository-example" class="listingblock">
<div class="title">Listing 20. RepositoryIT.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">static</span> <span class="include">org.assertj.core.api.Assertions</span>.*;

<span class="keyword">import</span> <span class="include">reactor.test.StepVerifier</span>;

<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.boot.test.autoconfigure.data.ReactiveDataNeo4jTest</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.MovieRepository</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.PersonRepository</span>;
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertyRegistry</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertySource</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.containers.Neo4jContainer</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Container</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Testcontainers</span>;

<span class="annotation">@Testcontainers</span>
<span class="annotation">@ReactiveDataNeo4jTest</span>
<span class="type">class</span> <span class="class">RepositoryIT</span> {

        <span class="annotation">@Container</span>
        <span class="directive">private</span> <span class="directive">static</span> Neo4jContainer&lt;?&gt; neo4jContainer = <span class="keyword">new</span> Neo4jContainer&lt;&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j:4.0</span><span class="delimiter">&quot;</span></span>);

        <span class="annotation">@DynamicPropertySource</span>
        <span class="directive">static</span> <span class="type">void</span> neo4jProperties(DynamicPropertyRegistry registry) {
                registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.uri</span><span class="delimiter">&quot;</span></span>, neo4jContainer::getBoltUrl);
                registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.username</span><span class="delimiter">&quot;</span></span>, () -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>);
                registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.password</span><span class="delimiter">&quot;</span></span>, neo4jContainer::getAdminPassword);
        }

        <span class="annotation">@Test</span>
        <span class="type">void</span> loadAllPersonsFromGraph(<span class="annotation">@Autowired</span> PersonRepository personRepository) {
                <span class="type">int</span> expectedPersonCount = <span class="integer">133</span>;
                StepVerifier.create(personRepository.findAll())
                        .expectNextCount(expectedPersonCount)
                        .verifyComplete();
        }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auditing"><a class="anchor" href="#auditing"></a>8. Auditing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="auditing.basics"><a class="anchor" href="#auditing.basics"></a>8.1. Basics</h3>
<div class="paragraph">
<p>Spring Data provides sophisticated support to transparently keep track of who created or changed an entity and when the change happened.
To benefit from that functionality, you have to equip your entity classes with auditing metadata that can be defined either using annotations or by implementing an interface.</p>
</div>
<div class="sect3">
<h4 id="auditing.annotations"><a class="anchor" href="#auditing.annotations"></a>8.1.1. Annotation-based Auditing Metadata</h4>
<div class="paragraph">
<p>We provide <code>@CreatedBy</code> and <code>@LastModifiedBy</code> to capture the user who created or modified the entity as well as <code>@CreatedDate</code> and <code>@LastModifiedDate</code> to capture when the change happened.</p>
</div>
<div class="exampleblock">
<div class="title">Example 57. An audited entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Customer</span> {

  <span class="annotation">@CreatedBy</span>
  <span class="directive">private</span> User user;

  <span class="annotation">@CreatedDate</span>
  <span class="directive">private</span> DateTime createdDate;

  <span class="comment">// … further properties omitted</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, the annotations can be applied selectively, depending on which information you want to capture.
The annotations capturing when changes were made can be used on properties of type Joda-Time, <code>DateTime</code>, legacy Java <code>Date</code> and <code>Calendar</code>, JDK8 date and time types, and <code>long</code> or <code>Long</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="auditing.interfaces"><a class="anchor" href="#auditing.interfaces"></a>8.1.2. Interface-based Auditing Metadata</h4>
<div class="paragraph">
<p>In case you do not want to use annotations to define auditing metadata, you can let your domain class implement the <code>Auditable</code> interface.
It exposes setter methods for all of the auditing properties.</p>
</div>
<div class="paragraph">
<p>There is also a convenience base class, <code>AbstractAuditable</code>, which you can extend to avoid the need to manually implement the interface methods
Doing so increases the coupling of your domain classes to Spring Data, which might be something you want to avoid.
Usually, the annotation-based way of defining auditing metadata is preferred as it is less invasive and more flexible.</p>
</div>
</div>
<div class="sect3">
<h4 id="auditing.auditor-aware"><a class="anchor" href="#auditing.auditor-aware"></a>8.1.3. <code>AuditorAware</code></h4>
<div class="paragraph">
<p>In case you use either <code>@CreatedBy</code> or <code>@LastModifiedBy</code>, the auditing infrastructure somehow needs to become aware of the current principal.
To do so, we provide an <code>AuditorAware&lt;T&gt;</code> SPI interface that you have to implement to tell the infrastructure who the current user or system interacting with the application is.
The generic type <code>T</code> defines what type the properties annotated with <code>@CreatedBy</code> or <code>@LastModifiedBy</code> have to be.</p>
</div>
<div class="paragraph">
<p>The following example shows an implementation of the interface that uses Spring Security&#8217;s <code>Authentication</code> object:</p>
</div>
<div class="exampleblock">
<div class="title">Example 58. Implementation of AuditorAware based on Spring Security</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SpringSecurityAuditorAware</span> <span class="directive">implements</span> AuditorAware&lt;User&gt; {

  <span class="directive">public</span> Optional&lt;User&gt; getCurrentAuditor() {

    <span class="keyword">return</span> Optional.ofNullable(SecurityContextHolder.getContext())
                          .map(SecurityContext::getAuthentication)
                          .filter(Authentication::isAuthenticated)
                          .map(Authentication::getPrincipal)
                          .map(User.class::cast);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The implementation accesses the <code>Authentication</code> object provided by Spring Security and looks up the custom <code>UserDetails</code> instance
that you have created in your <code>UserDetailsService</code> implementation.
We assume here that you are exposing the domain user through the <code>UserDetails</code> implementation but that, based on the <code>Authentication</code> found, you could also look it up from anywhere.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faq"><a class="anchor" href="#faq"></a>9. Frequently Asked Questions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are a couple of more frequently asked question in addition to the ones in the <a href="#what-is-sdn-rx">preface</a>.</p>
</div>
<div class="sect2">
<h3 id="neo4j4.0supportsmultipledatabases-howcaniusethem"><a class="anchor" href="#neo4j4.0supportsmultipledatabases-howcaniusethem"></a>9.1. Neo4j 4.0 supports multiple databases - How can I use them?</h3>
<div class="paragraph">
<p>You can either statically configure the database name or run your own database name provider.
Bear in mind that SDN/RX will not create the databases for you.
You can do this with the help of a <a href="https://github.com/michael-simons/neo4j-migrations">migrations tool</a>
or of course with a simple script upfront.</p>
</div>
<div class="sect3">
<h4 id="staticallyconfigured"><a class="anchor" href="#staticallyconfigured"></a>9.1.1. Statically configured</h4>
<div class="paragraph">
<p>Configure the database name to use in your Spring Boot configuration like this
(The same property applies of course for YML or environment based configuration, with Spring Boots conventions applied):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">org.neo4j.data.database = yourDatabase</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that configuration in place, all queries generated by all instances of SDN/RX repositories (both reactive and imperative)
and by the <code>ReactiveNeo4jTemplate</code> respectively <code>Neo4jTemplate</code> will be executed against the database <code>yourDatabase</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="dynamicallyconfigured"><a class="anchor" href="#dynamicallyconfigured"></a>9.1.2. Dynamically configured</h4>
<div class="paragraph">
<p>Provide a bean with the type <code>Neo4jDatabaseNameProvider</code> or <code>ReactiveDatabaseSelectionProvider</code> depending on the type of your Spring application.</p>
</div>
<div class="paragraph">
<p>That bean could use for example Spring&#8217;s security context to retrieve a tenant.
Here is a working example for an imperative application secured with Spring Security:</p>
</div>
<div id="faq.databaseSelectionProvider" class="listingblock">
<div class="title">Listing 21. Neo4jConfig.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.DatabaseSelection</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.DatabaseSelectionProvider</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Bean</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.security.core.Authentication</span>;
<span class="keyword">import</span> <span class="include">org.springframework.security.core.context.SecurityContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.security.core.context.SecurityContextHolder</span>;
<span class="keyword">import</span> <span class="include">org.springframework.security.core.userdetails.User</span>;

<span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Neo4jConfig</span> {

        <span class="annotation">@Bean</span>
        DatabaseSelectionProvider databaseSelectionProvider() {

                <span class="keyword">return</span> () -&gt; Optional.ofNullable(SecurityContextHolder.getContext())
                        .map(SecurityContext::getAuthentication)
                        .filter(Authentication::isAuthenticated)
                        .map(Authentication::getPrincipal)
                        .map(User.class::cast)
                        .map(User::getUsername)
                        .map(DatabaseSelection::byName)
                        .orElseGet(DatabaseSelection::undecided);
        }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be careful that you don&#8217;t mix up entities retrieved from one database with another database.
      The database name is requested for each new transaction, so you might end up with less or more
      entities than expected when changing the database name in between calls.
      Or worse, you could inevitable store the wrong entities in the wrong database.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="doineedspecificconfigurationsothattransactionsworkseamlesswithaneo4jcausalcluster"><a class="anchor" href="#doineedspecificconfigurationsothattransactionsworkseamlesswithaneo4jcausalcluster"></a>9.2. Do I need specific configuration so that transactions work seamless with a Neo4j Causal Cluster?</h3>
<div class="paragraph">
<p>No, you don&#8217;t.
SDN/RX uses Neo4j Causal Cluster bookmarks internally without any configuration on your side required.
Transactions in the same thread or the same reactive stream following each other will be able to read their previously changed values as you would expect.</p>
</div>
</div>
<div class="sect2">
<h3 id="doineedtouseneo4jspecificannotations"><a class="anchor" href="#doineedtouseneo4jspecificannotations"></a>9.3. Do I need to use Neo4j specific annotations?</h3>
<div class="paragraph">
<p>No.
You are free to use the following, equivalent Spring Data annotations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SDN/RX Neo4j specific annotation</th>
<th class="tableblock halign-left valign-top">Spring Data common annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">Difference</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.core.schema.Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.data.annotation.Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks the annotated attribute as the unique id.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specific annotation has no additional features.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.core.schema.Node</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.data.annotation.Persistent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks the class as persistent entity.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Node</code> allows customizing the labels</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="howdoiuseassignedids"><a class="anchor" href="#howdoiuseassignedids"></a>9.4. How do I use assigned ids?</h3>
<div class="paragraph">
<p>Just <code>@Id</code> without <code>@GeneratedValue</code> and fill your id attribute via a constructor parameter or a setter or <em>wither</em>.
See this <a href="https://medium.com/neo4j/neo4j-ogm-and-spring-data-neo4j-a55a866df68c">blog post</a> for some general remarks about finding good ids.</p>
</div>
</div>
<div class="sect2">
<h3 id="howdoiuseexternallygeneratedids"><a class="anchor" href="#howdoiuseexternallygeneratedids"></a>9.5. How do I use externally generated ids?</h3>
<div class="paragraph">
<p>We provide the interface <code>org.neo4j.springframework.data.core.schema.IdGenerator</code>.
Implement it anyway you want and configure your implementation like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 22. ThingWithGeneratedId.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Node</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ThingWithGeneratedId</span> {

        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span>(TestSequenceGenerator.class)
        <span class="directive">private</span> <span class="predefined-type">String</span> theId;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you pass in the name of a class to <code>@GeneratedValue</code>, this class must have a no-args default constructor.
You can however use a string as well:</p>
</div>
<div class="listingblock">
<div class="title">Listing 23. ThingWithIdGeneratedByBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Node</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ThingWithIdGeneratedByBean</span> {

        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span>(generatorRef = <span class="string"><span class="delimiter">&quot;</span><span class="content">idGeneratingBean</span><span class="delimiter">&quot;</span></span>)
        <span class="directive">private</span> <span class="predefined-type">String</span> theId;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that, <code>idGeneratingBean</code> refers to a bean in the Spring context.
This might be useful for sequence generating.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Setters are not required on non-final fields for the id.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="template-support"><a class="anchor" href="#template-support"></a>9.6. Do I have to create repositories for each domain class?</h3>
<div class="paragraph">
<p>No.
Have a look at the <a href="#sdn-rx-building-blocks">SDN/RX building blocks</a> and
find the <code>Neo4jTemplate</code> respectively the <code>ReactiveNeo4jTemplate.</code></p>
</div>
<div class="paragraph">
<p>Those templates know your domain and provide all necessary basic CRUD methods for retrieving, writing and counting entities.</p>
</div>
<div class="paragraph">
<p>This is our canonical movie example with the imperative template:</p>
</div>
<div id="imperative-template-example" class="listingblock">
<div class="title">Listing 24. TemplateExampleTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">static</span> <span class="include">java.util.Collections</span>.*;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.assertj.core.api.Assertions</span>.*;

<span class="keyword">import</span> <span class="include">java.util.Optional</span>;

<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.boot.test.autoconfigure.data.DataNeo4jTest</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.Neo4jTemplate</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.MovieEntity</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.PersonEntity</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.Roles</span>;
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;

<span class="annotation">@DataNeo4jTest</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">TemplateExampleTest</span> {
        <span class="annotation">@Test</span>
        <span class="type">void</span> shouldSaveAndReadEntities(<span class="annotation">@Autowired</span> Neo4jTemplate neo4jTemplate) {

                MovieEntity movie = <span class="keyword">new</span> MovieEntity(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">The Love Bug</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">A movie that follows the adventures of Herbie, Herbie's driver, </span><span class="delimiter">&quot;</span></span>
                                + <span class="string"><span class="delimiter">&quot;</span><span class="content">Jim Douglas (Dean Jones), and Jim's love interest, </span><span class="delimiter">&quot;</span></span>
                                + <span class="string"><span class="delimiter">&quot;</span><span class="content">Carole Bennett (Michele Lee)</span><span class="delimiter">&quot;</span></span>);

                movie.getActorsAndRoles().put(<span class="keyword">new</span> PersonEntity(<span class="integer">1931</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Dean Jones</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> Roles(singletonList(<span class="string"><span class="delimiter">&quot;</span><span class="content">Didi</span><span class="delimiter">&quot;</span></span>)));
                movie.getActorsAndRoles().put(<span class="keyword">new</span> PersonEntity(<span class="integer">1942</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Michele Lee</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> Roles(singletonList(<span class="string"><span class="delimiter">&quot;</span><span class="content">Michi</span><span class="delimiter">&quot;</span></span>)));

                neo4jTemplate.save(movie);

                Optional&lt;PersonEntity&gt; person = neo4jTemplate
                        .findById(<span class="string"><span class="delimiter">&quot;</span><span class="content">Dean Jones</span><span class="delimiter">&quot;</span></span>, PersonEntity.class);
                assertThat(person).map(PersonEntity::getBorn).hasValue(<span class="integer">1931</span>);

                assertThat(neo4jTemplate.count(PersonEntity.class)).isEqualTo(<span class="integer">2L</span>);
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the reactive version, omitting the setup for brevity:</p>
</div>
<div id="reactive-template-example" class="listingblock">
<div class="title">Listing 25. ReactiveTemplateExampleTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">static</span> <span class="include">java.util.Collections</span>.*;

<span class="keyword">import</span> <span class="include">reactor.test.StepVerifier</span>;

<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.boot.test.autoconfigure.data.ReactiveDataNeo4jTest</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.ReactiveNeo4jTemplate</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.MovieEntity</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.PersonEntity</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.examples.spring_boot.domain.Roles</span>;
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertyRegistry</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertySource</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.containers.Neo4jContainer</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Container</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Testcontainers</span>;

<span class="annotation">@Testcontainers</span>
<span class="annotation">@ReactiveDataNeo4jTest</span>
<span class="type">class</span> <span class="class">ReactiveTemplateExampleTest</span> {

        <span class="annotation">@Container</span>
        <span class="directive">private</span> <span class="directive">static</span> Neo4jContainer&lt;?&gt; neo4jContainer = <span class="keyword">new</span> Neo4jContainer&lt;&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j:4.0</span><span class="delimiter">&quot;</span></span>);

        <span class="annotation">@DynamicPropertySource</span>
        <span class="directive">static</span> <span class="type">void</span> neo4jProperties(DynamicPropertyRegistry registry) {
                registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.uri</span><span class="delimiter">&quot;</span></span>, neo4jContainer::getBoltUrl);
                registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.username</span><span class="delimiter">&quot;</span></span>, () -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>);
                registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j.driver.authentication.password</span><span class="delimiter">&quot;</span></span>, neo4jContainer::getAdminPassword);
        }

        <span class="annotation">@Test</span>
        <span class="type">void</span> shouldSaveAndReadEntities(<span class="annotation">@Autowired</span> ReactiveNeo4jTemplate neo4jTemplate) {

                MovieEntity movie = <span class="keyword">new</span> MovieEntity(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">The Love Bug</span><span class="delimiter">&quot;</span></span>,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">A movie that follows the adventures of Herbie, Herbie's driver, </span><span class="delimiter">&quot;</span></span>
                                + <span class="string"><span class="delimiter">&quot;</span><span class="content">Jim Douglas (Dean Jones), and Jim's love interest, </span><span class="delimiter">&quot;</span></span>
                                + <span class="string"><span class="delimiter">&quot;</span><span class="content">Carole Bennett (Michele Lee)</span><span class="delimiter">&quot;</span></span>);

                movie.getActorsAndRoles().put(<span class="keyword">new</span> PersonEntity(<span class="integer">1931</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Dean Jones</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> Roles(singletonList(<span class="string"><span class="delimiter">&quot;</span><span class="content">Didi</span><span class="delimiter">&quot;</span></span>)));
                movie.getActorsAndRoles().put(<span class="keyword">new</span> PersonEntity(<span class="integer">1942</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Michele Lee</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> Roles(singletonList(<span class="string"><span class="delimiter">&quot;</span><span class="content">Michi</span><span class="delimiter">&quot;</span></span>)));

                StepVerifier.create(neo4jTemplate.save(movie))
                        .expectNextCount(<span class="integer">1L</span>)
                        .verifyComplete();

                StepVerifier.create(neo4jTemplate
                        .findById(<span class="string"><span class="delimiter">&quot;</span><span class="content">Dean Jones</span><span class="delimiter">&quot;</span></span>, PersonEntity.class)
                        .map(PersonEntity::getBorn)
                )
                        .expectNext(<span class="integer">1931</span>)
                        .verifyComplete();

                StepVerifier.create(neo4jTemplate.count(PersonEntity.class))
                        .expectNext(<span class="integer">2L</span>)
                        .verifyComplete();
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="howdoispecifyparametersincustomqueries"><a class="anchor" href="#howdoispecifyparametersincustomqueries"></a>9.7. How do I specify parameters in custom queries?</h3>
<div class="paragraph">
<p>You do this exactly the same way as in a standard Cypher query issued in the Neo4j Browser or the Cypher-Shell,
with the <code>$</code> syntax (from Neo4j 4.0 on upwards, the old <code>{foo}</code> syntax for Cypher parameters has been removed from the database);</p>
</div>
<div id="custom-queries-with-parameters" class="listingblock">
<div class="title">Listing 26. ARepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ARepository</span> <span class="directive">extends</span> Neo4jRepository&lt;AnAggregateRoot, <span class="predefined-type">String</span>&gt; {

        <span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (a:AnAggregateRoot {name: $name}) RETURN a</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
        Optional&lt;AnAggregateRoot&gt; findByCustomQuery(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we are referring to the parameter by its name.
You can also use <code>$0</code> etc. instead.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You need to compile your Java 8+ project with <code>-parameters</code> to make named parameters
      work without further annotations. The Spring Boot Maven and Gradle plugins do this
      automatically for you. If this is not feasible for any reason, you can either add
      <code>@Param</code>  and specify the name explicitly or use the parameters index.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="howdoiusespringexpressionlanguageincustomqueries"><a class="anchor" href="#howdoiusespringexpressionlanguageincustomqueries"></a>9.8. How do I use Spring Expression Language in custom queries?</h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#expressions">Spring Expression Language (SpEL)</a> can be used in custom queries inside <code>:#{}</code>.
This is the standard Spring Data way of defining a block of text inside a query that undergoes SpEL evaluation.</p>
</div>
<div class="paragraph">
<p>The following example basically defines the same query as above, but uses a <code>WHERE</code> clause to avoid even more curly braces:</p>
</div>
<div id="custom-queries-with-spel" class="listingblock">
<div class="title">Listing 27. ARepository.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ARepository</span> <span class="directive">extends</span> Neo4jRepository&lt;AnAggregateRoot, <span class="predefined-type">String</span>&gt; {

        <span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (a:AnAggregateRoot) WHERE a.name = :#{#pt1 + #pt2} RETURN a</span><span class="delimiter">&quot;</span></span>)
        Optional&lt;AnAggregateRoot&gt; findByCustomQueryWithSpEL(<span class="predefined-type">String</span> pt1, <span class="predefined-type">String</span> pt2);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SpEL blocked starts with <code>:#{</code> and than refers to the given <code>String</code> parameters by name (<code>#pt1</code>).
Don&#8217;t confuse this with the above Cypher syntax!
The SpEL expression concatenates both parameters into one single value that is eventually passed on to the <a href="#neo4j-client">Neo4jClient</a>.
The SpEL block ends with <code>}</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="howdoiauditentities"><a class="anchor" href="#howdoiauditentities"></a>9.9. How do I audit entities?</h3>
<div class="paragraph">
<p>All Spring Data annotations are supported.
Those are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.data.annotation.CreatedBy</code></p>
</li>
<li>
<p><code>org.springframework.data.annotation.CreatedDate</code></p>
</li>
<li>
<p><code>org.springframework.data.annotation.LastModifiedBy</code></p>
</li>
<li>
<p><code>org.springframework.data.annotation.LastModifiedDate</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="howdoiusefindbyexample"><a class="anchor" href="#howdoiusefindbyexample"></a>9.10. How do I use "Find by example"?</h3>
<div class="paragraph">
<p>"Find by example" is a new feature in SDN/RX.
You instantiate an entity or use an existing one.
With this instance you create an <code>org.springframework.data.domain.Example</code>.
If your repository extends <code>org.neo4j.springframework.data.repository.Neo4jRepository</code> or <code>org.neo4j.springframework.data.repository.ReactiveNeo4jRepository</code>,
you can immediately use the available <code>findBy</code> methods taking in an example, like shown in <a href="#find-by-example-example">Listing 28</a></p>
</div>
<div id="find-by-example-example" class="listingblock">
<div class="title">Listing 28. findByExample in Action</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Example&lt;MovieEntity&gt; movieExample = Example.of(<span class="keyword">new</span> MovieEntity(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Matrix</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>));
Flux&lt;MovieEntity&gt; movies = <span class="local-variable">this</span>.movieRepository.findAll(movieExample);

movieExample = Example.of(
        <span class="keyword">new</span> MovieEntity(<span class="string"><span class="delimiter">&quot;</span><span class="content">Matrix</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>),
        ExampleMatcher
            .matchingAny()
        .withMatcher(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>,
                ExampleMatcher.GenericPropertyMatcher.of(ExampleMatcher.StringMatcher.CONTAINING)
        )
);
movies = <span class="local-variable">this</span>.movieRepository.findAll(movieExample);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="#appendix"></a>10. Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="conversions"><a class="anchor" href="#conversions"></a>Conversions</h3>
<div class="paragraph">
<p>We support a broad range of conversions out of the box.
Find the list of supported cypher types in the official drivers manual: <a href="https://neo4j.com/docs/driver-manual/current/cypher-values/">Working with Cypher values</a>.</p>
</div>
<div class="paragraph">
<p>Primitive types of wrapper types are equally supported.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 42.8571%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Domain type</th>
<th class="tableblock halign-left valign-top">Cypher type</th>
<th class="tableblock halign-left valign-top">Maps directly to native type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.String[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ByteArray</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Byte</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ByteArray with length 1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Character</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String with length 1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>char[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of String with length 1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String formatted as ISO 8601 Date (<code>yyyy-MM-dd&#8217;T&#8217;HH:mm:ss.SSSZ</code>).
 Notice the <code>Z</code>: SDN/RX will store all <code>java.util.Date</code> instances in <code>UTC</code>.
 If you require the time zone, use a type that supports it (i.e. <code>ZoneDateTime</code>) or store the zone as a separate property.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Integer</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Locale</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String formatted as BCP 47 language tag</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.Short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>short[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Integer</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.math.BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.OffsetTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LocalTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.ZonedDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.LocalDateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LocalDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.time.Duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.driver.types.IsoDuration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.driver.types.Point</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✔</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.types.GeographicPoint2d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point with CRS 4326</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.types.GeographicPoint3d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point with CRS 4979</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.types.CartesianPoint2d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point with CRS 7203</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.types.CartesianPoint3d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point with CRS 9157</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.data.geo.Point</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point with CRS 4326 and x/y corresponding to lat/long</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instances of <code>Enum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String (The name value of the enum)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instances of <code>Enum[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of String (The name value of the enum)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="customconversions"><a class="anchor" href="#customconversions"></a>Custom conversions</h4>
<div class="paragraph">
<p>If you prefer to work with your own types in the entities or as parameters for <code>@Query</code> annotated methods,
you can define and provide a custom converter implementation.
First you have to implement a <code>GenericConverter</code> and register the types your converter should handle.
For entity property type converters you need to take care of converting your type to <strong>and</strong> from a Neo4j Java Driver <code>Value</code>.
If your converter is supposed to work only with custom query methods in the repositories, it is sufficient
to provide the one-way conversion to the <code>Value</code> type.</p>
</div>
<div class="listingblock">
<div class="title">Listing 29. Example of a custom converter implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyCustomTypeConverter</span> <span class="directive">implements</span> GenericConverter {

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;ConvertiblePair&gt; getConvertibleTypes() {
                <span class="predefined-type">Set</span>&lt;ConvertiblePair&gt; convertiblePairs = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();
                convertiblePairs.add(<span class="keyword">new</span> ConvertiblePair(MyCustomType.class, Value.class));
                convertiblePairs.add(<span class="keyword">new</span> ConvertiblePair(Value.class, MyCustomType.class));
                <span class="keyword">return</span> convertiblePairs;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">Object</span> convert(<span class="predefined-type">Object</span> source, TypeDescriptor sourceType, TypeDescriptor targetType) {
                <span class="keyword">if</span> (MyCustomType.class.isAssignableFrom(sourceType.getType())) {
                        <span class="comment">// convert to Neo4j Driver Value</span>
                        <span class="keyword">return</span> convertToNeo4jValue(source);
                } <span class="keyword">else</span> {
                        <span class="comment">// convert to MyCustomType</span>
                        <span class="keyword">return</span> convertToMyCustomType(source);
                }
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make SDN/RX aware of your converter, it has to be registered in the <code>Neo4jConversions</code>.
To do this, you have to create a <code>@Bean</code> with the type <code>org.neo4j.springframework.data.core.convert.Neo4jConversions</code>.
Otherwise, the <code>Neo4jConversions</code> will get created in the background with the internal default converters only.</p>
</div>
<div class="listingblock">
<div class="title">Listing 30. Example of a custom converter implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Bean</span>
<span class="directive">public</span> Neo4jConversions neo4jConversions() {
        <span class="predefined-type">Set</span>&lt;GenericConverter&gt; additionalConverters = <span class="predefined-type">Collections</span>.singleton(<span class="keyword">new</span> MyCustomTypeConverter());
        <span class="keyword">return</span> <span class="keyword">new</span> Neo4jConversions(additionalConverters);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need multiple converters in your application, you can add as many as you need in the <code>Neo4jConversions</code> constructor.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repository-query-keywords"><a class="anchor" href="#repository-query-keywords"></a>Repository query keywords</h3>
<div class="paragraph">
<p>The following table lists the keywords supported by the Spring Data Neo4j⚡RX repository query derivation mechanism.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Query keywords</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Logical keyword</th>
<th class="tableblock halign-left valign-top">Keyword expressions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>And</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Or</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AFTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code>, <code>IsAfter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BEFORE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code>, <code>IsBefore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code>, <code>IsContaining</code>, <code>Contains</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BETWEEN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code>, <code>IsBetween</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EndingWith</code>, <code>IsEndingWith</code>, <code>EndsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXISTS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exists</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FALSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>False</code>, <code>IsFalse</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThan</code>, <code>IsGreaterThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN_EQUALS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEqual</code>, <code>IsGreaterThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>In</code>, <code>IsIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Is</code>, <code>Equals</code>, (or no keyword)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_EMPTY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsEmpty</code>, <code>Empty</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NOT_EMPTY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotEmpty</code>, <code>NotEmpty</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NOT_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotNull</code>, <code>IsNotNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Null</code>, <code>IsNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThan</code>, <code>IsLessThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN_EQUAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEqual</code>, <code>IsLessThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code>, <code>IsLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NEAR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code>, <code>IsNear</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not</code>, <code>IsNot</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotIn</code>, <code>IsNotIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotLike</code>, <code>IsNotLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regex</code>, <code>MatchesRegex</code>, <code>Matches</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StartingWith</code>, <code>IsStartingWith</code>, <code>StartsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRUE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>True</code>, <code>IsTrue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WITHIN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code>, <code>IsWithin</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="repository-query-return-types"><a class="anchor" href="#repository-query-return-types"></a>Repository query return types</h3>
<div class="paragraph">
<p>The following table lists the return types generally supported by SDN/RX repositories.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Query return types</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Return type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Denotes no return value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primitives</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java primitives.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wrapper types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java wrapper types.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An unique entity.
     Expects the query method to return one result at most. If no result is found, <code>null</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Iterator&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>Iterator</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Collection</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>List</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 or Guava <code>Optional</code>.
               Expects the query method to return one result at most. If no result is found, <code>Optional.empty()</code> or <code>Optional.absent()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Option&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a Scala or Vavr <code>Option</code> type.
             Semantically the same behavior as Java 8&#8217;s <code>Optional</code>, described earlier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Stream&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 <code>Stream</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Streamable&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A convenience extension of <code>Iterable</code> that directy exposes methods to stream, map and filter results, concatenate them etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Types that implement <code>Streamable</code> and take a <code>Streamable</code> constructor or factory method argument</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Types that expose a constructor or <code>….of(…)</code>/<code>….valueOf(…)</code> factory method taking a <code>Streamable</code> as argument.
                                                                                                  See <a href="#repositories.collections-and-iterables.streamable-wrapper">Section 6.4.6.2</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vavr <code>Seq</code>, <code>List</code>, <code>Map</code>, <code>Set</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vavr collection types. See <a href="#repositories.collections-and-iterables.vavr">Section 6.4.6.3</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Future&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Future</code>.
             Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CompletableFuture&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 <code>CompletableFuture</code>.
                        Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ListenableFuture</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>org.springframework.util.concurrent.ListenableFuture</code>.
                    Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Slice</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A sized chunk of data with an indication of whether there is more data available.
         Requires a <code>Pageable</code> method parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Page&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Slice</code> with additional information, such as the total number of results.
           Requires a <code>Pageable</code> method parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Mono&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Project Reactor <code>Mono</code> emitting zero or one element using reactive repositories.
           Expects the query method to return one result at most.
           If no result is found, <code>Mono.empty()</code> is returned.
           More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flux&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Project Reactor <code>Flux</code> emitting zero, one, or many elements using reactive repositories.
           Queries returning <code>Flux</code> can emit also an infinite number of elements.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="neo4j-client"><a class="anchor" href="#neo4j-client"></a>Neo4jClient</h3>
<div class="paragraph">
<p>Spring Data Neo4j⚡RX comes with a Neo4j Client, providing a thin layer on top of Neo4j&#8217;s Java driver.</p>
</div>
<div class="paragraph">
<p>While the <a href="https://github.com/neo4j/neo4j-java-driver">plain Java driver</a> is a very versatile tool
providing an asynchronous API in addition to the imperative and reactive versions, it doesn&#8217;t
integrate with Spring application level transactions.</p>
</div>
<div class="paragraph">
<p>SDN/RX uses the driver through the concept of a idiomatic client as directly as possible.</p>
</div>
<div class="paragraph">
<p>The client has the following main goals</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Integrate into Springs transaction management, for both imperative and reactive scenarios</p>
</li>
<li>
<p>Participate in JTA-Transactions if necessary</p>
</li>
<li>
<p>Provide a consistent API for both imperative and reactive scenarios</p>
</li>
<li>
<p>Don&#8217;t add any mapping overhead</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>SDN/RX relies on all those features and uses them to fulfill its entity mapping features.</p>
</div>
<div class="paragraph">
<p>Have a look at the <a href="#sdn-rx-building-blocks">SDN/RX building blocks</a> for where both the imperative and reactive Neo4 clients are positioned in our stack.</p>
</div>
<div class="paragraph">
<p>The Neo4j Client comes in two flavors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.neo4j.springframework.data.core.Neo4jClient</code></p>
</li>
<li>
<p><code>org.neo4j.springframework.data.core.ReactiveNeo4jClient</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While both versions provide an API using the same vocabulary and syntax, they are not API compatible.
Both versions feature the same, fluent API to specify queries, bind parameters and extract results.</p>
</div>
<div class="sect3">
<h4 id="imperativeorreactive"><a class="anchor" href="#imperativeorreactive"></a>Imperative or reactive?</h4>
<div class="paragraph">
<p>Interactions with a Neo4j Client usually ends with a call to</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fetch().one()</code></p>
</li>
<li>
<p><code>fetch().first()</code></p>
</li>
<li>
<p><code>fetch().all()</code></p>
</li>
<li>
<p><code>run()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The imperative version will interact at this moment with the database
and get the requested results or summary, wrapped in a <code>Optional&lt;&gt;</code> or a <code>Collection</code>.</p>
</div>
<div class="paragraph">
<p>The reactive version will in contrast return a publisher of the requested type.
Interaction with the database and retrieval of the results will not happen until the publisher is subscribed to.
The publisher can only be subscribed once.</p>
</div>
</div>
<div class="sect3">
<h4 id="gettinganinstanceoftheclient"><a class="anchor" href="#gettinganinstanceoftheclient"></a>Getting an instance of the client</h4>
<div class="paragraph">
<p>As with most things in SDN/RX, both clients depend on a configured driver instance.</p>
</div>
<div id="neo4j-client-create-imperative-client" class="listingblock">
<div class="title">Listing 31. Creating an instance of the imperative Neo4j client</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.driver.AuthTokens</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Driver</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.GraphDatabase</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.Neo4jClient</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Demo</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span>...args) {

        <span class="predefined-type">Driver</span> driver = GraphDatabase
            .driver(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j://localhost:7687</span><span class="delimiter">&quot;</span></span>, AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>));

        Neo4jClient client = Neo4jClient.create(driver);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The driver can only open a reactive session against a 4.0 database and will fail with an exception on any lower version.</p>
</div>
<div id="neo4j-client-create-reactive-client" class="listingblock">
<div class="title">Listing 32. Creating an instance of the reactive Neo4j client</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.driver.AuthTokens</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Driver</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.GraphDatabase</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.ReactiveNeo4jClient</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Demo</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span>...args) {

        <span class="predefined-type">Driver</span> driver = GraphDatabase
            .driver(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j://localhost:7687</span><span class="delimiter">&quot;</span></span>, AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>));

        ReactiveNeo4jClient client = ReactiveNeo4jClient.create(driver);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure you use the same driver instance for the client as you used for providing a <code>Neo4jTransactionManager</code> or <code>ReactiveNeo4jTransactionManager</code>
in case you have enabled transactions.
The client won&#8217;t be able to synchronize transactions if you use another instance of a driver.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our Spring Boot starter provide a ready to use bean of the Neo4j Client that fit the environment (imperative or reactive)
and you usually don&#8217;t have to configure your own instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="usage"><a class="anchor" href="#usage"></a>Usage</h4>
<div class="sect4">
<h5 id="neo4j-client-selecting-the-target-database"><a class="anchor" href="#neo4j-client-selecting-the-target-database"></a>Selecting the target database</h5>
<div class="paragraph">
<p>The Neo4j client is well prepared to be used with the multidatabase features of Neo4j 4.0.
The client uses the default database unless you specify otherwise.
The fluent API of the client allows to specify the target database exactly once, after the declaration of the query to execute.
<a href="#neo4j-client-reactive-selecting-the-target-database">Listing 33</a> demonstrates it with the reactive client:</p>
</div>
<div id="neo4j-client-reactive-selecting-the-target-database" class="listingblock">
<div class="title">Listing 33. Selecting the target database</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Flux&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; allActors = client
        .query(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (p:Person) RETURN p</span><span class="delimiter">&quot;</span></span>)
        .in(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
        .fetch()
        .all();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Select the target database in which the query is to be executed.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="specifyingqueries"><a class="anchor" href="#specifyingqueries"></a>Specifying queries</h5>
<div class="paragraph">
<p>The interaction with the clients starts with a query.
A query can be defined by a plain <code>String</code> or a <code>Supplier&lt;String&gt;</code>.
The supplier will be evaluated as late as possible and can be provided by any query builder.</p>
</div>
<div id="neo4j-client-specifying-queries" class="listingblock">
<div class="title">Listing 34. Specifying a query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Mono&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; firstActor = client
        .query(() -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (p:Person) RETURN p</span><span class="delimiter">&quot;</span></span>)
        .fetch()
        .first();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="retrievingresults"><a class="anchor" href="#retrievingresults"></a>Retrieving results</h5>
<div class="paragraph">
<p>As the previous listings shows, the interaction with the client always ends with a call to <code>fetch</code> and how many results shall be received.
Both reactive and imperative client offer</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>one()</code></dt>
<dd>
<p>Expect exactly one result from the query</p>
</dd>
<dt class="hdlist1"><code>first()</code></dt>
<dd>
<p>Expect results and return the first record</p>
</dd>
<dt class="hdlist1"><code>all()</code></dt>
<dd>
<p>Retrieve all records returned</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The imperative client returns <code>Optional&lt;T&gt;</code> and <code>Collection&lt;T&gt;</code> respectively,
while the reactive client returns <code>Mono&lt;T&gt;</code> and <code>Flux&lt;T&gt;</code>, the later one being executed only if subscribed to.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t expect any results from your query, than use <code>run()</code> after specificity the query.</p>
</div>
<div id="neo4j-client-reactive-get-result-summaries" class="listingblock">
<div class="title">Listing 35. Retrieving result summaries in a reactive way</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Mono&lt;ResultSummary&gt; summary = reactiveClient
    .query(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (m:Movie) where m.title = 'Aeon Flux' DETACH DELETE m</span><span class="delimiter">&quot;</span></span>)
    .run();

summary
    .map(ResultSummary::counters)
    .subscribe(counters -&gt;
        <span class="predefined-type">System</span>.out.println(counters.nodesDeleted() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> nodes have been deleted</span><span class="delimiter">&quot;</span></span>)
    ); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The actual query is triggered here by subscribing to the publisher.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please take a moment to compare both listings and understand the difference when the actual query is triggered.</p>
</div>
<div id="neo4j-client-imperative-get-result-summaries" class="listingblock">
<div class="title">Listing 36. Retrieving result summaries in a imperative way</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ResultSummary resultSummary = imperativeClient
        .query(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (m:Movie) where m.title = 'Aeon Flux' DETACH DELETE m</span><span class="delimiter">&quot;</span></span>)
        .run(); <i class="conum" data-value="1"></i><b>(1)</b>

SummaryCounters counters = resultSummary.counters();
<span class="predefined-type">System</span>.out.println(counters.nodesDeleted() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> nodes have been deleted</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the query is triggered immediate.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="mappingparameters"><a class="anchor" href="#mappingparameters"></a>Mapping parameters</h5>
<div class="paragraph">
<p>Queries can contain named parameters (<code>$someName</code>).
The Neo4j client allows comfortable binding to those.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The client doesn&#8217;t check whether all parameters are bound or whether there are to many values.
That is left to the driver.
However the client prevents you from using a parameter name twice.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can either map simple types that the Java driver understands or complex classes.
Please have a look at the <a href="https://neo4j.com/docs/driver-manual/current/cypher-values/#driver-neo4j-type-system">drivers manual</a>, to see which simple types are understood.</p>
</div>
<div id="neo4j-client-mapping-simple-types" class="listingblock">
<div class="title">Listing 37. Mapping simple types</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameters = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Li.*</span><span class="delimiter">&quot;</span></span>);

Flux&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; directorAndMovies = client
        .query(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (p:Person) - [:DIRECTED] -&gt; (m:Movie {title: $title}), (p) - [:WROTE] -&gt; (om:Movie) </span><span class="delimiter">&quot;</span></span> +
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">WHERE p.name =~ $name </span><span class="delimiter">&quot;</span></span> +
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">  AND p.born &lt; $someDate.year </span><span class="delimiter">&quot;</span></span> +
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">RETURN p, om</span><span class="delimiter">&quot;</span></span>
        )
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Matrix</span><span class="delimiter">&quot;</span></span>).to(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
        .bind(LocalDate.of(<span class="integer">1979</span>, <span class="integer">9</span>, <span class="integer">21</span>)).to(<span class="string"><span class="delimiter">&quot;</span><span class="content">someDate</span><span class="delimiter">&quot;</span></span>)
        .bindAll(parameters) <i class="conum" data-value="2"></i><b>(2)</b>
        .fetch()
        .all();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>There&#8217;s a fluent API for binding simple types.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Alternatively parameters can be bound via a map of named parameters.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SDN/RX does a lot of complex mapping and it uses the same API that you can use from the client.</p>
</div>
<div class="paragraph">
<p>You can provide a <code>Function&lt;T, Map&lt;String, Object&gt;&gt;</code> for any given domain object like an owner of bicycles in <a href="#neo4j-client-domain-example">Listing 38</a>
to the Neo4j Client to map those domain objects to parameters the driver can understand.</p>
</div>
<div id="neo4j-client-domain-example" class="listingblock">
<div class="title">Listing 38. Example of a domain type</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Director</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> name;

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;Movie&gt; movies;

    Director(<span class="predefined-type">String</span> name, <span class="predefined-type">List</span>&lt;Movie&gt; movies) {
        <span class="local-variable">this</span>.name = name;
        <span class="local-variable">this</span>.movies = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(movies);
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Movie&gt; getMovies() {
        <span class="keyword">return</span> <span class="predefined-type">Collections</span>.unmodifiableList(movies);
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Movie</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> title;

    <span class="directive">public</span> Movie(<span class="predefined-type">String</span> title) {
        <span class="local-variable">this</span>.title = title;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getTitle() {
        <span class="keyword">return</span> title;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mapping function has to fill in all named parameters that might occur in the query like <a href="#neo4j-client-binder">Listing 39</a> shows:</p>
</div>
<div id="neo4j-client-binder" class="listingblock">
<div class="title">Listing 39. Using a mapping function for binding domain objects</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Director joseph = <span class="keyword">new</span> Director(<span class="string"><span class="delimiter">&quot;</span><span class="content">Joseph Kosinski</span><span class="delimiter">&quot;</span></span>,
        <span class="predefined-type">Arrays</span>.asList(<span class="keyword">new</span> Movie(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tron Legacy</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> Movie(<span class="string"><span class="delimiter">&quot;</span><span class="content">Top Gun: Maverick</span><span class="delimiter">&quot;</span></span>)));

Mono&lt;ResultSummary&gt; summary = client
    .query(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE (p:Person {name: $name}) </span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">WITH p UNWIND $movies as movie </span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE (m:Movie {title: movie}) </span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE (p) - [o:DIRECTED] -&gt; (m) </span><span class="delimiter">&quot;</span></span>
    )
    .bind(joseph).with(director -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; mappedValues = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; movies = director.getMovies().stream()
            .map(Movie::getTitle).collect(Collectors.toList());
        mappedValues.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, director.getName());
        mappedValues.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">movies</span><span class="delimiter">&quot;</span></span>, movies);
        <span class="keyword">return</span> mappedValues;
    })
    .run();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The with method allows for specifying the binder function.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="workingwithresultobjects"><a class="anchor" href="#workingwithresultobjects"></a>Working with result objects</h5>
<div class="paragraph">
<p>Both clients return collections or publishers of maps (<code>Map&lt;String, Object&gt;</code>).
Those maps corresponds exactly with the records that a query might have produced.</p>
</div>
<div class="paragraph">
<p>In addition, you can plugin your own <code>BiFunction&lt;TypeSystem, Record, T&gt;</code> through <code>fetchAs</code> to reproduce your domain object.</p>
</div>
<div id="neo4j-client-reader" class="listingblock">
<div class="title">Listing 40. Using a mapping function for reading domain objects</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Mono&lt;Director&gt; lily = client
    .query(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content"> MATCH (p:Person {name: $name}) - [:DIRECTED] -&gt; (m:Movie)</span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">RETURN p, collect(m) as movies</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">Lilly Wachowski</span><span class="delimiter">&quot;</span></span>).to(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    .fetchAs(Director.class).mappedBy((TypeSystem t, Record record) -&gt; {
        <span class="predefined-type">List</span>&lt;Movie&gt; movies = record.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">movies</span><span class="delimiter">&quot;</span></span>)
            .asList(v -&gt; <span class="keyword">new</span> Movie((v.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).asString())));
        <span class="keyword">return</span> <span class="keyword">new</span> Director(record.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).asString(), movies);
    })
    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>TypeSystem</code> gives access to the types the underlying Java driver used to fill the record.</p>
</div>
</div>
<div class="sect4">
<h5 id="interactingdirectlywiththedriverwhileusingmanagedtransactions"><a class="anchor" href="#interactingdirectlywiththedriverwhileusingmanagedtransactions"></a>Interacting directly with the driver while using managed transactions</h5>
<div class="paragraph">
<p>In case you don&#8217;t want or don&#8217;t like the opinionated "client" approach of the <code>Neo4jClient</code> or the <code>ReactiveNeo4jClient</code>,
you can have the client delegate all interactions with the database to your code.
The interaction after the delegation is slightly different with the imperative and reactive versions of the client.</p>
</div>
<div class="paragraph">
<p>The imperative version takes in a <code>Function&lt;StatementRunner, Optional&lt;T&gt;&gt;</code> as a callback.
Returning an empty optional is ok.</p>
</div>
<div id="neo4j-client-imperative-delegating" class="listingblock">
<div class="title">Listing 41. Delegate database interaction to an imperative <code>StatementRunner</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Optional&lt;<span class="predefined-type">Long</span>&gt; result = client
    .delegateTo((StatementRunner runner) -&gt; {
        <span class="comment">// Do as many interactions as you want</span>
        <span class="type">long</span> numberOfNodes = runner.run(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (n) RETURN count(n) as cnt</span><span class="delimiter">&quot;</span></span>)
            .single().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">cnt</span><span class="delimiter">&quot;</span></span>).asLong();
        <span class="keyword">return</span> Optional.of(numberOfNodes);
    })
    <span class="comment">// .in(&quot;aDatabase&quot;) </span><i class="conum" data-value="1"></i><b>(1)</b>
    .run();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The database selection as described in <a href="#neo4j-client-selecting-the-target-database">Selecting the target database</a> is optional.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reactive version receives a <code>RxStatementRunner</code>.</p>
</div>
<div id="neo4j-client-reactive-delegating" class="listingblock">
<div class="title">Listing 42. Delegate database interaction to a reactive <code>RxStatementRunner</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Mono&lt;<span class="predefined-type">Integer</span>&gt; result = client
    .delegateTo((RxStatementRunner runner) -&gt;
        Mono.from(runner.run(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (n:Unused) DELETE n</span><span class="delimiter">&quot;</span></span>).summary())
            .map(ResultSummary::counters)
            .map(SummaryCounters::nodesDeleted))
    <span class="comment">// .in(&quot;aDatabase&quot;) </span><i class="conum" data-value="1"></i><b>(1)</b>
    .run();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Optional selection of the target database.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that in both <a href="#neo4j-client-imperative-delegating">Listing 41</a> and <a href="#neo4j-client-reactive-delegating">Listing 42</a> the types of the runner have only been stated to provide more clarity to reader of this manual.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cypher-dsl"><a class="anchor" href="#cypher-dsl"></a>The Cypher-DSL</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Cypher-DSL is considered <em>EXPERIMENTAL</em> at the time of writing.
         This means you can and should use it and that we are looking actively for feedback, issues and problems.
         We will try to keep breaking changes to a minimum, but we reserve the right to modify public methods, parameters
         and behaviour in case we need those changes for SDN/RX itself.
         All public classes inside <code>org.neo4j.springframework.data.core.cypher</code> are annotated with <code>@API(status = EXPERIMENTAL, since = "1.0")</code>,
         We will switching to stable some time after a 1.0 release.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="purpose"><a class="anchor" href="#purpose"></a>Purpose</h4>
<div class="paragraph">
<p>The Cypher-DSL has been developed with the needs of SDN/RX in mind:
We wanted to avoid string concatenations in our query generation and decided do go with a builder approach, much like we
find with <a href="https://www.jooq.org">jOOQ</a> or in the relational module of <a href="https://github.com/spring-projects/spring-data-jdbc/tree/1.1.6.RELEASE/spring-data-relational/src/main/java/org/springframework/data/relational/core/sql">Spring Data JDBC</a>, but for Cypher.</p>
</div>
<div class="paragraph">
<p>What we don&#8217;t have - and don&#8217;t need for our mapping purpose - at the moment is a code generator that reads the database schema
and generates static classes representing labels and relationship types.
That is still up to the mapping framework (in our case SDN/RX).
We however have a type safe API for Cypher that allows only generating valid Cypher constructs.</p>
</div>
<div class="paragraph">
<p>We worked closely with the <a href="https://www.opencypher.org">OpenCypher spec</a> here and you find a lot of these concepts in the API.</p>
</div>
<div class="paragraph">
<p>The Cypher-DSL can also be seen in the same area as the <a href="https://docs.spring.io/spring-data/mongodb/docs/current/api/org/springframework/data/mongodb/core/query/Criteria.html">Criteria API</a> of Spring Data Mongo.</p>
</div>
</div>
<div class="sect3">
<h4 id="wheretouseit"><a class="anchor" href="#wheretouseit"></a>Where to use it</h4>
<div class="paragraph">
<p>The Cypher-DSL is publicly visible in the <code>Neo4jOperations</code> respectively <code>ReactiveNeo4jOperations</code>.
Those are the basic interfaces implemented by the Neo4j templates of the same names (Read more about the templates <a href="#template-support">here</a>).</p>
</div>
<div class="paragraph">
<p>Both the imperative and the reactive framework allow the retrieval and counting of entities with a <code>org.neo4j.springframework.data.core.cypher.Statement</code>,
for example through <code>Neo4jTemplate#findAll(Statement, Class&lt;T&gt;)</code> and similar.</p>
</div>
<div class="paragraph">
<p>An instance of a <code>org.neo4j.springframework.data.core.cypher.Statement</code> is provided at the end of query building step.</p>
</div>
<div class="paragraph">
<p>A <code>Statement</code> represents an in-memory <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract syntax tree</a> and can be
transformed and rendered as such.</p>
</div>
<div class="paragraph">
<p>We are still on a JDK 8 baseline and cannot hide our renderer in an internal module, marked as <code>@API(status = INTERNAL, since = "1.0")</code>.
You can get an instance of the default renderer via <code>org.neo4j.springframework.data.core.cypher.renderer.Renderer#getDefaultRenderer()</code>
and than use the <code>render</code> method to get a string representation of the statement.</p>
</div>
<div class="paragraph">
<p>This string representation can be used with the <a href="#neo4j-client">Neo4jClient</a>.</p>
</div>
<div class="paragraph">
<p>We do however give no guarantees to the render API until it is marked as <code>EXPERIMENTAL</code> or <code>STABLE</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="howtouseit"><a class="anchor" href="#howtouseit"></a>How to use it</h4>
<div class="paragraph">
<p>You use the Cypher-DSL as you would write Cypher:
It allows to write down even complex Cypher queries from top to bottom in a type safe, compile time checked way.</p>
</div>
<div class="paragraph">
<p>The examples to follow are using JDK 11.
We find the <code>var</code> keyword especially appealing in such a DSL as the types returned by the DSL much less important than
the further building methods they offer.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The AST parts and intermediate build steps are immutable. That is, the methods create new intermediate steps.
           For example, you cannot reuse an <code>ExposesLimit</code> step, but have to use the returned object from its <code>skip</code> method.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="examples"><a class="anchor" href="#examples"></a>Examples</h5>
<div class="paragraph">
<p>The following examples are 1:1 copies of the queries you will find in the Neo4j browser after running <code>:play movies</code>.</p>
</div>
<div class="paragraph">
<p>They use the following imports:</p>
</div>
<div class="listingblock">
<div class="title">Listing 43. Imports needed for the examples to compile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">static</span> <span class="include">org.assertj.core.api.Assertions</span>.*;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.neo4j.springframework.data.core.cypher.Conditions</span>.*;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.neo4j.springframework.data.core.cypher.Cypher</span>.*;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.neo4j.springframework.data.core.cypher.Functions</span>.*;

<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.cypher.Cypher</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.springframework.data.core.cypher.renderer.Renderer</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To match and return all the movie, build your statement like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 44. Simple match</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var m = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">m</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
var statement = Cypher.match(m) <i class="conum" data-value="2"></i><b>(2)</b>
        .returning(m)
        .build(); <i class="conum" data-value="3"></i><b>(3)</b>

assertThat(cypherRenderer.render(statement))
        .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (m:`Movie`) RETURN m</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare a variable storing your node labeled <code>Movie</code> and named <code>m</code>, so that you can</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>reuse it in both the match and the return part.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>build</code> method becomes only available when a compilable Cypher statement can be rendered.</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="find"><a class="anchor" href="#find"></a>Find</h6>
<div class="paragraph">
<p>Match all nodes with a given set of properties:</p>
</div>
<div class="listingblock">
<div class="title">Listing 45. Find the actor named "Tom Hanks"&#8230;&#8203;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var tom = anyNode().named(<span class="string"><span class="delimiter">&quot;</span><span class="content">tom</span><span class="delimiter">&quot;</span></span>).properties(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, literalOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tom Hanks</span><span class="delimiter">&quot;</span></span>));
var statement = Cypher
        .match(tom).returning(tom)
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (tom {name: 'Tom Hanks'}) RETURN tom</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Limit the number of returned things and return only one attribute</p>
</div>
<div class="listingblock">
<div class="title">Listing 46. Find 10 people&#8230;&#8203;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var people = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">people</span><span class="delimiter">&quot;</span></span>);
statement = Cypher
        .match(people)
        .returning(people.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>))
        .limit(<span class="integer">10</span>)
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (people:`Person`) RETURN people.name LIMIT 10</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create complex conditions</p>
</div>
<div class="listingblock">
<div class="title">Listing 47. Find movies released in the 1990s&#8230;&#8203;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var nineties = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">nineties</span><span class="delimiter">&quot;</span></span>);
var released = nineties.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">released</span><span class="delimiter">&quot;</span></span>);
statement = Cypher
        .match(nineties)
        .where(released.gte(literalOf(<span class="integer">1990</span>)).and(released.lt(literalOf(<span class="integer">2000</span>))))
        .returning(nineties.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>))
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (nineties:`Movie`) WHERE (nineties.released &gt;= 1990 AND nineties.released &lt; 2000) RETURN nineties.title</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="query"><a class="anchor" href="#query"></a>Query</h6>
<div class="paragraph">
<p>Build relationships</p>
</div>
<div class="listingblock">
<div class="title">Listing 48. List all Tom Hanks movies&#8230;&#8203;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var tom = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">tom</span><span class="delimiter">&quot;</span></span>).properties(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, literalOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tom Hanks</span><span class="delimiter">&quot;</span></span>));
var tomHanksMovies = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">tomHanksMovies</span><span class="delimiter">&quot;</span></span>);
var statement = Cypher
        .match(tom.relationshipTo(tomHanksMovies, <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>))
        .returning(tom, tomHanksMovies)
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (tom:`Person` {name: 'Tom Hanks'})-[:`ACTED_IN`]-&gt;(tomHanksMovies) RETURN tom, tomHanksMovies</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 49. Who directed "Cloud Atlas"?</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var cloudAtlas = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">cloudAtlas</span><span class="delimiter">&quot;</span></span>).properties(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, literalOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cloud Atlas</span><span class="delimiter">&quot;</span></span>));
var directors = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">directors</span><span class="delimiter">&quot;</span></span>);
statement = Cypher
        .match(cloudAtlas.relationshipFrom(directors, <span class="string"><span class="delimiter">&quot;</span><span class="content">DIRECTED</span><span class="delimiter">&quot;</span></span>))
        .returning(directors.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>))
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (cloudAtlas {title: 'Cloud Atlas'})&lt;-[:`DIRECTED`]-(directors) RETURN directors.name</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 50. Tom Hanks' co-actors&#8230;&#8203;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tom = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">tom</span><span class="delimiter">&quot;</span></span>).properties(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, literalOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tom Hanks</span><span class="delimiter">&quot;</span></span>));
var movie = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">m</span><span class="delimiter">&quot;</span></span>);
var coActors = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">coActors</span><span class="delimiter">&quot;</span></span>);
var people = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">people</span><span class="delimiter">&quot;</span></span>);
statement = Cypher
        .match(tom.relationshipTo(movie, <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>).relationshipFrom(coActors, <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>))
        .returning(coActors.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>))
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (tom:`Person` {name: 'Tom Hanks'})-[:`ACTED_IN`]-&gt;(m)&lt;-[:`ACTED_IN`]-(coActors) RETURN coActors.name</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 51. How people are related to "Cloud Atlas"&#8230;&#8203;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cloudAtlas = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>).properties(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, literalOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cloud Atlas</span><span class="delimiter">&quot;</span></span>));
people = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">people</span><span class="delimiter">&quot;</span></span>);
var relatedTo = people.relationshipBetween(cloudAtlas).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">relatedTo</span><span class="delimiter">&quot;</span></span>);
statement = Cypher
        .match(relatedTo)
        .returning(people.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>), type(relatedTo), relatedTo.getRequiredSymbolicName())
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (people:`Person`)-[relatedTo]-(:`Movie` {title: 'Cloud Atlas'}) RETURN people.name, type(relatedTo), relatedTo</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="solve"><a class="anchor" href="#solve"></a>Solve</h6>
<div class="listingblock">
<div class="title">Listing 52. Movies and actors up to 4 "hops" away from Kevin Bacon</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var bacon = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">bacon</span><span class="delimiter">&quot;</span></span>).properties(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, literalOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Kevin Bacon</span><span class="delimiter">&quot;</span></span>));
var hollywood = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">hollywood</span><span class="delimiter">&quot;</span></span>);
var statement = Cypher
        .match(bacon.relationshipBetween(hollywood).length(<span class="integer">1</span>, <span class="integer">4</span>))
        .returningDistinct(hollywood)
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (bacon:`Person` {name: 'Kevin Bacon'})-[*1..4]-(hollywood) RETURN DISTINCT hollywood</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="recommend"><a class="anchor" href="#recommend"></a>Recommend</h6>
<div class="listingblock">
<div class="title">Listing 53. Extend Tom Hanks co-actors, to find co-co-actors who haven&#8217;t worked with Tom Hanks&#8230;&#8203;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var tom = node(<span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>).named(<span class="string"><span class="delimiter">&quot;</span><span class="content">tom</span><span class="delimiter">&quot;</span></span>).properties(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, literalOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tom Hanks</span><span class="delimiter">&quot;</span></span>));
var coActors = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">coActors</span><span class="delimiter">&quot;</span></span>);
var cocoActors = anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">cocoActors</span><span class="delimiter">&quot;</span></span>);
var strength = count(asterisk()).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">Strength</span><span class="delimiter">&quot;</span></span>);
var statement = Cypher
        .match(
                tom.relationshipTo(anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">m</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>).relationshipFrom(coActors, <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>),
                coActors.relationshipTo(anyNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">m2</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>).relationshipFrom(cocoActors, <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>)
        )
        .where(not(tom.relationshipTo(anyNode(), <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>).relationshipFrom(cocoActors, <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>)))
        .and(tom.isNotEqualTo(cocoActors))
        .returning(
                cocoActors.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).as(<span class="string"><span class="delimiter">&quot;</span><span class="content">Recommended</span><span class="delimiter">&quot;</span></span>),
                strength
        ).orderBy(strength.asName().descending())
        .build();

assertThat(cypherRenderer.render(statement))
        .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH </span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">(tom:`Person` {name: 'Tom Hanks'})-[:`ACTED_IN`]-&gt;(m)&lt;-[:`ACTED_IN`]-(coActors), </span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">(coActors)-[:`ACTED_IN`]-&gt;(m2)&lt;-[:`ACTED_IN`]-(cocoActors) </span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">WHERE (NOT (tom)-[:`ACTED_IN`]-&gt;()&lt;-[:`ACTED_IN`]-(cocoActors) AND tom &lt;&gt; cocoActors) </span><span class="delimiter">&quot;</span></span>
                + <span class="string"><span class="delimiter">&quot;</span><span class="content">RETURN cocoActors.name AS Recommended, count(*) AS Strength ORDER BY Strength DESC</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query-creation"><a class="anchor" href="#query-creation"></a>Query creation</h3>
<div class="paragraph">
<p>This chapter is about the technical creation of queries when using SDN/RX&#8217;s abstraction layers.
There will be some simplifications because we do not discuss every possible case but stick with the general idea behind it.</p>
</div>
<div class="sect3">
<h4 id="save"><a class="anchor" href="#save"></a>Save</h4>
<div class="paragraph">
<p>Beside the <code>find/load</code> operations the <code>save</code> operation is one of the most used when working with data.
A save operation call in general issues multiple statements against the database to ensure that the resulting graph model matches the given Java model.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A union statement will get created that either creates a node, if the node&#8217;s identifier cannot be found, or updates the node&#8217;s property if the node itself exists.</p>
<div class="paragraph">
<p>(<code>OPTIONAL MATCH (hlp:Person) WHERE id(hlp) = $__id__ WITH hlp WHERE hlp IS NULL CREATE (n:Person) SET n = $__properties__ RETURN id(n) UNION MATCH (n) WHERE id(n) = $__id__ SET n = $__properties__ RETURN id(n)</code>)</p>
</div>
</li>
<li>
<p>If the entity is <strong>not</strong> new all relationships of the first found type at the domain model will get removed from the database.</p>
<div class="paragraph">
<p>(<code>MATCH (startNode)-[rel:Has]&#8594;(:Hobby) WHERE id(startNode) = $fromId DELETE rel</code>)</p>
</div>
</li>
<li>
<p>The related entity will get created in the same way as the root entity.</p>
<div class="paragraph">
<p>(<code>OPTIONAL MATCH (hlp:Hobby) WHERE id(hlp) = $__id__ WITH hlp WHERE hlp IS NULL CREATE (n:Hobby) SET n = $__properties__ RETURN id(n) UNION MATCH (n) WHERE id(n) = $__id__ SET n = $__properties__ RETURN id(n)</code>)</p>
</div>
</li>
<li>
<p>The relationship itself will get created</p>
<div class="paragraph">
<p>(<code>MATCH (startNode) WHERE id(startNode) = $fromId MATCH (endNode) WHERE id(endNode) = 631 MERGE (startNode)-[:Has]&#8594;(endNode)</code>)</p>
</div>
</li>
<li>
<p>If the related entity also has relationships to other entities, the same procedure as in 2. will get started.</p>
</li>
<li>
<p>For the next defined relationship on the root entity start with 2. but replace <em>first</em> with <em>next</em>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As you can see SDN/RX does its best to keep your graph model in sync with the Java world.
      This is one of the reasons why we really advise you to not load, manipulate and save sub-graphs
      as this might cause relationships to get removed from the database.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="multipleentities"><a class="anchor" href="#multipleentities"></a>Multiple entities</h5>
<div class="paragraph">
<p>The <code>save</code> operation is overloaded with the functionality for accepting multiple entities of the same type.
If you are working with generated id values or make use of optimistic locking, every entity will result in a separate <code>CREATE</code> call.</p>
</div>
<div class="paragraph">
<p>In other cases SDN/RX will create a parameter list with the entity information and provide it with a <code>MERGE</code> call.</p>
</div>
<div class="paragraph">
<p><code>UNWIND $__entities__ AS entity MERGE (n:Person {customId: entity.$__id__}) SET n = entity.__properties__ RETURN collect(n.customId) AS $__ids__</code></p>
</div>
<div class="paragraph">
<p>and the parameters look like</p>
</div>
<div class="paragraph">
<p><code>:params {__entities__: [{__id__: 'aa', __properties__: {name: "PersonName", theId: "aa"}}, {__id__ 'bb', __properties__: {name: "AnotherPersonName", theId: "bb"}}]}</code></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="load"><a class="anchor" href="#load"></a>Load</h4>
<div class="paragraph">
<p>The <code>load</code> documentation will not only show you how the <em>MATCH</em> part of the query looks like but also how the data gets returned.</p>
</div>
<div class="paragraph">
<p>The simplest kind of load operation is a <code>findById</code> call.
It will match all nodes with the label of the type you queried for and does a filter on the id value.</p>
</div>
<div class="paragraph">
<p><code>MATCH (n:Person) WHERE id(n) = 1364</code></p>
</div>
<div class="paragraph">
<p>If there is a custom id provided SDN/RX will use the property you have defined as the id.</p>
</div>
<div class="paragraph">
<p><code>MATCH (n:Person) WHERE n.customId = 'anId'</code></p>
</div>
<div class="paragraph">
<p>The data to return is defined as a <a href="https://neo4j.com/docs/cypher-manual/current/syntax/maps/#cypher-map-projection">map projection</a>.</p>
</div>
<div class="paragraph">
<p><code>RETURN n{.first_name, .personNumber, __internalNeo4jId__: id(n), __nodeLabels__: labels(n)}</code></p>
</div>
<div class="paragraph">
<p>As you can see there are two special fields in there: The <code>__internalNeo4jId__</code> and the <code>__nodeLabels__</code>.
Both are critical when it comes to mapping the data to Java objects.
The value of the <code>__internalNeo4jId__</code> is either <code>id(n)</code> or the provided custom id but in the mapping process one known field to refer to has to exist.
The <code>__nodeLabels__</code> ensures that all defined labels on this node can be found and mapped.
This is needed for situations when inheritance is used and you query not for the concrete classes or have relationships defined that only define a super-type.</p>
</div>
<div class="paragraph">
<p>Talking about relationships: If you have defined relationships in your entity, they will get added to the returned map as <a href="https://neo4j.com/docs/cypher-manual/4.0/syntax/lists/#cypher-pattern-comprehension">pattern comprehensions</a>.
The above return part will then look like:</p>
</div>
<div class="paragraph">
<p><code>RETURN n{.first_name, &#8230;&#8203;, Person_Has_Hobby: [(n)-[:Has]&#8594;(n_hobbies:Hobby)|n_hobbies{__internalNeo4jId__: id(n_hobbies), .name, <em>nodeLabels</em>: labels(n_hobbies)}]}</code></p>
</div>
<div class="paragraph">
<p>The map projection and pattern comprehension used by SDN/RX ensures that only the properties and relationships you have defined are getting queried.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Migrating"><a class="anchor" href="#Migrating"></a>Migrating from SDN+OGM to SDN/RX</h3>
<div class="sect3">
<h4 id="knownissueswithpastsdnogmmigrations"><a class="anchor" href="#knownissueswithpastsdnogmmigrations"></a>Known issues with past SDN+OGM migrations</h4>
<div class="paragraph">
<p>SDN+OGM has had quite a history over the years and we understand that migrating big application systems is neither fun nor something that provides immediate profit.
The main issues we observed when migrating from older versions of Spring Data Neo4j to newer ones are roughly in order the following:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Having skipped more than one major upgrade</dt>
<dd>
<p>While Neo4j-OGM can be used stand-alone, Spring Data Neo4j cannot.
It depends to large extend on the Spring Data and therefore, on the Spring Framework itself, which eventually affects large parts of your application.
Depending on how the application has been structured, that is, how much the any of the framework part leaked into your business code, the more you have to adapt your application.
It get&#8217;s worse when you have more than one Spring Data module in your application, if you accessed a relational database in the same service layer as your graph database.
Updating two object mapping frameworks is not fun.</p>
</dd>
<dt class="hdlist1">Relying on a embedded database configured through Spring Data itself</dt>
<dd>
<p>The embedded database in a SDN+OGM project is configured by Neo4j-OGM.
Say you want to upgrade from Neo4j 3.0 to 3.5, you can&#8217;t without upgrading your whole application.
Why is that?
As you chose to embed a database into your application, you tied yourself into the modules that configure this embedded database.
To have another, embedded database version, you have to upgrade the module that configured it, because the old one does not support the new database.
As there is always a Spring Data version corresponding to Neo4j-OGM, you would have to upgrade that as well.
Spring Data however depends on Spring Framework and than the arguments from the first bullet apply.</p>
</dd>
<dt class="hdlist1">Being unsure about which building blocks to include</dt>
<dd>
<p>It&#8217;s not easy to get the terms right.
We wrote the building blocks of an SDN+OGM setting <a href="https://michael-simons.github.io/neo4j-sdn-ogm-tips/what_are_the_building_blocks_of_sdn_and_ogm.html">here</a>.
It may be so that all of them have been added by coincidence and you&#8217;re dealing with a lof of conflicting dependencies.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Backed by those observations, we recommend to make sure you&#8217;re using only the Bolt or http transport in your current application before switching from SDN+OGM to SDN/RX.
Thus, your application and the access layer of your application is to large extend independent from the databases version.
From that state, consider moving from SDN+OGM to SDN/RX.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="preparethemigrationfromsdnogmlovelaceorsdnogmmooretosdnrx"><a class="anchor" href="#preparethemigrationfromsdnogmlovelaceorsdnogmmooretosdnrx"></a>Prepare the migration from SDN+OGM Lovelace or SDN+OGM Moore to SDN/RX</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <em>Lovelace</em> release train corresponds to SDN 5.1.x and OGM 3.1.x, while the <em>Moore</em> is SDN 5.2.x and OGM 3.2.x.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First, you must make sure that your application runs against Neo4j in server mode over the Bolt protocol, which means work in two of three cases:</p>
</div>
<div class="sect4">
<h5 id="youreonembedded"><a class="anchor" href="#youreonembedded"></a>You&#8217;re on embedded</h5>
<div class="paragraph">
<p>You have added <code>org.neo4j:neo4j-ogm-embedded-driver</code> and <code>org.neo4j:neo4j</code> to you project and starting the database via OGM facilities.
This is no longer supported and you have to setup a standard Neo4j server (both standalone and cluster are supported).</p>
</div>
<div class="paragraph">
<p>The above dependencies have to be removed.</p>
</div>
<div class="paragraph">
<p>Migrating from the embedded solution is probably the toughest migration, as you need to setup a server, too.
It is however the one that gives you much value in itself:
In the future, you will be able to upgrade the database itself without having to consider your application framework,
and your data access framework as well.</p>
</div>
</div>
<div class="sect4">
<h5 id="youreusingthehttptransport"><a class="anchor" href="#youreusingthehttptransport"></a>You&#8217;re using the HTTP transport</h5>
<div class="paragraph">
<p>You have added <code>org.neo4j:neo4j-ogm-http-driver</code> and configured an url like <code><a href="http://user:password@localhost:7474" class="bare">http://user:password@localhost:7474</a></code>.
The dependency has to be replaced with <code>org.neo4j:neo4j-ogm-bolt-driver</code> and you need to configure a Bolt url
like <code>bolt://localhost:7687</code> or use the new <code>neo4j://</code> scheme, which takes care of routing, too.</p>
</div>
</div>
<div class="sect4">
<h5 id="yourealreadyusingboltindirectly"><a class="anchor" href="#yourealreadyusingboltindirectly"></a>You&#8217;re already using Bolt indirectly</h5>
<div class="paragraph">
<p>A default SDN+OGM project uses <code>org.neo4j:neo4j-ogm-bolt-driver</code> and thus indirectly, the pure Java Driver.
You can keep your existing URL.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrating"><a class="anchor" href="#migrating"></a>Migrating</h4>
<div class="paragraph">
<p>Once you have made sure, that your SDN+OGM application works over Bolt as expected, you can start migrating to SDN/RX.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove all <code>org.neo4j:neo4j-ogm-*</code> dependencies</p>
</li>
<li>
<p>Remove <code>org.springframework.data:spring-data-neo4j</code></p>
</li>
<li>
<p>Configuring SDN/RX through a <code>org.neo4j.ogm.config.Configuration</code> bean is not supported, instead of, all configuration of the driver goes through <a href="https://github.com/neo4j/neo4j-java-driver-spring-boot-starter">our new starter</a>.
Any of <a href="https://github.com/neo4j/neo4j-java-driver-spring-boot-starter/blob/master/docs/configuration-options.adoc">those properties</a> can be configured through standard Spring Boot means.
You will especially have to adapt the properties for the url and authentication, see <a href="#migrating-auth">Listing 54</a></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You cannot configure SDN/RX through XML.
     In case you did this with your SDN+OGM application, make sure you learn about annotation-driven or functional configuration of Spring Applications.
     The easiest choice these days is Spring Boot.
     With our starter in place, all the necessary bits apart from the connection URL and the authentication is already configured for you.
</td>
</tr>
</table>
</div>
<div id="migrating-auth" class="listingblock">
<div class="title">Listing 54. Old and new properties compared</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Old
spring.data.neo4j.embedded.enabled=false # No longer support
spring.data.neo4j.uri=bolt://localhost:7687
spring.data.neo4j.username=neo4j
spring.data.neo4j.password=secret

# New
org.neo4j.driver.uri=bolt://localhost:7687
org.neo4j.driver.authentication.username=neo4j
org.neo4j.driver.authentication.password=secret</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Those new properties might change in the future again when SDN/RX and the driver will eventually replace the old setup fully.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And finally, add the new dependency, see <a href="#getting-started">Chapter 4</a> for both Gradle and Maven.</p>
</div>
<div class="paragraph">
<p>You&#8217;re than ready to replace annotations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Old</th>
<th class="tableblock halign-left valign-top">New</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.ogm.annotation.NodeEntity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.core.schema.Node</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.ogm.annotation.GeneratedValue</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.core.schema.GeneratedValue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.ogm.annotation.Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.core.schema.Id</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.ogm.annotation.Property</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.core.schema.Property</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.ogm.annotation.Relationship</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.neo4j.springframework.data.core.schema.Relationship</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.data.neo4j.annotation.EnableBookmarkManagement</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No replacement, not needed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.data.neo4j.annotation.UseBookmark</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No replacement, not needed</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Several Neo4j-OGM annotations have not yet a corresponding annotation in SDN/RX, some will never have.
      We will add to the list above as we support additional features.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="bookmarkmanagement"><a class="anchor" href="#bookmarkmanagement"></a>Bookmarkmanagement</h5>
<div class="paragraph">
<p>Both <code>@EnableBookmarkManagement</code> and <code>@UseBookmark</code> as well as the <code>org.springframework.data.neo4j.bookmark.BookmarkManager</code>
interface and it&#8217;s only implementation <code>org.springframework.data.neo4j.bookmark.CaffeineBookmarkManager</code> are gone and are
not needed anymore.</p>
</div>
<div class="paragraph">
<p>SDN/RX uses Bookmarks for all transactions, without configuration.
You can remove the bean declaration of <code>CaffeineBookmarkManager</code> as well as the the dependency to <code>com.github.ben-manes.caffeine:caffeine</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="building-sdn-rx"><a class="anchor" href="#building-sdn-rx"></a>Building SDN/RX</h3>
<div class="sect3">
<h4 id="requirements"><a class="anchor" href="#requirements"></a>Requirements</h4>
<div class="ulist">
<ul>
<li>
<p>JDK 13+ (Can be <a href="https://openjdk.java.net">OpenJDK</a> or <a href="https://www.oracle.com/technetwork/java/index.html">Oracle JDK</a>)</p>
</li>
<li>
<p>Maven 3.6.2 (We provide the Maven wrapper, see <code>mvnw</code> respectively <code>mvnw.cmd</code> in the project root; the wrapper downloads the appropriate Maven version automatically)</p>
</li>
<li>
<p>A Neo4j 3.5.+ database, either</p>
<div class="ulist">
<ul>
<li>
<p>running locally</p>
</li>
<li>
<p>or indirectly via <a href="https://www.testcontainers.org">Testcontainers</a> and <a href="https://www.docker.com">Docker</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="aboutthejdkversion"><a class="anchor" href="#aboutthejdkversion"></a>About the JDK version</h5>
<div class="paragraph">
<p>SDN/RX itself targets JDK 8 release but builds currently on JDK13.
We will track the current release cadence of Java.
Choosing JDK 8 is a decision influenced by various aspects</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SDN/RX is a Spring Data project.
Spring Data commons baseline is still JDK 8 and so is Spring Frameworks baseline.
Thus it is only natural to keep the JDK 8 baseline.</p>
</li>
<li>
<p>While there is an increase of projects started with JDK 11 (which is Oracles current LTS release of Java),
many existing projects are still on JDK 8.
We don&#8217;t want to lose them as users right from the start.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All examples (<code>/examples</code>) and also benchmarking (<code>/benchmarks</code>) will be compiled and run with the latest Java release, though.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runningthebuild"><a class="anchor" href="#runningthebuild"></a>Running the build</h4>
<div class="paragraph">
<p>The following sections are alternatives and roughly sorted by increased effort.</p>
</div>
<div class="paragraph">
<p>All builds require a local copy of the the project:</p>
</div>
<div id="checkout-sdn-rx" class="listingblock">
<div class="title">Listing 55. Clone SDN/RX</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ git clone git@github.com:neo4j/sdn-rx.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before you proceed, verify your locally installed JDK version.
The output should be similar:</p>
</div>
<div id="verify-jdk" class="listingblock">
<div class="title">Listing 56. Verify your JDK</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java -version
java version &quot;12.0.1&quot; 2019-04-16
Java(TM) SE Runtime Environment (build 12.0.1+12)
Java HotSpot(TM) 64-Bit Server VM (build 12.0.1+12, mixed mode, sharing)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="withdockerinstalled"><a class="anchor" href="#withdockerinstalled"></a>With Docker installed</h5>
<div class="sect5">
<h6 id="usingthedefaultimage"><a class="anchor" href="#usingthedefaultimage"></a>Using the default image</h6>
<div class="paragraph">
<p>If you don&#8217;t have <a href="https://en.wikipedia.org/wiki/Docker_(software)">Docker</a> installed, head over to <a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>.
In short, Docker is a tool that helps you running lightweight software images using OS-level virtualization in so called containers.</p>
</div>
<div class="paragraph">
<p>Our build uses <a href="https://www.testcontainers.org/modules/databases/neo4j/">Testcontainers Neo4j</a> to bring up a database instance.</p>
</div>
<div id="build-default-bash" class="listingblock">
<div class="title">Listing 57. Build with default settings on Linux / macOS</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ ./mvnw clean verify
[INFO] Scanning for projects...
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Build Order:
[INFO]
[INFO] Spring Data Neo4j RX                                               [pom]
[INFO] SDN⚡RX                                                            [jar]
[INFO] SDN⚡RX Spring Boot Starter Parent                                 [pom]
[INFO] SDN⚡RX Spring Boot Starter Autoconfiguration                      [jar]
[INFO] SDN⚡RX Spring Boot Starter                                        [jar]
[INFO] SDN⚡RX Examples for Spring Boot                                   [jar]
[INFO] SDN⚡RX Examples Mapping                                           [jar]
...
[INFO] Reactor Summary:
[INFO]
[INFO] Spring Data Neo4j RX 1.0.0-SNAPSHOT ................ SUCCESS [  5.937 s]
[INFO] SDN⚡RX 1.0.0-SNAPSHOT ............................. SUCCESS [09:37 min]
[INFO] SDN⚡RX Spring Boot Starter Parent 1.0.0-SNAPSHOT .. SUCCESS [  1.734 s]
[INFO] SDN⚡RX Spring Boot Starter Autoconfiguration 1.0.0-SNAPSHOT SUCCESS [ 57.069 s]
[INFO] SDN⚡RX Spring Boot Starter 1.0.0-SNAPSHOT ......... SUCCESS [  0.444 s]
[INFO] SDN⚡RX Examples for Spring Boot 999-SNAPSHOT ...... SUCCESS [  4.055 s]
[INFO] SDN⚡RX Examples Mapping 999-SNAPSHOT .............. SUCCESS [  0.683 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  10:48 min
[INFO] Finished at: 2019-10-02T15:25:48+02:00
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>On a Windows machine, use</p>
</div>
<div id="build-default-windows" class="listingblock">
<div class="title">Listing 58. Build with default settings on Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvnw.cmd clean verify</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar.</p>
</div>
<div class="paragraph">
<p>At the moment, this build tests agains Neo4j 3.5, as 4.0 is not yet available on Docker Hub.
As a consequence, tests requiring a reactive capable database, are skipped, as this is a feature of Neo4j 4.0.</p>
</div>
</div>
<div class="sect5">
<h6 id="usinganotherimage"><a class="anchor" href="#usinganotherimage"></a>Using another image</h6>
<div class="paragraph">
<p>The image version to use can be configured through an environmental variable like this:</p>
</div>
<div id="build-other-image" class="listingblock">
<div class="title">Listing 59. Build using a different Neo4j Docker image</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ SDN_RX_NEO4J_VERSION=3.5.11-enterprise SDN_RX_NEO4J_ACCEPT_COMMERCIAL_EDITION=yes ./mvnw clean verify</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we are using 3.5.11 enterprise and also accept the license agreement.</p>
</div>
<div class="paragraph">
<p>Consult your operating system or shell manual on how to define environment variables if specifying them inline does not work for you.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="againstalocallyrunningdatabase"><a class="anchor" href="#againstalocallyrunningdatabase"></a>Against a locally running database</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Running against a locally running database <strong>will</strong> erase its complete content.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Building against a locally running database is faster, as it does not restart a container each time.
We do this a lot during our development.</p>
</div>
<div class="paragraph">
<p>You can get a copy of Neo4j at our <a href="https://neo4j.com/download-center/#enterprise">download center</a> free of charge.
Especially you can get <a href="https://neo4j.com/download-center/?ref=blog/#prerelease">the current prelease of Neo4j 4.0</a>, supporting all the reactive features.</p>
</div>
<div class="paragraph">
<p>Please download the version applicable to your operating system and follow the instructions to start it.
A required step is to open a browser and go to <a href="http://localhost:7474" class="bare">http://localhost:7474</a> after you started the database and
change the default password from <code>neo4j</code> to something of your liking.</p>
</div>
<div class="paragraph">
<p>After that, you can run a complete build by specifying the local <code>bolt</code> URL:</p>
</div>
<div id="build-using-locally-running-database" class="listingblock">
<div class="title">Listing 60. Build using a locally running database</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ SDN_RX_NEO4J_URL=bolt://localhost:7687 SDN_RX_NEO4J_PASSWORD=secret ./mvnw clean verify</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="summaryofenvironmentvariablescontrollingthebuild"><a class="anchor" href="#summaryofenvironmentvariablescontrollingthebuild"></a>Summary of environment variables controlling the build</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 42.8572%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SDN_RX_NEO4J_VERSION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the Neo4j docker image to use, see <a href="https://hub.docker.com/_/neo4j">Neo4j Docker Official Images</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SDN_RX_NEO4J_ACCEPT_COMMERCIAL_EDITION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some tests may require the enterprise edition of Neo4j.
 We build and test against the enterprise edition internally, but we won&#8217;t force you
 to accept the license if you don&#8217;t want to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SDN_RX_NEO4J_URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Setting this environment allows connecting to a locally running Neo4j instance.
 We use this a lot during development.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SDN_RX_NEO4J_PASSWORD</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for the <code>neo4j</code> user of the instance configured with <code>SDN_RX_NEO4J_URL</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You need to set both <code>SDN_RX_NEO4J_URL</code> and <code>SDN_RX_NEO4J_PASSWORD</code> to use a local instance.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="checkstyleandfriends"><a class="anchor" href="#checkstyleandfriends"></a>Checkstyle and friends</h4>
<div class="paragraph">
<p>There is no quality gate in place at the moment to ensure that the code/test ratio stays as is, but please consider adding tests to your contributions.</p>
</div>
<div class="paragraph">
<p>We have some rather mild checkstyle rules in place, enforcing more or less default Java formatting rules.
Your build will break on formatting errors or something like unused imports.</p>
</div>
<div class="sect4">
<h5 id="jqassistant"><a class="anchor" href="#jqassistant"></a>jQAssistant</h5>
<div class="paragraph">
<p>We also use <a href="https://jqassistant.org">jQAssistant</a>, a Neo4j-based tool, to verify some aspects of our architecture.
The rules are described with Cypher and your build will break when they are violated:</p>
</div>
</div>
<div class="sect4">
<h5 id="codingrules"><a class="anchor" href="#codingrules"></a>Coding Rules</h5>
<div class="paragraph">
<p>The following rules are checked during a build:</p>
</div>
<div id="default" class="ulist group">
<ul>
<li>
<p><a href="#api:Default">General considerations</a></p>
</li>
<li>
<p><a href="#naming:Default">[naming:Default]</a></p>
</li>
<li>
<p><a href="#structure:Default">[structure:Default]</a></p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="api"><a class="anchor" href="#api"></a>API</h6>
<div class="paragraph">
<p>Ensure that we publish our API in a sane and consistent way.</p>
</div>
<div class="sect6 group">
<h7 id="api:Default"><a class="anchor" href="#api:Default"></a>General considerations</h7>
<div class="paragraph">
<p>We use <a href="https://github.com/apiguardian-team/apiguardian">@API Guardian</a> to keep track of what we expose as public or internal API.
To keep things both clear and concise, we restrict the usage of those annotations to interfaces, classes (incl. constructors)
and annotations.</p>
</div>
<div id="api:api-guardian-usage" class="listingblock constraint">
<div class="title">Listing 61. @API Guardian annotations must not be used on fields</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">MATCH (c:Java) - [:ANNOTATED_BY] -&gt; (a) - [:OF_TYPE] -&gt; (t:Type {fqn: 'org.apiguardian.api.API'}),
      (p) - [:DECLARES] -&gt; (c)
WHERE c:Member AND NOT c:Constructor
RETURN p.fqn, c.name</code></pre>
</div>
</div>
<div class="paragraph">
<p>Public interfaces, classes or annotations are either part of internal or public API and have a status.</p>
</div>
<div id="api:api-guardian-api-concept" class="listingblock concept">
<div class="title">Listing 62. Define which Java artifacts are part of internal or public API</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">MATCH (c:Java) - [:ANNOTATED_BY] -&gt; (a) - [:OF_TYPE] -&gt; (t:Type {fqn: 'org.apiguardian.api.API'}),
      (a) - [:HAS] -&gt; ({name: 'status'}) - [:IS] -&gt; (s)
WHERE ANY (label IN labels(c) WHERE label in ['Interface', 'Class', 'Annotation'])
WITH  c, trim(split(s.signature, ' ')[1]) AS status
WITH  c, status,
      CASE status
        WHEN 'INTERNAL' THEN 'Internal'
        ELSE 'Public'
      END AS type
MERGE (a:Api {type: type, status: status})
MERGE (c) - [:IS_PART_OF] -&gt; (a)
RETURN c,a</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="internalapi"><a class="anchor" href="#internalapi"></a>Internal API</h7>
<div class="paragraph">
<p>See ADR-003.</p>
</div>
<div id="api:internal" class="listingblock constraint">
<div class="title">Listing 63. Non abstract, public classes that are only part of internal API must be final</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">MATCH (c:Class) - [:IS_PART_OF] -&gt; (:Api {type: 'Internal'})
WHERE c.visibility = 'public'
  AND coalesce(c.abstract, false) = false
  AND NOT exists(c.final)
RETURN c.name</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="namingthings"><a class="anchor" href="#namingthings"></a>Naming things</h6>
<div id="naming:Default" class="paragraph group">
<p>The following naming conventions are used throughout the project:</p>
</div>
<div id="naming:TypeNameMustBeginWithGroupId" class="listingblock constraint">
<div class="title">Listing 64. All Java types must be located in packages that start with <code>org.neo4j.springframework.data</code>.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">MATCH
  (project:Maven:Project)-[:CREATES]-&gt;(:Artifact)-[:CONTAINS]-&gt;(type:Type)
WHERE
  NOT type.fqn starts with 'org.neo4j.springframework.data'
RETURN
  project as Project, collect(type) as TypeWithWrongName</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="structuringthings"><a class="anchor" href="#structuringthings"></a>Structuring things</h6>
<div id="structure:Default" class="paragraph group">
<p>Most of the time, the package structure under <code>org.neo4j.springframework.data</code> should reflect the main building parts.</p>
</div>
<div id="structure:mapping" class="listingblock constraint">
<div class="title">Listing 65. The mapping package must not depend on any other SDN/RX packages than <code>schema</code> and <code>convert</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">MATCH (a:Main:Artifact)
OPTIONAL MATCH (a) -[:CONTAINS]-&gt; (s:Package) WHERE s.fqn in ['org.neo4j.springframework.data.core.schema', 'org.neo4j.springframework.data.core.convert']
WITH collect(s) as allowed, a
MATCH (a) -[:CONTAINS]-&gt; (p1:Package) -[:DEPENDS_ON]-&gt; (p2:Package) &lt;-[:CONTAINS]- (a)
WHERE p1.fqn = 'org.neo4j.springframework.data.core.mapping'
  AND NOT (p2 in allowed OR (p1) -[:CONTAINS]-&gt; (p2))
return p1,p2</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="accessingthejqassistantdatabase"><a class="anchor" href="#accessingthejqassistantdatabase"></a>Accessing the jQAssistant database</h6>
<div class="paragraph">
<p>jQAssistant uses Neo4j to store information about a project.
To access the database, please build the project as described above.
When the build finishes, execute the following command:</p>
</div>
<div id="start-jqassistant" class="listingblock">
<div class="title">Listing 66. Start jQAssistant</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ ./mvnw -pl org.neo4j.springframework.data:spring-data-neo4j-rx jqassistant:server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Access the standard Neo4j browser at <a href="http://localhost:7474" class="bare">http://localhost:7474</a> and a dedicated jQA-Dashboard at <a href="http://localhost:7474/jqassistant/dashboard/" class="bare">http://localhost:7474/jqassistant/dashboard/</a>.</p>
</div>
<div class="paragraph">
<p>The scanning and analyzing can be triggered individually, without going through the full verify again:</p>
</div>
<div id="scan-with-jqassistant" class="listingblock">
<div class="title">Listing 67. Manually scan and analyze the main project</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ ./mvnw -pl org.neo4j.springframework.data:spring-data-neo4j-rx jqassistant:scan@jqassistant-scan
$ ./mvnw -pl org.neo4j.springframework.data:spring-data-neo4j-rx jqassistant:analyze@jqassistant-analyze</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-04-28 07:32:11 UTC
</div>
</div>
</body>
</html>